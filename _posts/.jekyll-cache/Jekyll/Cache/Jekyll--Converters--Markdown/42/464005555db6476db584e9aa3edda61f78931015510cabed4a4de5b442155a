I"¸ù<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>â€‹	ç»è¿‡å‰é¢çš„ä¸€é¡¿æŠ˜è…¾,ç»ˆäºè¦åˆ°äº†æ‰¯å¼€é®ç¾å¸ƒçš„æ—¶å€™äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringLoadXml</span><span class="o">(){</span>
    <span class="c1">// A</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
    <span class="c1">// B</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	å‰é¢è®°å½•äº†Aè¿™ä¸ªè¿‡ç¨‹,æ•´ä¸ªè¿‡ç¨‹æ€»ç»“ä¸º:</p>

<ol>
  <li>åŠ è½½xmlæ–‡ä»¶</li>
  <li>è§£æxmlæ–‡ä»¶</li>
  <li>é€‰ç”¨åˆé€‚çš„handlerè§£ææ ‡ç­¾</li>
  <li>åˆ›å»ºbeançš„å®šä¹‰</li>
  <li>æ³¨å†Œbeanå®šä¹‰</li>
</ol>

<p>â€‹	é‚£ä¹ˆåé¢Bè¿™ä¸€æ­¥å°±æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€æ­¥.</p>

<h1 id="äºŒåˆ†æ">äºŒã€åˆ†æ</h1>

<p>â€‹	ä»<code class="language-plaintext highlighter-rouge">MyTestBean testBean = factory.getBean("myTestBean",MyTestBean.class);</code>è¿™å¥ä»£ç å¼€å§‹å§,è¿›å»çœ‹çœ‹é‡Œé¢æ˜¯å•¥å¦–é­”é¬¼æ€ª.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doGetBean</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">doGetBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="o">,</span>
			<span class="nd">@Nullable</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">typeCheckOnly</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

		<span class="c1">// æå– bean name,bean name å¯èƒ½ä¸æ˜¯å•çº¯çš„åç§°ä¹Ÿå¯èƒ½æ˜¯å·¥å‚çš„åç§°</span>
		<span class="c1">// ä¾‹å¦‚ &amp;bean å°±ä»£è¡¨ä»åç§°ä¸ºbeançš„å·¥å‚ä¸­è·å– bean</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
		<span class="nc">Object</span> <span class="n">bean</span><span class="o">;</span>

		<span class="c1">// Eagerly check singleton cache for manually registered singletons.</span>
		<span class="c1">// é€šè¿‡å•åˆ©å·¥å‚è·å– bean</span>
		<span class="nc">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning eagerly cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
							<span class="s">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// å¦‚æœä¸ºåŸå‹æ¨¡å¼,å­˜åœ¨å¾ªç¯ä¾èµ–åˆ™æŠ¥é”™</span>
			<span class="c1">// Fail if we're already creating this bean instance:</span>
			<span class="c1">// We're assumably within a circular reference.</span>
			<span class="c1">// å¦‚æœæ˜¯åŸå‹æ¨¡å¼åˆ™ä¸è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜,ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isPrototypeCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// è·å–çˆ¶beanå·¥å‚</span>
			<span class="c1">// Check if bean definition exists in this factory.</span>
			<span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
			<span class="c1">// é€šè¿‡é€’å½’çˆ¶å·¥å‚è·å–beanå¯¹è±¡</span>
			<span class="c1">// å¦‚æœæ— beanå®šä¹‰å¹¶ä¸”è¿˜è¦åŠ è½½è¿™ä¸ªbean è¯´æ˜è¿™ä¸ªbeanå·²ç»è¢«åŠ è½½è¿‡äº†</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// Not found -&gt; check parent.</span>
				<span class="nc">String</span> <span class="n">nameToLookup</span> <span class="o">=</span> <span class="n">originalBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">((</span><span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">).</span><span class="na">doGetBean</span><span class="o">(</span>
							<span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">typeCheckOnly</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Delegation to parent with explicit args.</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// No args -&gt; delegate to standard getBean method.</span>
					<span class="k">return</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="c1">//è®°å½• bean æ­£åœ¨åˆ›å»ºä¸­</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">typeCheckOnly</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">markBeanAsCreated</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="k">try</span> <span class="o">{</span>
				<span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="n">checkMergedBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

				<span class="c1">// Guarantee initialization of beans that the current bean depends on.</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="c1">//ä¾èµ–æ³¨å†Œ</span>
						<span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">//è·å–bean,å¾ªç¯è·å–ä¾èµ–</span>
							<span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"'"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' depends on missing bean '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>

				<span class="c1">// åˆ›å»ºbeanå®ä¾‹</span>
				<span class="c1">// Create bean instance.</span>
				<span class="c1">// å•åˆ©æ¨¡å¼</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
							<span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">});</span>
					<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="c1">// åŸå‹æ¨¡å¼</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isPrototype</span><span class="o">())</span> <span class="o">{</span>
					<span class="c1">// It's a prototype -&gt; create a new instance.</span>
					<span class="nc">Object</span> <span class="n">prototypeInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="c1">// å‰ç½®å¤„ç†</span>
						<span class="n">beforePrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
						<span class="c1">// åˆ›å»ºbean</span>
						<span class="n">prototypeInstance</span> <span class="o">=</span> <span class="n">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">finally</span> <span class="o">{</span>
						<span class="c1">// åç½®å¤„ç†</span>
						<span class="n">afterPrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">prototypeInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="k">else</span> <span class="o">{</span>
					<span class="c1">// å…¶ä»–ä½œç”¨åŸŸ</span>
					<span class="nc">String</span> <span class="n">scopeName</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getScope</span><span class="o">();</span>
					<span class="kd">final</span> <span class="nc">Scope</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scopes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">scopeName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">scope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"No Scope registered for scope name '"</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="nc">Object</span> <span class="n">scopedInstance</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
							<span class="c1">// å‰ç½®å¤„ç†</span>
							<span class="n">beforePrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">try</span> <span class="o">{</span>
								<span class="c1">// åˆ›å»º bean</span>
								<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">finally</span> <span class="o">{</span>
								<span class="c1">// åç½®å¤„ç†</span>
								<span class="n">afterPrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">});</span>
						<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">scopedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
								<span class="s">"Scope '"</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">"' is not active for the current thread; consider "</span> <span class="o">+</span>
								<span class="s">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="o">,</span>
								<span class="n">ex</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">cleanupAfterBeanCreationFailure</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">//ç±»å‹è½¬æ¢</span>
		<span class="c1">// Check if required type matches the type of the actual bean instance.</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">requiredType</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">bean</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="no">T</span> <span class="n">convertedBean</span> <span class="o">=</span> <span class="n">getTypeConverter</span><span class="o">().</span><span class="na">convertIfNecessary</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">convertedBean</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanNotOfRequiredTypeException</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">convertedBean</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">TypeMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Failed to convert bean '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"' to required type '"</span> <span class="o">+</span>
							<span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(</span><span class="n">requiredType</span><span class="o">)</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanNotOfRequiredTypeException</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä»£ç å¾ˆé•¿,çœ‹èµ·æ¥æ¯”è¾ƒè´¹åŠ².æ‹†åˆ†æ¥çœ‹çœ‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="c1">// æå– bean name,bean name å¯èƒ½ä¸æ˜¯å•çº¯çš„åç§°ä¹Ÿå¯èƒ½æ˜¯å·¥å‚çš„åç§°</span>
		<span class="c1">// ä¾‹å¦‚ &amp;bean å°±ä»£è¡¨ä»åç§°ä¸ºbeançš„å·¥å‚ä¸­è·å– bean</span>
<span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
		<span class="nc">Object</span> <span class="n">bean</span><span class="o">;</span>

		<span class="c1">// Eagerly check singleton cache for manually registered singletons.</span>
		<span class="c1">// é€šè¿‡å•åˆ©å·¥å‚è·å– bean</span>
		<span class="nc">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning eagerly cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
							<span class="s">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="o">}</span>

</code></pre></div></div>

<ol>
  <li>è·å–beançš„çœŸå®åç§°</li>
  <li>è·å–bean</li>
</ol>

<p>â€‹	è¿™éƒ¨åˆ†åˆ†æˆ3å¥ä»£ç </p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">String beanName = transformedBeanName(name);</code></li>
  <li><code class="language-plaintext highlighter-rouge">Object sharedInstance = getSingleton(beanName);</code></li>
  <li><code class="language-plaintext highlighter-rouge">bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);</code></li>
</ol>

<h2 id="21-transformedbeanname">2.1 transformedBeanName</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">protected</span> <span class="nc">String</span> <span class="nf">transformedBeanName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">canonicalName</span><span class="o">(</span><span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
	<span class="o">}</span>
<span class="c1">// BeanFactoryUtils</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">transformedBeanName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"'name' must not be null"</span><span class="o">);</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯ä»¥&amp; å¼€å¤´çš„åç§°</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">FACTORY_BEAN_PREFIX</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// åç§°-&gt;çœŸå®åç§° æ”¾å…¥æ¢æˆä¸­</span>
		<span class="c1">// ä¸åœçš„å¾ªç¯æˆªå–&amp;åé¢çš„éƒ¨åˆ†,ç›´åˆ°ä¸ä»¥&amp;å¼€å¤´ä¸ºæ­¢</span>
		<span class="k">return</span> <span class="n">transformedBeanNameCache</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">beanName</span> <span class="o">-&gt;</span> <span class="o">{</span>
			<span class="k">do</span> <span class="o">{</span>
				<span class="n">beanName</span> <span class="o">=</span> <span class="n">beanName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">FACTORY_BEAN_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">beanName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">FACTORY_BEAN_PREFIX</span><span class="o">));</span>
			<span class="k">return</span> <span class="n">beanName</span><span class="o">;</span>
		<span class="o">});</span>
	<span class="o">}</span>
<span class="c1">// AbstractBeanFactory</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">canonicalName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">canonicalName</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="c1">// Handle aliasing...</span>
		<span class="nc">String</span> <span class="n">resolvedName</span><span class="o">;</span>
		<span class="c1">// åˆ¤æ–­beançš„åç§°æ˜¯å¦æ˜¯åˆ«å</span>
		<span class="c1">// ä¸€ç›´å¾ªç¯ è·Ÿç€åˆ«åçš„å¼•ç”¨é“¾èµ°</span>
		<span class="c1">// ç›´åˆ°éåˆ«åä¸ºæ­¢</span>
		<span class="c1">// ä¾‹å¦‚ A-B-C-D-E-F</span>
		<span class="c1">// ä»Aæ‰¾åˆ°F</span>
		<span class="k">do</span> <span class="o">{</span>
			<span class="n">resolvedName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">canonicalName</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resolvedName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">canonicalName</span> <span class="o">=</span> <span class="n">resolvedName</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">resolvedName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">canonicalName</span><span class="o">;</span>
	<span class="o">}</span>

</code></pre></div></div>

<ol>
  <li>å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ä»¥&amp;å¼€å¤´,è¿™ä¸ªç¬¦å·ä»£è¡¨ç€å¼•ç”¨çš„æ„æ€,åœ¨c/c++é‡Œé¢ä¼°è®¡ä¼šå¾ˆç†Ÿæ‚‰.</li>
  <li>åˆ¤æ–­æ˜¯å¦æ˜¯åˆ«å</li>
  <li>è¿”å›æœ€ç»ˆç¡®å®šä¸‹æ¥çš„beanåç§°</li>
</ol>

<h2 id="22--ç¬¦å·çš„ä½œç”¨">2.2 &amp; ç¬¦å·çš„ä½œç”¨</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTestFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">MyTestBean</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">MyTestBean</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">MyTestBean</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"ISO-8859-1"</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span> <span class="n">xmlns</span><span class="o">=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	   <span class="nl">xmlns:</span><span class="n">xsi</span><span class="o">=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	   <span class="nl">xsi:</span><span class="n">schemaLocation</span><span class="o">=</span><span class="s">"http://www.springframework.org/schema/beans
                       https://www.springframework.org/schema/beans/spring-beans-3.0.xsd"</span><span class="o">&gt;</span>
	<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">"myTestBeanFactory"</span> <span class="kd">class</span><span class="err">="</span><span class="nc">com</span><span class="o">.</span><span class="na">sjr</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">bean</span><span class="o">.</span><span class="na">MyTestFactoryBean</span><span class="err">"</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSpringFactoryBean</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFactoryBean</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBeanFactory.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBeanFactory"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
		<span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean1</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"&amp;myTestBeanFactory"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean1</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>æœ€åç»“æœè¾“å‡ºä¸º:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">com.sjr.test.bean.MyTestBean</span>
<span class="err">com.sjr.test.bean.MyTestFactoryBean</span>
</code></pre></div></div>

<p>â€‹	ä»ç»“æœä¸Šæ¥åº”è¯¥ç§’æ‡‚å§,å¦‚æœä¸€<code class="language-plaintext highlighter-rouge">FactoryBean</code>å¯¹è±¡åœ¨springåˆ›å»ºçš„æ—¶å€™ä¼šåˆ¤æ–­beanåç§°,å¦‚æœbeanåç§°ä¸­ä¸å¸¦æœ‰&amp;ç¬¦å·,è¯´æ˜æ˜¯è¦è·å–<code class="language-plaintext highlighter-rouge">FactoryBean</code>æ‰€äº§ç”Ÿçš„å¯¹è±¡,å¦‚æœå¸¦æœ‰&amp;ç¬¦å·,åˆ™è¯´æ˜éœ€è¦è·å–<code class="language-plaintext highlighter-rouge">FactoryBean</code>å¯¹è±¡æœ¬èº«.</p>

<h2 id="22-getsingleton">2.2 getSingleton</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultSingletonBeanRegistry</span>
<span class="nd">@Override</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
	<span class="o">}</span>

<span class="nd">@Nullable</span>
	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowEarlyReference</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// ç¼“å­˜ä¸­æ˜¯å¦æœ‰åˆ›å»ºå¥½çš„bean</span>
		<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="c1">// ç¼“å­˜ä¸­æ— æŒ‡å®šçš„beanå¹¶ä¸”è¯¥beanæœªåœ¨åˆ›å»ºä¸­</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// åŠ é” </span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// æŒ‡å®šçš„beanæ˜¯å¦åœ¨åˆ›å»ºä¸­</span>
				<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="c1">// éåˆ›å»ºä¸­,å¹¶ä¸”å…è®¸æå‰å¼•ç”¨</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">allowEarlyReference</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// è·å–å•åˆ©å·¥å‚</span>
					<span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">singletonFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// è°ƒç”¨å·¥å‚åˆ›å»ºå¯¹è±¡</span>
						<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
						<span class="c1">// æŠŠåˆ›å»ºå¥½çš„å¯¹è±¡æ”¾å…¥åˆ°æ­£åœ¨åˆ›å»ºçš„é›†åˆä¸­å»</span>
						<span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
						<span class="c1">// ç§»é™¤å•åˆ©å·¥å‚</span>
						<span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	é€»è¾‘æ¯”è¾ƒç®€å•,è¿™é‡Œæœ‰å‡ ä¸ªmap æ¯”è¾ƒé‡è¦:</p>

<ol>
  <li>singletonObjects ç”¨äºä¿å­˜BeanNameå’Œåˆ›å»ºbeanå®ä¾‹ä¹‹é—´çš„å…³ç³» beanName-&gt;bean</li>
  <li>earlySingletonObjects ç”¨äºä¿å­˜BeanNameå’Œåˆ›å»ºbeanå®ä¾‹ä¹‹é—´çš„å…³ç³» beanName-&gt;bean,ä¸åŒç‚¹æ˜¯,å½“beanæ”¾å…¥åˆ°æ­¤é›†åˆä¸­æ—¶,åœ¨beanåˆ›å»ºçš„è¿‡ç¨‹ä¸­å°±å¯ä»¥é€š è¿‡getBeanæ–¹æ³•æ¥è·å–beançš„å¼•ç”¨,ä¸»è¦æ˜¯ç”¨äºè§£å†³å¾ªç¯ä¾èµ–é—®é¢˜.</li>
  <li>singletonFactories:ç”¨äºä¿å­˜beanNameä¸beanå·¥å‚ä¹‹é—´çš„å…³ç³»</li>
  <li>registeredSingletons:ç”¨æ¥ä¿å­˜å½“å‰æ‰€æœ‰å·²æ³¨å†Œçš„bean</li>
</ol>

<p>â€‹	å¦‚æœbeanåç§°æ˜¯å·¥å‚çš„åç§°,é‚£ä¹ˆè¿™é‡Œå·²ç»å®Œæˆäº†beançš„åˆ›å»ºäº†,ä½†ä»…ä»…æ˜¯åˆ›å»ºå®Œæˆè¿˜æ˜¯ä¸å¤Ÿ,springè¿˜è¦æ’ä¸Šä¸€è„šè¿›è¡Œç®¡ç†.</p>

<h2 id="23-getobjectforbeaninstance">2.3 getObjectForBeanInstance</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getObjectForBeanInstance</span><span class="o">(</span>
			<span class="nc">Object</span> <span class="n">beanInstance</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>

		<span class="c1">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span>
		<span class="c1">// æ£€æŸ¥beanåç§°æ˜¯å¦ç¬¦åˆbeanå·¥å‚çš„å‘½åè§„èŒƒ,å¦‚æœåç§°æ˜¯å·¥å‚çš„æ ¼å¼,åˆ™è·å–çš„beanä¸ºå·¥å‚å®ä¾‹</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">isFactoryDereference</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// ç¬¦åˆè§„èŒƒä½†æ˜¯ä¸ªnull</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">beanInstance</span> <span class="k">instanceof</span> <span class="nc">NullBean</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="c1">// ç¬¦åˆè§„èŒƒä½†ä¸æ˜¯factory,å¼‚å¸¸</span>
			<span class="k">if</span> <span class="o">(!(</span><span class="n">beanInstance</span> <span class="k">instanceof</span> <span class="nc">FactoryBean</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanIsNotAFactoryException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanInstance</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="c1">// å¦‚æœbeanå®šä¹‰ä¸ä¸ºç©º,è®¾ç½®ä¸ºtrueè¡¨æ˜æ˜¯ä¸ªå·¥å‚bean</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mbd</span><span class="o">.</span><span class="na">isFactoryBean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span>
		<span class="c1">// If it's a FactoryBean, we use it to create a bean instance, unless the</span>
		<span class="c1">// caller actually wants a reference to the factory.</span>
		<span class="c1">// å¦‚æœbeanå®ä¾‹ä¸ºéå·¥å‚,ç›´æ¥è¿”å›</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">beanInstance</span> <span class="k">instanceof</span> <span class="nc">FactoryBean</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// åé¢çš„é€»è¾‘æ˜¯beanæ˜¯å·¥å‚,è€Œåç§°åˆ™ä¸æ˜¯å·¥å‚çš„è§£å¼•ç”¨æ ¼å¼</span>
		<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mbd</span><span class="o">.</span><span class="na">isFactoryBean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// ä»ç¼“å­˜ä¸­è·å–å¯¹è±¡å¯¹åº”çš„å·¥å‚bean</span>
			<span class="n">object</span> <span class="o">=</span> <span class="n">getCachedObjectForFactoryBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Return bean instance from factory.</span>
			<span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">beanInstance</span><span class="o">;</span>
			<span class="c1">// Caches object obtained from FactoryBean if it is a singleton.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="kt">boolean</span> <span class="n">synthetic</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">());</span>
			<span class="n">object</span> <span class="o">=</span> <span class="n">getObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="o">!</span><span class="n">synthetic</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>å¦‚æœbeançš„åç§°ä»¥&amp; å¼€å¤´å¹¶ä¸”æ˜¯<code class="language-plaintext highlighter-rouge">FactoryBean</code>å­ç±»,ç›´æ¥è¿”å›å·¥å‚å¯¹è±¡</li>
  <li>å¦‚æœbeançš„åç§°éä»¥&amp;å¼€å¤´å¹¶ä¸”é<code class="language-plaintext highlighter-rouge">FactoryBean</code>å­ç±»ç›´æ¥è¿”å›å¯¹è±¡</li>
  <li>å¦‚æœbeançš„åç§°éä»¥&amp;å¼€å¤´å¹¶ä¸”æ˜¯<code class="language-plaintext highlighter-rouge">FactoryBean</code>å­ç±»è°ƒç”¨<code class="language-plaintext highlighter-rouge">FactoryBean</code>çš„getObjectæ–¹æ³•è·å–å¯¹è±¡</li>
</ol>

<p>ä»¥ä¸Šä»£ç ä¸­çš„æ ¸å¿ƒä»£ç æœ‰ä¸‰å¤„:</p>

<ol>
  <li>getCachedObjectForFactoryBean()</li>
  <li>getMergedLocalBeanDefinition()</li>
  <li>getObjectFromFactoryBean()</li>
</ol>

<h2 id="24-getcachedobjectforfactorybean">2.4 getCachedObjectForFactoryBean</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nullable</span>
	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getCachedObjectForFactoryBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä»£ç å¾ˆç®€å•,å°±æ˜¯æ ¹æ®beanNameåœ¨æ¢æˆä¸­è·å–å¯¹åº”çš„bean</p>

<h2 id="25-getmergedlocalbeandefinition">2.5 getMergedLocalBeanDefinition</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">protected</span> <span class="nc">RootBeanDefinition</span> <span class="nf">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="c1">// Quick check on the concurrent map first, with minimal locking.</span>
		<span class="c1">// ä»ç¼“å­˜ä¸­è·å–</span>
		<span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">stale</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">mbd</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
	<span class="o">}</span>
<span class="kd">protected</span> <span class="nc">RootBeanDefinition</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">bd</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

		<span class="k">return</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bd</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

<span class="kd">protected</span> <span class="nc">RootBeanDefinition</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span>
			<span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">bd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">BeanDefinition</span> <span class="n">containingBd</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// åŠ é”,å¹¶å‘æ§åˆ¶</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="nc">RootBeanDefinition</span> <span class="n">previous</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

			<span class="c1">// Check with full lock now in order to enforce the same merged instance.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">containingBd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// å¦‚æœä¸ºç©º ä»ç¼“å­˜ä¸­è·å–</span>
				<span class="n">mbd</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			
			
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mbd</span><span class="o">.</span><span class="na">stale</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">previous</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">;</span>
				<span class="c1">// åˆ¤æ–­æ˜¯å¦å…·æœ‰çˆ¶å­å…³ç³»</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getParentName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Use copy of given root bean definition.</span>
					<span class="c1">// åˆ¤æ–­ç±»å‹æ˜¯å¦æ˜¯ RootBeanDefinition</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">bd</span> <span class="k">instanceof</span> <span class="nc">RootBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// copyä¸€ä¸ª</span>
						<span class="n">mbd</span> <span class="o">=</span> <span class="o">((</span><span class="nc">RootBeanDefinition</span><span class="o">)</span> <span class="n">bd</span><span class="o">).</span><span class="na">cloneBeanDefinition</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="c1">// è½¬æ¢ä¸º RootBeanDefinition</span>
						<span class="n">mbd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">bd</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="c1">// Child bean definition: needs to be merged with parent.</span>
					<span class="nc">BeanDefinition</span> <span class="n">pbd</span><span class="o">;</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="c1">// è·å– çˆ¶bean åç§°</span>
						<span class="nc">String</span> <span class="n">parentBeanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getParentName</span><span class="o">());</span>
						<span class="c1">// åˆ¤æ–­çˆ¶ä¸å­çš„bean åç§°æ˜¯å¦ç›¸åŒ</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">))</span> <span class="o">{</span>
							<span class="c1">// å¦‚æœä¸ç›¸åŒ,åˆ™é¡ºåˆ™ çˆ¶å­å…³ç³» ä¸€è·¯é€’å½’ä¸Šå»</span>
							<span class="c1">// å…¨éƒ¨è½¬æ¢ä¸º RootBeanDefinition</span>
							<span class="n">pbd</span> <span class="o">=</span> <span class="n">getMergedBeanDefinition</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">else</span> <span class="o">{</span>
							<span class="c1">// å’Œä¸Šé¢ä»£ç é€»è¾‘ç›¸åŒ åªæ˜¯ç±»å‹ä¸ä¸€æ ·</span>
							<span class="nc">BeanFactory</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="k">instanceof</span> <span class="nc">ConfigurableBeanFactory</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">pbd</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurableBeanFactory</span><span class="o">)</span> <span class="n">parent</span><span class="o">).</span><span class="na">getMergedBeanDefinition</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">else</span> <span class="o">{</span>
								<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchBeanDefinitionException</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">,</span>
										<span class="s">"Parent name '"</span> <span class="o">+</span> <span class="n">parentBeanName</span> <span class="o">+</span> <span class="s">"' is equal to bean name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
										<span class="s">"': cannot be resolved without an AbstractBeanFactory parent"</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
								<span class="s">"Could not resolve parent bean definition '"</span> <span class="o">+</span> <span class="n">bd</span><span class="o">.</span><span class="na">getParentName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="c1">// Deep copy with overridden values.</span>
					<span class="c1">// æ·±æ‹·è´ è½¬æ¢ä¸ºRootBeanDefinition</span>
					<span class="n">mbd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">pbd</span><span class="o">);</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">overrideFrom</span><span class="o">(</span><span class="n">bd</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="c1">// Set default singleton scope, if not configured before.</span>
				<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getScope</span><span class="o">()))</span> <span class="o">{</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="no">SCOPE_SINGLETON</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="c1">// A bean contained in a non-singleton bean cannot be a singleton itself.</span>
				<span class="c1">// Let's correct this on the fly here, since this might be the result of</span>
				<span class="c1">// parent-child merging for the outer bean, in which case the original inner bean</span>
				<span class="c1">// definition will not have inherited the merged outer bean's singleton status.</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">containingBd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containingBd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">containingBd</span><span class="o">.</span><span class="na">getScope</span><span class="o">());</span>
				<span class="o">}</span>

				<span class="c1">// Cache the merged bean definition for the time being</span>
				<span class="c1">// (it might still get re-merged later on in order to pick up metadata changes)</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">containingBd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isCacheBeanMetadata</span><span class="o">())</span> <span class="o">{</span>
					<span class="c1">// åŠ å…¥ç¼“å­˜</span>
					<span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">previous</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">copyRelevantMergedBeanDefinitionCaches</span><span class="o">(</span><span class="n">previous</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">mbd</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	è¯´è¿™ä»£ç ä¹‹å‰,å…ˆè¯´è¯´springä¸­çš„åŸºæœ¬æ•°æ®ç»“æ„.åœ¨springä¸­åŸºæœ¬æ•°æ®ç»“æ„ä¸º<code class="language-plaintext highlighter-rouge">BeanDefinition</code>,é€šè¿‡springäº§ç”Ÿçš„æ™®é€šbeanä¸º<code class="language-plaintext highlighter-rouge">GenericBeanDefinition</code>.è€Œspringåç»­å¤„ç†çš„ç±»å‹åˆ™ä¸º<code class="language-plaintext highlighter-rouge">RootBeanDefinition</code>.å…³ç³»å›¾å¦‚ä¸‹:</p>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/BeanDefinition.png" alt="images" /></p>

<p>â€‹	è¿™ä¸¤ä¸ªé•¿çš„éƒ½å·®ä¸å¤š,åªä¸è¿‡åç»­å¤„ç†çš„æ­¥éª¤ç”¨åˆ°çš„ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">RootBeanDefinition</code>,æ‰€ä»¥åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­,è¿›è¡Œé€’å½’è½¬æ¢.</p>

<h2 id="26-getobjectfromfactorybean">2.6 getObjectFromFactoryBean</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kt">boolean</span> <span class="n">synthetic</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">());</span>
<span class="n">object</span> <span class="o">=</span> <span class="n">getObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="o">!</span><span class="n">synthetic</span><span class="o">);</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œè¿™ä¸ª<code class="language-plaintext highlighter-rouge">isSynthetic</code>æ–¹æ³•ä»£è¡¨æ˜¯å¦æ˜¯äººé€ çš„,emmaå°±è¿™æ ·ç†è§£å§.ä»€ä¹ˆå«åšäººé€ çš„å‘¢?æ„æ€å°±æ˜¯ä¸åŠ å¹²é¢„é€šspringäº§ç”Ÿçš„å°±æ˜¯éäººé€ çš„,å¦‚æœæ˜¯åé¢é€šè¿‡ä»£ç†äº§ç”Ÿçš„å°±æ˜¯éäººé€ çš„.</p>

<p>â€‹	çœ‹äº†ä¸€ä¸‹setSyntheticè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æƒ…å†µ,éƒ½æ˜¯åœ¨aopé‚£è¾¹è°ƒç”¨çš„æ¯”è¾ƒå¤š.ä¸çŸ¥é“è§£é‡Šçš„å¯¹ä¸å¯¹å“ˆ.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// FactoryBeanRegistrySupport</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getObjectFromFactoryBean</span><span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">shouldPostProcess</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// åˆ¤æ–­å·¥å‚æ˜¯å¦ä¸ºå•åˆ©å·¥å‚,å¹¶ä¸”å•åˆ©å¯¹è±¡å·²è¢«åˆ›å»ºå®Œæˆ</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">containsSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// åŠ é”</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="n">getSingletonMutex</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// åœ¨ç¼“å­˜ä¸­è·å–é€šè¿‡å·¥å‚åˆ›å»ºçš„bean</span>
				<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// è·å–beané€šè¿‡å·¥å‚</span>
					<span class="n">object</span> <span class="o">=</span> <span class="n">doGetObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
					<span class="c1">// Only post-process and store if not put there already during getObject() call above</span>
					<span class="c1">// (e.g. because of circular reference processing triggered by custom getBean calls)</span>
					<span class="c1">// å†æ¬¡ä»ç¼“å­˜ä¸­è·å–bean</span>
					<span class="nc">Object</span> <span class="n">alreadyThere</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">alreadyThere</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// å¦‚æœç¼“å­˜ä¸­è·å–åˆ°bean,åˆ™ä¸¢å¼ƒå½“å‰åˆ›å»ºçš„å¯¹è±¡</span>
						<span class="n">object</span> <span class="o">=</span> <span class="n">alreadyThere</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="c1">// åˆ¤æ–­æ˜¯å¦éœ€è¦post-processing</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">shouldPostProcess</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// å½“å‰çš„beanæ˜¯å¦è¢«åˆ›å»ºä¸­,å¦‚æœæ˜¯å°±ç›´æ¥è¿”å›å½“å‰çš„beanä¸åšå¤„ç†</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
								<span class="c1">// Temporarily return non-post-processed object, not storing it yet..</span>
								<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
							<span class="o">}</span>
							<span class="c1">// beanåˆ›å»ºä¹‹å‰,æŠŠå½“å‰beanåŠ å…¥æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­å»</span>
							<span class="n">beforeSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">try</span> <span class="o">{</span>
								<span class="c1">// AOPçš„æ ¸å¿ƒæ­¥éª¤</span>
								<span class="n">object</span> <span class="o">=</span> <span class="n">postProcessObjectFromFactoryBean</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
								<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
										<span class="s">"Post-processing of FactoryBean's singleton object failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">finally</span> <span class="o">{</span>
								<span class="c1">// beanåˆ›å»ºä¹‹å,æŠŠbeanä»æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ç§»é™¤</span>
								<span class="n">afterSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">}</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">containsSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
							<span class="c1">// ç¼“å­˜beanå¯¹è±¡</span>
							<span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">//åˆ›å»ºå¯¹è±¡</span>
			<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">doGetObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">shouldPostProcess</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="c1">//å¤„ç†beanæµç¨‹</span>
					<span class="n">object</span> <span class="o">=</span> <span class="n">postProcessObjectFromFactoryBean</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Post-processing of FactoryBean's object failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>åˆ¤æ–­æ˜¯å¦æ˜¯å•åˆ©å·¥å‚,å¹¶ä¸”ç¼“å­˜ä¸­å·²ç»åˆ›å»ºäº†è¯¥beançš„factoryBean</li>
  <li>åˆ¤æ–­factoryBeanObjectCacheç¼“å­˜ä¸­beanæ˜¯å¦å­˜åœ¨</li>
  <li>é€šè¿‡factoryBeanåˆ›å»ºbean</li>
</ol>

<p>â€‹	ä»¥ä¸Šé€»è¾‘ä¸ºå½“æœ‰factoryBeançš„é€»è¾‘.</p>

<h1 id="ä¸‰ååŠæ®µé€»è¾‘">ä¸‰ã€ååŠæ®µé€»è¾‘</h1>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//AbstractBeanFactory</span>
			<span class="c1">// å¦‚æœä¸ºåŸå‹æ¨¡å¼,å­˜åœ¨å¾ªç¯ä¾èµ–åˆ™æŠ¥é”™</span>
			<span class="c1">// Fail if we're already creating this bean instance:</span>
			<span class="c1">// We're assumably within a circular reference.</span>
			<span class="c1">// å¦‚æœæ˜¯åŸå‹æ¨¡å¼åˆ™ä¸è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜,ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isPrototypeCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// è·å–çˆ¶beanå·¥å‚</span>
			<span class="c1">// Check if bean definition exists in this factory.</span>
			<span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
			<span class="c1">// é€šè¿‡é€’å½’çˆ¶å·¥å‚è·å–beanå¯¹è±¡</span>
			<span class="c1">// å¦‚æœæ— beanå®šä¹‰å¹¶ä¸”è¿˜è¦åŠ è½½è¿™ä¸ªbean è¯´æ˜è¿™ä¸ªbeanå·²ç»è¢«åŠ è½½è¿‡äº†</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// Not found -&gt; check parent.</span>
				<span class="nc">String</span> <span class="n">nameToLookup</span> <span class="o">=</span> <span class="n">originalBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">((</span><span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">).</span><span class="na">doGetBean</span><span class="o">(</span>
							<span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">typeCheckOnly</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Delegation to parent with explicit args.</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// No args -&gt; delegate to standard getBean method.</span>
					<span class="k">return</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	å¦‚æœéå•åˆ©æ¨¡å¼,springåœ¨è¿™é‡Œä¸å¤„ç†å¾ªç¯ä¾èµ–é—®é¢˜.å¦‚æœ<code class="language-plaintext highlighter-rouge">BeanFactory</code>å­˜åœ¨çˆ¶å­å…³ç³»,åˆ™è¿›è¡Œé€’å½’åˆ›å»º.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="c1">// è®°å½• bean æ­£åœ¨åˆ›å»ºä¸­</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">typeCheckOnly</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">markBeanAsCreated</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
<span class="c1">// è½¬æ¢BeanDefinitionä¸ºRootBeanDefinition</span>
<span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="c1">// æ£€æŸ¥RootBeanDefinitionæ˜¯å¦åˆæ³•</span>
				<span class="n">checkMergedBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

				<span class="c1">// Guarantee initialization of beans that the current bean depends on.</span>
				<span class="c1">// éå†æ‰€æœ‰ä¾èµ–,å¹¶è¿›è¡Œæ³¨å†Œã€åˆ›å»ºç­‰è¿‡ç¨‹</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="c1">// ä¾èµ–æ³¨å†Œ</span>
						<span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">// è·å–bean,å¾ªç¯è·å–ä¾èµ–</span>
							<span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"'"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' depends on missing bean '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>

				<span class="c1">// åˆ›å»ºbeanå®ä¾‹</span>
				<span class="c1">// Create bean instance.</span>
				<span class="c1">// å•åˆ©æ¨¡å¼</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
							<span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">});</span>
					<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>			
</code></pre></div></div>

<ol>
  <li>
    <p>æ ‡è®°è¯¥beanæœªæ­£åœ¨åˆ›å»ºä¸­.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">markBeanAsCreated</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦åŒ…å«beanName</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">alreadyCreated</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// åŠ é”å¹¶å‘æ§åˆ¶</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// åŒé‡æ£€æŸ¥</span>
				<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">alreadyCreated</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="c1">// Let the bean definition get re-merged now that we're actually creating</span>
					<span class="c1">// the bean... just in case some of its metadata changed in the meantime.</span>
					<span class="n">clearMergedBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="c1">// æ·»åŠ è¿›è¡Œå·²ç»åˆ›å»ºé›†åˆä¸­</span>
					<span class="k">this</span><span class="o">.</span><span class="na">alreadyCreated</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>éå†ä¾èµ–å¹¶è¿›è¡Œé€’å½’åˆ›å»º</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="c1">//ä¾èµ–æ³¨å†Œ</span>
						<span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">//è·å–bean,å¾ªç¯è·å–ä¾èµ–</span>
							<span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"'"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' depends on missing bean '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>â€‹	è¿™é‡Œçš„æ ¸å¿ƒé€»è¾‘åœ¨äº<code class="language-plaintext highlighter-rouge">getSingleton</code>è¿™ä¸ªæ–¹æ³•é‡Œ</p>

<h3 id="31-getsingleton">3.1 getSingleton</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name must not be null"</span><span class="o">);</span>
		<span class="c1">// åŠ é”</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// ä»ç¼“å­˜ä¸­è·å– bean</span>
			<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="c1">// å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// åˆ¤æ–­å½“å‰beanæ˜¯å¦è¢«æ ‡è®°ä¸ºé”€æ¯</span>
        <span class="c1">// ç›¸å½“äºä¸èƒ½åœ¨destroryæ–¹æ³•é‡Œé¢å†å»åˆ›å»ºè¿™ä¸ªbean</span>
				<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonsCurrentlyInDestruction</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationNotAllowedException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
							<span class="s">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> <span class="o">+</span>
							<span class="s">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Creating shared instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="c1">// å¼€å§‹åˆ›å»º bean</span>
				<span class="c1">// æ·»åŠ åˆ° åˆ›å»ºä¸­é›†åˆä¸­å»</span>
				<span class="c1">// å‰ç½®å¤„ç†</span>
				<span class="n">beforeSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="kt">boolean</span> <span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
				<span class="kt">boolean</span> <span class="n">recordSuppressedExceptions</span> <span class="o">=</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
				<span class="o">}</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="c1">// ä»å·¥å‚ä¸­è·å– bean</span>
					<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
					<span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Has the singleton object implicitly appeared in the meantime -&gt;</span>
					<span class="c1">// if yes, proceed with it since the exception indicates that state.</span>
					<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">for</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">suppressedException</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">ex</span><span class="o">.</span><span class="na">addRelatedCause</span><span class="o">(</span><span class="n">suppressedException</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">finally</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="c1">// ç§»é™¤åˆ›å»ºä¸­çš„é›†åˆ</span>
					<span class="n">afterSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">newSingleton</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// æ”¾å…¥ç¼“å­˜</span>
					<span class="n">addSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>ä»ç¼“å­˜ä¸­è·å–bean</li>
  <li>å¦‚æœæ¢æˆä¸­æ²¡æœ‰,åˆ™åˆ¤æ–­å½“å‰çš„beanæ˜¯å¦è¢«è®°è¢«é”€æ¯</li>
  <li>åœ¨åˆ›å»ºä¹‹å‰æŠŠbeanNameåŠ å…¥æ­£åœ¨åˆ›å»ºçš„ç¼“å­˜ä¸­å»</li>
  <li>ä»å•åˆ©å·¥å‚ä¸­åˆ›å»ºbean</li>
  <li>ä»æ­£åœ¨åˆ›å»ºçš„æ¢æˆä¸­ç§»é™¤beanName</li>
  <li>æŠŠåˆ›å»ºå¥½çš„singletonObjectåŠ å…¥ç¼“å­˜ä¸­</li>
</ol>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">singletonFactory</code>å¯¹è±¡æ˜¯é€šè¿‡Lambdaè¡¨è¾¾ä¼ å…¥è¿›æ¥çš„</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
							<span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">});</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„æ ¸å¿ƒé€»è¾‘ä»£ç æ˜¯<code class="language-plaintext highlighter-rouge">createBean(beanName, mbd, args)</code></p>

<h3 id="32-createbean">3.2 createBean</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractAutowireCapableBeanFactory</span>
<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">createBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="nc">RootBeanDefinition</span> <span class="n">mbdToUse</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">;</span>

		<span class="c1">// Make sure bean class is actually resolved at this point, and</span>
		<span class="c1">// clone the bean definition in case of a dynamically resolved Class</span>
		<span class="c1">// which cannot be stored in the shared merged bean definition.</span>
		<span class="c1">// æ ¹æ®ç±»ååŠ è½½classå¯¹è±¡</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolvedClass</span> <span class="o">=</span> <span class="n">resolveBeanClass</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">resolvedClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">hasBeanClass</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mbdToUse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">);</span>
			<span class="n">mbdToUse</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="n">resolvedClass</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="c1">// Prepare method overrides.</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// åŒ¹é…éœ€è¦è¦†ç›–çš„æ–¹æ³•</span>
			<span class="n">mbdToUse</span><span class="o">.</span><span class="na">prepareMethodOverrides</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span>
					<span class="n">beanName</span><span class="o">,</span> <span class="s">"Validation of method overrides failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
			<span class="c1">// è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡,ä¹Ÿå¯èƒ½æ˜¯éä»£ç†å¯¹è±¡</span>
			<span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">resolveBeforeInstantiation</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
					<span class="s">"BeanPostProcessor before instantiation of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// åˆ›å»ºbean</span>
			<span class="nc">Object</span> <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">doCreateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Finished creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="o">|</span> <span class="nc">ImplicitlyAppearedSingletonException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// A previously detected exception with proper bean creation context already,</span>
			<span class="c1">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
					<span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Unexpected exception during bean creation"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>åŠ è½½class</li>
  <li>åˆ¤æ–­è¯¥beanæ˜¯å¦éœ€è¦<code class="language-plaintext highlighter-rouge">InstantiationAwareBeanPostProcessor</code>è¿›è¡Œå¤„ç†,è¿™ä¸ªæ¥å£ä¸<code class="language-plaintext highlighter-rouge">BeanPostProcessor</code>ä¸åŒ,ä¸»è¦åŒºåˆ«æ˜¯åœ¨è°ƒç”¨æ—¶æœºä¸Šçš„åŒºåˆ«,<code class="language-plaintext highlighter-rouge">InstantiationAwareBeanPostProcessor</code>ä¼šåœ¨å¯¹è±¡åˆ›å»ºå‰è¿›è¡Œè°ƒç”¨,è€Œ<code class="language-plaintext highlighter-rouge">BeanPostProcessor</code>ä¼šåœ¨å¯¹è±¡åˆå§‹åŒ–å‰åè¿›è¡Œè°ƒç”¨,è¿™ä¸ªå¯ä»¥ä»doCreateBeançœ‹å‡ºæ—¶æœºçš„å·®åˆ«.</li>
  <li>åˆ›å»ºå¯¹è±¡</li>
</ol>

<h3 id="33-docreatebean">3.3 doCreateBean</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractAutowireCapableBeanFactory</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="kd">final</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

		<span class="c1">// Instantiate the bean.</span>
		<span class="nc">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// ä»ç¼“å­˜ä¸­è·å–å®ä¾‹wrapper,å¹¶ç§»é™¤å®ƒ</span>
			<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// å¦‚æœæ²¡æœ‰è·å–åˆ°å®ä¾‹çš„wrapper,åˆ™åˆ›å»ºä¸€ä¸ªå®ä¾‹</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">();</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedClass</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">!=</span> <span class="nc">NullBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mbd</span><span class="o">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// Allow post-processors to modify the merged bean definition.</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æœ‰ åç½®å¤„ç†å™¨</span>
		<span class="c1">// åŠ é”</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessingLock</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
							<span class="s">"Post-processing of merged bean definition failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨</span>
		<span class="c1">// Eagerly cache singletons to be able to resolve circular references</span>
		<span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
		<span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
				<span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Eagerly caching bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
						<span class="s">"' to allow for resolving potential circular references"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">addSingletonFactory</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getEarlyBeanReference</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bean</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="c1">// Initialize the bean instance.</span>
		<span class="nc">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// å¡«å……beanå±æ€§</span>
			<span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
			<span class="c1">// åˆå§‹åŒ–bean</span>
			<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="nc">BeanCreationException</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="nc">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">).</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="o">(</span><span class="nc">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
						<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Initialization of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// å¾ªç¯ä¾èµ–å¤„ç†</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// è·å–å•åˆ©å¯¹è±¡</span>
			<span class="nc">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="nc">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">dependentBeans</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dependentBean</span> <span class="o">:</span> <span class="n">dependentBeans</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
								<span class="s">"Bean with name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' has been injected into other beans ["</span> <span class="o">+</span>
								<span class="nc">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">actualDependentBeans</span><span class="o">)</span> <span class="o">+</span>
								<span class="s">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="o">+</span>
								<span class="s">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="o">+</span>
								<span class="s">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="o">+</span>
								<span class="s">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// Register bean as disposable.</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// æ³¨å†Œé”€æ¯å¤„ç†å™¨</span>
			<span class="n">registerDisposableBeanIfNecessary</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invalid destruction signature"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿›è¿‡ä»¥ä¸Šéªšæ“ä½œå°±å®Œæˆäº†beançš„åˆ›å»º,åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­è¿˜ä¼šæœ‰å±æ€§çš„å¡«å……,beançš„åˆå§‹åŒ–ç­‰.</p>

<h1 id="å››å°ç»“">å››ã€å°ç»“</h1>

<p>â€‹	ç»§ç»­beançš„åˆå§‹åŒ–,ä¸å±æ€§çš„å¡«å…….</p>
:ET