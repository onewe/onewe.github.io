I"l¸<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>æœ€è¿‘åœ¨é¡¹ç›®é‡åˆ°ä¸€ä¸ªBufferedInputStreamå’ŒInputStreamæ··ç”¨çš„é—®é¢˜,å¯¼è‡´InputStreamé˜»å¡çº¿ç¨‹,äºæ˜¯ä¸ºäº†è§£å†³é—®é¢˜,æ‰“ç®—å‰¥å¼€BufferedInputStreamçš„bufferè§‚å¯Ÿå†…åœ¨çš„æœ¬è´¨,å‡­å•¥éƒ½è¯´BufferedInputStreamæ¯”InputStreamå¿«?</p>

<h1 id="äºŒäº‹æ•…çº¿ç¨‹">äºŒã€äº‹æ•…çº¿ç¨‹</h1>

<p>äº‹æ•…æ˜¯å‘ç”Ÿåœ¨,æŠ„è¢­çš„jschä¸‹è½½æ–‡ä»¶çš„demoé‡Œ,ä¸ºäº†å·æ‡’å¼€å‘äººå‘˜ç›´æ¥æŠŠdemoé‡Œé¢çš„ä»£ç æ‰’äº†ä¸‹äº†,ä¸è¿‡å¥½åœ¨ä¸€ç‚¹æ˜¯å¼€å‘äººå‘˜è§‰å¾—InputStreamæ¯”è¾ƒæ…¢,æ¢æˆäº†BufferedInputStream.è¿™ç‚¹è¿˜æ˜¯æ¯”è¾ƒå¥½çš„,è‡³å°‘æœ‰ç‚¹ç‚¹å¸¸è¯†.ä»¥ä¸‹ä¸ºéƒ¨åˆ†ä»£ç .</p>

<ul>
  <li>è¯»å–æ–‡ä»¶ä»£ç </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   			<span class="nc">ChannelExec</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">OutputStream</span> <span class="n">outputStream</span><span class="o">;</span>
        <span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">;</span>
        <span class="nc">BufferedOutputStream</span> <span class="n">bufferedOutputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">BufferedInputStream</span> <span class="n">bufferedInputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">BufferedOutputStream</span> <span class="n">bufferedFileOutputStream</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ChannelExec</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">openChannel</span><span class="o">(</span><span class="s">"exec"</span><span class="o">);</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">setCommand</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
            <span class="n">inputStream</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="n">channel</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="mi">4000</span><span class="o">);</span>
          	<span class="c1">//buffer æ•°ç»„</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">];</span>
            <span class="n">bufferedOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="n">outputStream</span><span class="o">);</span>
            <span class="n">buf</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">bufferedOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">bufferedOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="n">bufferedInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
              	<span class="c1">//æ£€æŸ¥æ•°æ®æµ</span>
                <span class="nc">CommandStatus</span> <span class="n">commandStatus</span> <span class="o">=</span> <span class="n">checkAck</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">commandStatus</span><span class="o">.</span><span class="na">code</span> <span class="o">!=</span> <span class="sc">'C'</span><span class="o">){</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">bufferedInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">5</span><span class="o">);</span>

                <span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">foo</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">fileSize</span><span class="o">){</span>
                        <span class="n">foo</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
                    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                        <span class="n">foo</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">fileSize</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="n">foo</span> <span class="o">=</span> <span class="n">bufferedInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">foo</span><span class="o">);</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="n">foo</span><span class="o">;</span>
                    <span class="n">message</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">messageStrFormat</span><span class="o">,</span> <span class="o">(</span><span class="n">count</span> <span class="o">/</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span> <span class="n">finalFileSzie</span><span class="o">)</span> <span class="o">*</span> <span class="mi">100</span><span class="o">,</span><span class="n">count</span><span class="o">,</span><span class="n">finalFileSzie</span><span class="o">));</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">foo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">bufferedFileOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">foo</span><span class="o">);</span>
                    <span class="n">bufferedFileOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                    <span class="n">fileSize</span> <span class="o">-=</span><span class="n">foo</span><span class="o">;</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">fileSize</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">){</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
              <span class="c1">//æ£€æŸ¥æ•°æ®æµ</span>
                <span class="n">commandStatus</span> <span class="o">=</span> <span class="n">checkAck</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">commandStatus</span><span class="o">.</span><span class="na">isOk</span><span class="o">){</span>
                    <span class="n">message</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">commandStatus</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">buf</span><span class="o">[</span><span class="mi">0</span><span class="o">]=</span><span class="mi">0</span><span class="o">;</span>
                <span class="n">bufferedOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
                <span class="n">bufferedOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æ£€æŸ¥æµä»£ç </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CommandStatus</span> <span class="nf">checkAck</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">input</span><span class="o">){</span>
        <span class="nc">CommandStatus</span> <span class="n">commandStatus</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommandStatus</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
            <span class="n">commandStatus</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                <span class="n">commandStatus</span><span class="o">.</span><span class="na">setOk</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">commandStatus</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">2</span><span class="o">){</span>
                <span class="n">commandStatus</span><span class="o">.</span><span class="na">setOk</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">input</span><span class="o">)));</span>
                <span class="n">reader</span><span class="o">.</span><span class="na">lines</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">));</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="n">commandStatus</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">commandStatus</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="n">commandStatus</span><span class="o">.</span><span class="na">setOk</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">commandStatus</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>äº‹æ•…å‘ç”Ÿåœ¨è¯»å–æ–‡ä»¶ä»£ç ä¸­çš„,ç¬¬äºŒæ¬¡æ£€æŸ¥æµçš„æ—¶å€™å‡ºç°äº†çº¿ç¨‹é˜»å¡.</p>

<ol>
  <li>
    <p>ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿé˜»å¡?</p>

    <p>ä¸€èˆ¬æ¥è¯´å‘ç”Ÿé˜»å¡ä¼šæœ‰ä¸¤ç§æƒ…å†µ:</p>

    <p>1: åº•å±‚bufferæœªè¢«å¡«æ»¡</p>

    <p>2: æ²¡æœ‰ä»»ä½•å¯ä»¥è¯»å–çš„æ•°æ®,ç­‰å¾…å‘é€æ•°æ®</p>

    <p>åé¢å¼€å‘äººå‘˜å‘ç°äº†è¿™ä¸ªé˜»å¡çš„bug,ç»è¿‡æŠ¢æ•‘æŠŠåŸå…ˆä½¿ç”¨inputStream æ¥æ£€æµ‹æµçš„ä»£ç æ¢æˆäº†BufferedInputStream,ç¥å¥‡çš„æ˜¯,é—®é¢˜å°±è¢«è§£å†³äº†.ä½†å´ä¸çŸ¥é“ä¸ºå•¥è¢«è§£å†³äº†,å°±æ˜¯è¿™ä¹ˆè«åå…¶å¦™.</p>
  </li>
</ol>

<p>â€‹	è¦æƒ³åˆ†æå‡ºåŸå› ,é‚£ä¹ˆå°±è¦æ‰’å¼€bufferçš„å¤–è¡£,è§‚å¯Ÿæœ¬è´¨.</p>

<h1 id="ä¸‰ä»£ç åˆ†æ">ä¸‰ã€ä»£ç åˆ†æ</h1>

<ol>
  <li>
    <p>BufferedInputStream,ä»¥ä¸‹ä¸ºçœç•¥éƒ¨åˆ†ä»£ç </p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span>
<span class="kd">class</span> <span class="nc">BufferedInputStream</span> <span class="kd">extends</span> <span class="nc">FilterInputStream</span> <span class="o">{</span>
   
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">DEFAULT_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">8192</span><span class="o">;</span>
   
    <span class="cm">/**
     * The maximum size of array to allocate.
     * Some VMs reserve some header words in an array.
     * Attempts to allocate larger arrays may result in
     * OutOfMemoryError: Requested array size exceeds VM limit
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">MAX_BUFFER_SIZE</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">-</span> <span class="mi">8</span><span class="o">;</span>
   
    <span class="cm">/**
     * The internal buffer array where the data is stored. When necessary,
     * it may be replaced by another array of
     * a different size.
     */</span>
    <span class="kd">protected</span> <span class="kd">volatile</span> <span class="kt">byte</span> <span class="n">buf</span><span class="o">[];</span>
     
    <span class="cm">/**
     * Check to make sure that underlying input stream has not been
     * nulled out due to close; if not return it;
     */</span>
    <span class="kd">private</span> <span class="nc">InputStream</span> <span class="nf">getInIfOpen</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">input</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Stream closed"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">input</span><span class="o">;</span>
    <span class="o">}</span>
   
    <span class="cm">/**
     * Check to make sure that buffer has not been nulled out due to
     * close; if not return it;
     */</span>
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBufIfOpen</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">buf</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Stream closed"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="o">}</span>
     
   <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fill</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">getBufIfOpen</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">markpos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>            <span class="cm">/* no mark: throw away the buffer */</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>  <span class="cm">/* no room left in buffer */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">markpos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  <span class="cm">/* can throw away early part of the buffer */</span>
                <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">markpos</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">markpos</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">sz</span><span class="o">);</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">sz</span><span class="o">;</span>
                <span class="n">markpos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="n">marklimit</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">markpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>   <span class="cm">/* buffer got too big, invalidate mark */</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>        <span class="cm">/* drop buffer contents */</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;=</span> <span class="no">MAX_BUFFER_SIZE</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">(</span><span class="s">"Required array size too large"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>            <span class="cm">/* grow buffer */</span>
                <span class="kt">int</span> <span class="n">nsz</span> <span class="o">=</span> <span class="o">(</span><span class="n">pos</span> <span class="o">&lt;=</span> <span class="no">MAX_BUFFER_SIZE</span> <span class="o">-</span> <span class="n">pos</span><span class="o">)</span> <span class="o">?</span>
                        <span class="n">pos</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">:</span> <span class="no">MAX_BUFFER_SIZE</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">nsz</span> <span class="o">&gt;</span> <span class="n">marklimit</span><span class="o">)</span>
                    <span class="n">nsz</span> <span class="o">=</span> <span class="n">marklimit</span><span class="o">;</span>
                <span class="kt">byte</span> <span class="n">nbuf</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">nsz</span><span class="o">];</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">nbuf</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">pos</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">bufUpdater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">buffer</span><span class="o">,</span> <span class="n">nbuf</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Can't replace buf if there was an async close.</span>
                    <span class="c1">// Note: This would need to be changed if fill()</span>
                    <span class="c1">// is ever made accessible to multiple threads.</span>
                    <span class="c1">// But for now, the only way CAS can fail is via close.</span>
                    <span class="c1">// assert buf == null;</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Stream closed"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">nbuf</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">pos</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">getInIfOpen</span><span class="o">().</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">pos</span><span class="o">,</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">pos</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">pos</span><span class="o">;</span>
    <span class="o">}</span>
     
   <span class="cm">/**
     * Read characters into a portion of an array, reading from the underlying
     * stream at most once if necessary.
     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">read1</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">pos</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">avail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* If the requested length is at least as large as the buffer, and
               if there is no mark/reset activity, do not bother to copy the
               bytes into the local buffer.  In this way buffered streams will
               cascade harmlessly. */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">getBufIfOpen</span><span class="o">().</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="n">markpos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">getInIfOpen</span><span class="o">().</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">fill</span><span class="o">();</span>
            <span class="n">avail</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">pos</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">avail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="o">(</span><span class="n">avail</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">)</span> <span class="o">?</span> <span class="n">avail</span> <span class="o">:</span> <span class="n">len</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">getBufIfOpen</span><span class="o">(),</span> <span class="n">pos</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">cnt</span><span class="o">);</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="n">cnt</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">cnt</span><span class="o">;</span>
    <span class="o">}</span>
     
     
   <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">(</span><span class="kt">byte</span> <span class="n">b</span><span class="o">[],</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span>
    <span class="o">{</span>
        <span class="n">getBufIfOpen</span><span class="o">();</span> <span class="c1">// Check for closed stream</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">off</span> <span class="o">|</span> <span class="n">len</span> <span class="o">|</span> <span class="o">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="o">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
   
        <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">nread</span> <span class="o">=</span> <span class="n">read1</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">off</span> <span class="o">+</span> <span class="n">n</span><span class="o">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">n</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nread</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">nread</span> <span class="o">:</span> <span class="n">n</span><span class="o">;</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">nread</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">n</span><span class="o">;</span>
            <span class="c1">// if not closed but no bytes available, return</span>
            <span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">input</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">input</span><span class="o">.</span><span class="na">available</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">n</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¼šä½¿ç”¨<code class="language-plaintext highlighter-rouge"> public synchronized int read(byte b[], int off, int len)</code>è¿™ä¸ªæ–¹æ³•å»è¯»å–æ•°æ®,<code class="language-plaintext highlighter-rouge">read</code>æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge">private int read1(byte[] b, int off, int len) throws IOException </code></p>

    <p>è¯»å–æ•°æ®.é‚£ä¹ˆæ ¸å¿ƒé€»è¾‘å°±åœ¨<code class="language-plaintext highlighter-rouge">read1</code>æ–¹æ³•ä¸­.</p>

    <p>èšç„¦ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">read1</code>æ–¹æ³•:</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="kd">private</span> <span class="kt">int</span> <span class="nf">read1</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">off</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">pos</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">avail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* If the requested length is at least as large as the buffer, and
               if there is no mark/reset activity, do not bother to copy the
               bytes into the local buffer.  In this way buffered streams will
               cascade harmlessly. */</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">getBufIfOpen</span><span class="o">().</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="n">markpos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">getInIfOpen</span><span class="o">().</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">fill</span><span class="o">();</span>
            <span class="n">avail</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">pos</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">avail</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="o">(</span><span class="n">avail</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">)</span> <span class="o">?</span> <span class="n">avail</span> <span class="o">:</span> <span class="n">len</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">getBufIfOpen</span><span class="o">(),</span> <span class="n">pos</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">off</span><span class="o">,</span> <span class="n">cnt</span><span class="o">);</span>
        <span class="n">pos</span> <span class="o">+=</span> <span class="n">cnt</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">cnt</span><span class="o">;</span>
    <span class="o">}</span>
     
</code></pre></div>    </div>

    <ol>
      <li>æ£€æµ‹æ˜¯å¦å…·æœ‰å¯ç”¨çš„æ•°æ®å¯ä¾›è¯»å–</li>
      <li>å¦‚æœæ²¡æœ‰åˆ™åˆ¤æ–­è¯»å–çš„é•¿åº¦æ˜¯å¦å¤§äº<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>å†…ç½®çš„bufferçš„é•¿åº¦,å¹¶ä¸”è®¾ç½®æ ‡è®°.</li>
      <li>å¦‚æœå¤§äºåˆ™è°ƒç”¨<code class="language-plaintext highlighter-rouge">InputStream</code>çš„<code class="language-plaintext highlighter-rouge">read</code>æ–¹æ³•è¯»å–,å¹¶è¿”å›æ•´ä¸ªæ•°ç»„</li>
      <li>å¦‚æœå°äº,åˆ™å¡«å……å†…ç½®<code class="language-plaintext highlighter-rouge">buffer</code></li>
      <li>æŠŠå†…ç½®bufferçš„æ•°æ®å¡«å……åˆ°å‚æ•°ä¸­çš„byte æ•°ç»„ä¸­å»</li>
    </ol>

    <p>ä»¥ä¸Šä¸ºæ•´ä½“é€»è¾‘.</p>

    <p>â€‹	æ„Ÿè§‰å¥½åƒæ²¡åšä»€ä¹ˆåŠ é€Ÿçš„æ“ä½œ,ä¸ºå•¥éƒ½è¯´<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>å¿«å‘¢?å…¶å®åœ¨ä½ è¯»å–çš„æ•°æ®é•¿åº¦å°äº<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>å†…ç½®buffeçš„æ—¶å€™æ‰ä¼šæœ‰â€å¿«â€è¿™ä¸ªè¯´æ³•.ä½†ä¹Ÿä¸å¿«,æœ¬è´¨ä¸Šè¿˜æ˜¯ç”¨<code class="language-plaintext highlighter-rouge">InputStream</code>å»è¯»å–çš„æ•°æ®,é‚£ä¹ˆä»ç½‘ç»œä¸­è¯»å–é€Ÿåº¦å°±æ˜¯ä¸€æ ·çš„,åªæ˜¯åœ¨ä½ éœ€è¦è¯»å–çš„æ•°æ®é•¿åº¦å°äº<code class="language-plaintext highlighter-rouge">BufferedInputSteam</code>å†…ç½®Bufferé•¿åº¦çš„æ—¶å€™,å®ƒä¼šä¸€æ¬¡æ€§è¯»å–å¡«æ»¡åˆ°buffer,åœ¨ä¸‹æ¬¡è¯»å–çš„æ—¶å€™å°±ä¸ä¼šä»ç½‘ç»œä¸­è¯»å–äº†,è€Œæ˜¯åœ¨bufferä¸­è¯»å–,ç›´æ¥ä»å†…å­˜ä¸­è¯»å–,å‡å°‘äº†ä¸€æ¬¡ç½‘ç»œçš„IOå¼€é”€,æˆ–è®¸è¿™å°±æ˜¯â€å¿«â€çš„åŸå› ?</p>

    <p>é‚£ä¹ˆ,è¿™ä¸ªé˜»å¡æ˜¯æ€ä¹ˆæ¥çš„?</p>

    <p>â€‹	çŸ¥é“<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>çš„æœ¬è´¨ä¹‹å,å°±å¥½åˆ†æäº†.å›åˆ°ä¸šåŠ¡ä»£ç å’Œæµæ£€æµ‹ä»£ç ä¸­æ¥,å¯ä»¥å‘ç°åœ¨æµæ£€æµ‹ä»£ç ä¸­,åªè¯»å–äº†ä¸€ä¸ªå­—èŠ‚.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">();</span><span class="c1">//å‘ç”Ÿé˜»å¡</span>
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">read</code>æ–¹æ³•çš„å…·ä½“å®ç°</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span>  <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">connected</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Pipe not connected"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">closedByReader</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Pipe closed"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">writeSide</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">writeSide</span><span class="o">.</span><span class="na">isAlive</span><span class="o">()</span>
                   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">closedByWriter</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">in</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Write end dead"</span><span class="o">);</span>
        <span class="o">}</span>
   
        <span class="n">readSide</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">trials</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">in</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">closedByWriter</span><span class="o">)</span> <span class="o">{</span>
                <span class="cm">/* closed by writer, return EOF */</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">writeSide</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">writeSide</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">(--</span><span class="n">trials</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Pipe broken"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="cm">/* might be a writer waiting */</span>
            <span class="n">notifyAll</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InterruptedIOException</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">[</span><span class="n">out</span><span class="o">++]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">out</span> <span class="o">&gt;=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/* now empty */</span>
            <span class="n">in</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
   
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div>    </div>

    <p>â€‹	å¯ä»¥çœ‹åˆ°ä»£ç é‡Œé¢ä¼šæœ‰ä¸€ä¸ªwhileå¾ªç¯åœ¨æ£€æŸ¥æ˜¯å¦å…·æœ‰å¯è¯»å–çš„æ•°æ®,å¦‚æœæ²¡æœ‰å¯è¯»å–çš„æ•°æ®,whileå°†ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»,åªå¸¦æœ‰å¯è¯»å–çš„æ•°æ®ä½ç½®.é˜»å¡å°±æ˜¯å› ä¸ºwhileåœ¨ç©ºè½¬.</p>

    <p>â€‹    ç»“æ¡ˆ: å› ä¸ºå‰é¢ä½¿ç”¨<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>è¯»å–æ•°æ®,<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>ä¼šä¸€æ¬¡æ€§,æŠŠæ•´ä¸ªbufferå…¨éƒ¨å¡«æ»¡,é»˜è®¤bufferå¤§å°æ˜¯<code class="language-plaintext highlighter-rouge">private static int DEFAULT_BUFFER_SIZE = 8192;</code>.</p>

    <p>ä¹Ÿå°±æ˜¯è¯´<code class="language-plaintext highlighter-rouge">BufferedInputStream</code>å…ˆæŠŠæ•°æ® è¯»å®Œäº†,è¯»åˆ°bufferä¸­äº†,åé¢ä»£ç ä½¿ç”¨<code class="language-plaintext highlighter-rouge">InputStream</code>çš„æ—¶å€™å½“ç„¶è¯»å–ä¸åˆ°æ•°æ®äº†,å°±ä¼šåœ¨whileé‚£é‡Œç©ºè½¬,ç›´åˆ°æœ‰æ•°æ®ä¸ºæ­¢,å¯<code class="language-plaintext highlighter-rouge">InputStream</code>å“ªé‡ŒçŸ¥é“,æ•°æ®æ—©å°±æ²¡è¯»å–å®Œäº†,å“,ä¸è¯´äº†çœŸå‚»!</p>
  </li>
</ol>

:ET