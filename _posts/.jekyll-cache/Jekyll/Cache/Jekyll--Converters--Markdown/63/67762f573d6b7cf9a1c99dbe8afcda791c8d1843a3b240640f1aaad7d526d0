I"~`<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>ä½¿ç”¨jnaå’Œjniéƒ½ä¸å¯é¿å…å†…å­˜æ³„éœ²çš„é—®é¢˜,ä¸€èˆ¬å†…å­˜æ³„éœ²åˆ†ä¸¤ç§,ä¸€ç§æœ¬åœ°åº“æœ¬èº«æœ‰å†…å­˜æ³„éœ²é—®é¢˜,å¦ä¸€ç§JVM å†…å­˜ä¸­ native memory çš„å†…å­˜æ³„æ¼.</p>

<p>æœ¬åœ°åº“æœ¬èº«æœ‰æ³„éœ²è¿™ç§å®šä½èµ·æ¥æ¯”è¾ƒéº»çƒ¦,æ¯•ç«Ÿä½ ä¹Ÿæ²¡æœ‰ä»–çš„æºç ä¸æ˜¯.native memory å†…å­˜æ³„éœ²è¿™ä¸ªè¿˜æ¯”è¾ƒå¥½å®šä½,é¦–å…ˆä¿æŠ¤å¥½æ¡ˆå‘ç°åœº,ä¿å­˜å¥½ç¨‹åºè¿è¡Œæ—¥å¿—,heap dump ä¸‹æ¥,ç„¶åå°±å¯ä»¥æ…¢æ…¢çš„æ¥è°ƒæŸ¥æ¥,ä¸€èˆ¬éƒ½å¯ä»¥çŸ³é”¤.</p>

<p>ç¬”è€…è¿™æ¬¡å‡ºç°é—®é¢˜,ä¸»è¦æ˜¯å› ä¸ºæ¢äº†ä¸ªçº¿ç¨‹æ± å¯¼è‡´çš„.ä¸ºäº†åŠ å¿«è™¹è½¯çš„å¯¹æ¯”é€Ÿåº¦,é‡‡ç”¨äº†å¤šçº¿ç¨‹å¹¶å‘çš„æ–¹å¼è¿›è¡Œå¯¹æ¯”,åªè¦å…¶ä¸­ä¸€ä¸ªå¯¹æ¯”æˆåŠŸ,å…¶ä½™ä»»åŠ¡å…¨éƒ¨å–æ¶ˆ.å½“æ—¶ä¸ºäº†ä¸Šçº¿æ€¥å¿™å¿™çš„è‡ªå·±å®ç°äº†,çº¿ç¨‹æ± é‡‡ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code>,å¹¶ç»§æ‰¿Threadå¯¹è±¡,åœ¨è¯¥å¯¹è±¡ç±»å¼•å…¥è™¹è½¯çš„äººè„¸è¯†åˆ«å¼•æ“,è¯¥æ–¹å¼æ˜¯ä¸ºäº†æ¯ä¸ªçº¿ç¨‹ç‹¬äº«ä¸€ä¸ªè™¹è½¯å¼•æ“.</p>

<p>ä¸Šçº¿ä¹‹åå‘ç°ç¨‹åºè¿è¡Œæ­£å¸¸,æ²¡æœ‰ä»€ä¹ˆå¤§é—®é¢˜,åªæ˜¯è¯†åˆ«çš„é€Ÿåº¦ç¨å¾®æœ‰ç‚¹æ…¢,äºæ˜¯æˆ‘æƒ³ç”¨forkjoinçš„æ–¹å¼æ¥ä¼˜åŒ–å¤šçº¿ç¨‹è¯†åˆ«,ç»“æœæ¢äº†forkjoinPool ä¹‹åå°±GGäº†.</p>

<blockquote>
  <p>Tip: åœ¨java 8 ä¸­çš„parallelStream æ˜¯ç”¨çš„forkjoin common pool,ä½†æ˜¯ä¹Ÿå¯ä»¥æŒ‡å®šçº¿ç¨‹æ± çš„.ä¾‹å¦‚:</p>

  <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨æŒ‡å®šçš„poolè€ŒécommonPool</span>
<span class="nc">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="n">forkJoinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>
    <span class="c1">//parallel task here, for example</span>
    <span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1_000_000</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="nl">PrimesPrint:</span><span class="o">:</span><span class="n">isPrime</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">())</span>
<span class="o">).</span><span class="na">get</span><span class="o">();</span>
</code></pre></div>  </div>
</blockquote>

<h1 id="äºŒæ¡ˆå‘ç°åœº">äºŒã€æ¡ˆå‘ç°åœº</h1>

<p>å…ˆçœ‹çœ‹è™šæ‹Ÿæœºcrashæ—¶çš„æ—¥å¿—</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="c"># There is insufficient memory for the Java Runtime Environment to continue.</span>
<span class="c"># Native memory allocation (malloc) failed to allocate 396336 bytes for Chunk::new</span>
<span class="c"># Possible reasons:</span>
<span class="c">#   The system is out of physical RAM or swap space</span>
<span class="c">#   In 32 bit mode, the process size limit was hit</span>
<span class="c"># Possible solutions:</span>
<span class="c">#   Reduce memory load on the system</span>
<span class="c">#   Increase physical memory or swap space</span>
<span class="c">#   Check if swap backing store is full</span>
<span class="c">#   Use 64 bit Java on a 64 bit OS</span>
<span class="c">#   Decrease Java heap size (-Xmx/-Xms)</span>
<span class="c">#   Decrease number of Java threads</span>
<span class="c">#   Decrease Java thread stack sizes (-Xss)</span>
<span class="c">#   Set larger code cache with -XX:ReservedCodeCacheSize=</span>
<span class="c"># This output file may be truncated or incomplete.</span>
<span class="c">#</span>
<span class="c">#  Out of Memory Error (allocation.cpp:390), pid=13568, tid=0x0000000000002278</span>
<span class="c">#</span>
<span class="c"># JRE version: Java(TM) SE Runtime Environment (8.0_171-b11) (build 1.8.0_171-b11)</span>
<span class="c"># Java VM: Java HotSpot(TM) 64-Bit Server VM (25.171-b11 mixed mode windows-amd64 compressed oops)</span>
<span class="c"># Failed to write core dump. Minidumps are not enabled by default on client versions of Windows</span>
<span class="c">#</span>

<span class="nt">---------------</span>  T H R E A D  <span class="nt">---------------</span>

Current thread <span class="o">(</span>0x000000001afcc800<span class="o">)</span>:  JavaThread <span class="s2">"C2 CompilerThread1"</span> daemon <span class="o">[</span>_thread_in_native, <span class="nb">id</span><span class="o">=</span>8824, stack<span class="o">(</span>0x000000001b7e0000,0x000000001b8e0000<span class="o">)]</span>

Stack: <span class="o">[</span>0x000000001b7e0000,0x000000001b8e0000]
<span class="o">[</span>error occurred during error reporting <span class="o">(</span>printing stack bounds<span class="o">)</span>, <span class="nb">id </span>0xc0000005]

Native frames: <span class="o">(</span><span class="nv">J</span><span class="o">=</span>compiled Java code, <span class="nv">j</span><span class="o">=</span>interpreted, <span class="nv">Vv</span><span class="o">=</span>VM code, <span class="nv">C</span><span class="o">=</span>native code<span class="o">)</span>


Current CompileTask:
C2: 857396 14693       4       ch.qos.logback.classic.spi.StackTraceElementProxy::getSTEAsString <span class="o">(</span>38 bytes<span class="o">)</span>


<span class="nt">---------------</span>  P R O C E S S  <span class="nt">---------------</span>

Java Threads: <span class="o">(</span> <span class="o">=&gt;</span> current thread <span class="o">)</span>
  0x0000000028049800 JavaThread <span class="s2">"fork-join-face-115"</span> daemon <span class="o">[</span>_thread_blocked, <span class="nb">id</span><span class="o">=</span>4384, stack<span class="o">(</span>0x00000003dcc90000,0x00000003dcd90000<span class="o">)]</span>
<span class="c">#çœç•¥çº¿ç¨‹ä¿¡æ¯...</span>
</code></pre></div></div>

<p>ä»crashæ—¥å¿—ä¸Šçœ‹,è¯´æ˜¯jvmç”³è¯·396336å­—èŠ‚å¤§å°çš„native memory çš„æ—¶å€™å†…å­˜ä¸å¤Ÿç„¶åcrashæ‰äº†.logç»™å‡ºå¯èƒ½å¯¼è‡´crashçš„åŸå› :</p>

<ul>
  <li>The system is out of physical RAM or swap space ,è¿™æ¡ä¸æ˜¯å¯èƒ½çš„,æœåŠ¡å™¨çš„å†…å­˜æ˜¯8G,è€Œç¨‹åºcrashæ‰çš„æ—¶å€™ æ˜¯4Gå¤šçš„æ—¶å€™</li>
  <li>In 32 bit mode, the process size limit was hit,è¿™æ¡ä¹Ÿä¸å¯èƒ½,å› ä¸ºæœåŠ¡å™¨æ˜¯64ä½çš„,jdkä¹Ÿæ˜¯64ä½çš„.</li>
</ul>

<p>ä»ä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯å¹¶æ²¡æœ‰çœ‹å‡ºä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯,ä½†æœ‰ä¸ªé—®é¢˜å¾ˆå¥‡æ€ªæ˜æ˜å†…å­˜å¤Ÿä¸ºä»€ä¹ˆä¼šcrash,åœ¨çœ‹çœ‹ç¨‹åºçš„è¿è¡Œæ—¥å¿—:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2018</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">14</span> <span class="mi">11</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mi">22</span> <span class="o">|</span> <span class="no">ERROR</span> <span class="o">|</span> <span class="n">face</span><span class="o">-</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.2</span><span class="o">-</span><span class="nc">Thread</span> <span class="o">|</span> <span class="n">com</span><span class="o">.</span><span class="na">zzwtec</span><span class="o">.</span><span class="na">camera</span><span class="o">.</span><span class="na">fx</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">face</span><span class="o">.</span><span class="na">FaceService</span><span class="o">.</span><span class="na">lambda</span><span class="n">$init</span><span class="err">$</span><span class="mi">1</span><span class="o">:</span><span class="mi">129</span> <span class="o">|</span> <span class="o">[</span><span class="n">face</span><span class="o">-</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.2</span><span class="o">-</span><span class="nc">Thread</span><span class="o">]</span>  <span class="n">äººè„¸æ£€æµ‹ä»»åŠ¡å‡ºç°å¼‚å¸¸</span><span class="o">!</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Error</span><span class="o">:</span> <span class="nc">Invalid</span> <span class="n">memory</span> <span class="n">access</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jna</span><span class="o">.</span><span class="na">Native</span><span class="o">.</span><span class="na">invokeInt</span><span class="o">(</span><span class="nc">Native</span> <span class="nc">Method</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jna</span><span class="o">.</span><span class="na">Function</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="nc">Function</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">419</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jna</span><span class="o">.</span><span class="na">Function</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="nc">Function</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">354</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jna</span><span class="o">.</span><span class="na">Library</span><span class="n">$Handler</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="nc">Library</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">244</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="n">$Proxy150</span><span class="o">.</span><span class="na">AFT_FSDK_InitialFaceEngine</span><span class="o">(</span><span class="nc">Unknown</span> <span class="nc">Source</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">zzwtec</span><span class="o">.</span><span class="na">camera</span><span class="o">.</span><span class="na">fx</span><span class="o">.</span><span class="na">face</span><span class="o">.</span><span class="na">Tracking</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="nc">Tracking</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">34</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">zzwtec</span><span class="o">.</span><span class="na">camera</span><span class="o">.</span><span class="na">fx</span><span class="o">.</span><span class="na">face</span><span class="o">.</span><span class="na">FaceThread</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="nc">FaceThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">17</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">common</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadFactoryBuilder</span><span class="err">$</span><span class="mi">1</span><span class="o">.</span><span class="na">newThread</span><span class="o">(</span><span class="nc">ThreadFactoryBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">163</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="n">$Worker</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="nc">Unknown</span> <span class="nc">Source</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="o">.</span><span class="na">addWorker</span><span class="o">(</span><span class="nc">Unknown</span> <span class="nc">Source</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="o">.</span><span class="na">processWorkerExit</span><span class="o">(</span><span class="nc">UnknownSource</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="o">.</span><span class="na">runWorker</span><span class="o">(</span><span class="nc">Unknown</span> <span class="nc">So</span>
</code></pre></div></div>

<p>å¤§é‡å‡ºç°<code class="language-plaintext highlighter-rouge">java.lang.Error: Invalid memory access</code>çš„é”™è¯¯,ä½†æœ‰ä¸ªé—®é¢˜å€¼å¾—æ³¨æ„æ˜¯æˆ‘åˆ›å»ºçš„æ˜¯ä¸ªçº¿ç¨‹æ± ,æŒ‰é“ç†æ˜¯ä¸ä¼šé¢‘ç¹åˆ›å»ºçº¿ç¨‹çš„,ä¸ºå•¥ä¼šè¿™ä¹ˆé¢‘ç¹çš„åˆ›å»ºçº¿ç¨‹?è€Œä¸”åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™éƒ½æ˜¯åœ¨è™¹è½¯SDK åˆå§‹åŒ–å¼•æ“çš„æ—¶å€™æŒ‚æ‰äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">FD_WORK_BUF_SIZE</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span><span class="c1">// 20 MB</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">nScale</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span> <span class="c1">// æœ‰æ•ˆå€¼èŒƒå›´[2,50]</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_FACE_NUM</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span> <span class="c1">// æœ‰æ•ˆå€¼èŒƒå›´[1,50]</span>
<span class="kd">private</span> <span class="nc">Pointer</span> <span class="n">hFDEngine</span><span class="o">;</span>
<span class="kd">public</span> <span class="nf">Detection</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="no">APPID</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">String</span> <span class="no">FD_SDKKEY</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="nc">OSUtils</span><span class="o">.</span><span class="na">getCurrentOSType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">OSUtils</span><span class="o">.</span><span class="na">OSType</span><span class="o">.</span><span class="na">Windows</span><span class="o">){</span>
            <span class="no">APPID</span> <span class="o">=</span> <span class="nc">ArcFace</span><span class="o">.</span><span class="na">appid_Windows_x64</span><span class="o">;</span>
            <span class="no">FD_SDKKEY</span> <span class="o">=</span> <span class="nc">ArcFace</span><span class="o">.</span><span class="na">sdkkey_FD_Windows_x64</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="nc">OSUtils</span><span class="o">.</span><span class="na">getCurrentOSType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">OSUtils</span><span class="o">.</span><span class="na">OSType</span><span class="o">.</span><span class="na">Linux</span><span class="o">){</span>
            <span class="no">APPID</span> <span class="o">=</span> <span class="nc">ArcFace</span><span class="o">.</span><span class="na">appid_Linux_x64</span><span class="o">;</span>
            <span class="no">FD_SDKKEY</span> <span class="o">=</span> <span class="nc">ArcFace</span><span class="o">.</span><span class="na">sdkkey_FD_Linux_x64</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Pointer</span> <span class="n">pFDWorkMem</span> <span class="o">=</span> <span class="nc">CLibrary</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">malloc</span><span class="o">(</span><span class="no">FD_WORK_BUF_SIZE</span><span class="o">);</span>
        <span class="nc">PointerByReference</span> <span class="n">phFDEngine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PointerByReference</span><span class="o">();</span>
        <span class="nc">NativeLong</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">AFD_FSDKEngine</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">AFD_FSDK_InitialFaceEngine</span><span class="o">(</span>
                <span class="no">APPID</span><span class="o">,</span>
                <span class="no">FD_SDKKEY</span><span class="o">,</span>
                <span class="n">pFDWorkMem</span><span class="o">,</span>
                <span class="no">FD_WORK_BUF_SIZE</span><span class="o">,</span>
                <span class="n">phFDEngine</span><span class="o">,</span>
                <span class="n">FSDK_OrientPriority</span><span class="o">.</span><span class="na">FSDK_OPF_0_HIGHER_EXT</span><span class="o">,</span>
                <span class="n">nScale</span><span class="o">,</span>
                <span class="no">MAX_FACE_NUM</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ret</span><span class="o">.</span><span class="na">longValue</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">CLibrary</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">pFDWorkMem</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"AFD_FSDK_InitialFaceEngine ret 0x%x %s"</span><span class="o">,</span> <span class="n">ret</span><span class="o">.</span><span class="na">longValue</span><span class="o">(),</span> <span class="nc">Error</span><span class="o">.</span><span class="na">getErrorMsg</span><span class="o">(</span><span class="n">ret</span><span class="o">.</span><span class="na">longValue</span><span class="o">())));</span>
        <span class="o">}</span>
        <span class="n">hFDEngine</span> <span class="o">=</span> <span class="n">phFDEngine</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>å¯ä»¥é€šè¿‡ä»¥ä¸Šä»£ç çŸ¥é“,åˆå§‹åŒ–ä¸€ä¸ªDetectionå¯¹è±¡è‡³å°‘éœ€è¦20Må†…å­˜,è€Œä¸”ç¬”è€…æŠŠä¸‰ä¸ªå¼•æ“å¯¹è±¡å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡é‡Œé¢,ä¸‰ä¸ªå¼•æ“å…¨éƒ¨åˆå§‹åŒ–å®Œæ¯•è‡³å°‘éœ€è¦100Mçš„å†…å­˜.å¦‚æœçº¿ç¨‹é¢‘ç¹çš„åˆ›å»ºçš„ç¡®ä¼šå¯¼è‡´å†…å­˜æ³„éœ²çš„é—®é¢˜,å› ä¸ºç¬”è€…æ²¡æœ‰è€ƒè™‘åˆ°çº¿ç¨‹è¢«é¢‘ç¹åˆ›å»ºçš„æƒ…å†µ,æ‰€ä»¥æ²¡æœ‰å†™é‡Šæ”¾å†…å­˜çš„æ–¹æ³•å’Œå¤å†™finalizeæ–¹æ³•.</p>

<h1 id="ä¸‰åŸå› åˆ†æ">ä¸‰ã€åŸå› åˆ†æ</h1>

<p>é€šè¿‡crashæ—¥å¿—å’Œè¿è¡Œæ—¥å¿—å¯ä»¥çœ‹å‡º:</p>

<pre><code class="language-mermaid">graph TD
A[JVM]--&gt; B[crash]
B --&gt; C[æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜]
C --&gt; D[é¢‘ç¹åˆ›å»ºçº¿ç¨‹å¯¹è±¡]
D --&gt; E1[æŒ‚æ‰äº†ä¸€ä¸ªçº¿ç¨‹,çº¿ç¨‹æ± ä¸ºäº†ç»´æŒçº¿ç¨‹çš„æ•°é‡è€Œåˆ›å»º]
D --&gt; E2[å†…å­˜ä¸å¤Ÿå¯¼è‡´çº¿ç¨‹æŒ‚æ‰]
E2 --&gt; E1
E1 --&gt; C
C --&gt; B
</code></pre>

<p>emmmm,çœ‹èµ·æ¥è¿˜æ˜¯æ€ªæ€ªçš„,è¿™TMä¸æ˜¯ä¸€ä¸ªå¾ªç¯å˜›!æ€ç»ªå·²ç»é™·å…¥æ­»èƒ¡åŒäº†,å¥½ä¸å®¹æ˜“æ‰¾åˆ°çº¿ç´¢åˆç»™æ–­äº†.</p>

<h1 id="å››è¿˜åŸæ¡ˆå‘ç°åœº">å››ã€è¿˜åŸæ¡ˆå‘ç°åœº</h1>

<p>æ—¢ç„¶çº¿ç´¢æ–­äº†,å°±çœ‹èƒ½ä¸èƒ½è¿˜åŸæ¡ˆå‘ç°åœºäº†,å°±æ˜¯æœ¬åœ°å¤ç°ä¸€æ¬¡.ä½†è¿™ç§å¤ç°æ˜¯è¦æœ‰ç‚¹æŠ€å·§çš„,å¹¶ä¸æ˜¯æŠŠæ•´ä¸ªç¨‹åºè·‘è·‘ä¹‹ç±»,ä¸€å®šè¦æ‰¾å…³é”®ä»£ç ,æ¥æµ‹è¯•.ä»æ—¥å¿—å¯ä»¥çœ‹å‡ºæ˜¯jnaè¿™å—å„¿å‡ºçš„é—®é¢˜,é‚£ä¹ˆåœ¨ç¬”è€…è¿™ä¸ªé¡¹ç›®ä¸­ç”¨åˆ°äº†jnaçš„æ˜¯äººè„¸æ£€æµ‹å’Œäººè„¸å¯¹æ¯”äº†.</p>

<p>äºæ˜¯ç¬”è€…åˆ†åˆ«æŠŠè¿™ä¸¤å—å„¿åŠŸèƒ½çš„ä»£ç åœ¨æœ¬åœ°ä»£ç è·‘äº†10Wæ¬¡,åœ¨äººè„¸æ£€æµ‹è¿™å—å„¿å¹¶æ²¡æœ‰å‘ç°å†…å­˜æ³„éœ²çš„æƒ…å†µ,ä½†åœ¨äººè„¸æ¯”å¯¹çš„æ—¶å€™å†…å­˜æ³„éœ²æ˜¾è‘—,å¹¶ä¸”è¿˜å¤ç°äº†jvm crashçš„è¿™ç§æƒ…å†µ.</p>

<p>é‚£ä¹ˆå°±æ˜¯æœ‰ç‚¹æ„æ€äº†,è¯´æ˜å‡ºç°é—®é¢˜çš„å°±æ˜¯äººè„¸å¯¹æ¯”äº†.äººè„¸å¯¹æ¯”è¿™å—å„¿,æ˜¯ç”¨çš„forkjoinPool çš„çº¿ç¨‹æ± ,ä¹‹å‰æ²¡ç”¨è¿™ä¸ªçš„æ—¶å€™å°±æ²¡é—®é¢˜,éš¾é“forkjoinPoolè¿™ä¸ªçº¿ç¨‹æ± å’Œæ™®é€šçš„threadPoolExecutorä¸ä¸€æ ·?</p>

<p>äºæ˜¯æ€€ç€æ­å¼€çœŸç›¸çš„å¿ƒæƒ…,å¯åŠ¨äº†jvisualvm,é€šè¿‡jvisualvmè§‚å¯Ÿå¯ä»¥å‘ç°,forkjoinPoolçº¿ç¨‹æ± æ¥å—ä¸€æ¬¡ä»»åŠ¡ä¼šå¯ç”¨ç‰©ç†æœºæœ€å¤§æ ¸å¿ƒæ•°çš„çº¿ç¨‹æ•°é‡,ä¹Ÿå°±æ˜¯è¯´åœ¨2æ ¸4çº¿ç¨‹çš„æœºå™¨ä¸Š,forkjoinPoolä¼šå¼€å¯4æ¡çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡.</p>

<p>ä½†è¿™4æ¡çº¿ç¨‹å¹¶ä¸æ˜¯å¤ç”¨,è€Œæ˜¯ä¸€æ¬¡æ€§çš„.é€šè¿‡è§‚å¯Ÿå¯ä»¥çœ‹å‡ºå½“è¿™4æ¡çº¿ç¨‹åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™ä¼šè¢«é”€æ¯.æ¯•ç«Ÿå·¥ä½œçªƒå–ç®—æ³•æ²¡å·¥ä½œçªƒå–äº†å˜›,çªƒç¬‘.</p>

<h1 id="äº”çŸ³é”¤">äº”ã€çŸ³é”¤</h1>

<p>é€šè¿‡æ¡ˆå‘ç°åœºçš„è¿˜åŸ,å¾—å‡ºçš„ç»“è®ºæ˜¯:</p>

<pre><code class="language-mermaid">graph TD
A[æ£€æµ‹åˆ°äººè„¸] --&gt; B[æäº¤ä»»åŠ¡ç»™forkjoinPool]
B --&gt; C[forkjoinPoolçº¿ç¨‹æ± forkå‡º4æ¡çº¿ç¨‹]
C --&gt; D[çº¿ç¨‹åˆå§‹åŒ–]
D --&gt; E[åˆå§‹åŒ–è™¹è½¯å¼•æ“,4æ¡çº¿ç¨‹æ€»å…±éœ€è¦400M]
E --&gt; F[äººè„¸æ¯”å¯¹ä»»åŠ¡å®Œæˆ,çº¿ç¨‹é”€æ¯,å¹¶æ²¡æœ‰é‡Šæ”¾native memory]

</code></pre>

<p>è¿™ä¸ªè¿‡ç¨‹,ä¼šåœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™å¾ªç¯å¾ˆå¤šæ¬¡.</p>

<p>ä»¥ä¸Šåªæ˜¯æˆ‘çš„çŒœæƒ³,æœ‰ä¸ªç–‘æƒ‘çš„æ˜¯,çº¿ç¨‹ä¸ºä»€ä¹ˆä¸å¤ç”¨,éœ€è¦åå¤åˆ›å»ºæ€ä¹ˆå¤šæ¬¡?</p>

<p>äºæ˜¯çœ‹äº†ä¸€ä¸‹æºç ,æ™®é€šçš„threadPoolExecutoré‡Œé¢æ˜¯æœ‰ä¸ªä»»åŠ¡é˜Ÿåˆ—çš„,åˆ›å»ºå‡ºçš„çº¿ç¨‹ä¼šä¸€ç›´pllè¿™ä¸ªé˜Ÿåˆ—,å¦‚æœé˜Ÿåˆ—ä¸­å°±ä»»åŠ¡,é‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šæ‰§è¡Œè¿™ä¸ªä»»åŠ¡,å¦‚æœé˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡é‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šwait,ç›´åˆ°æœ‰ä»»åŠ¡ä¸ºæ­¢.</p>

<p>ä¸threadPoolExecutorä¸åŒçš„æ˜¯forkjoinPoolé‡‡ç”¨åˆ†è€Œæ²»ä¹‹çš„æ–¹å¼æ¥å¹¶è¡Œå¤„ç†ä»»åŠ¡.å½“ä»»åŠ¡æ·»åŠ åˆ°forkjoinPoolæ—¶,ä¼šæŠŠä»»åŠ¡ä¸æ–­çš„åˆ†å‰²ç›´åˆ°ä»»åŠ¡è¶³å¤Ÿçš„å°æ‰ä¼šå¼€å§‹æ‰§è¡Œ.å¦‚æœè¿™é‡Œçš„å¤„ç†çš„æ–¹å¼å’ŒthreadPoolExecutorä¸€æ ·,å¤„ç†å®Œä»»åŠ¡å°±wait,å°±æ— æ³•åˆ†è€Œæ²»ä¹‹äº†.</p>

<p>é€šè¿‡ä»¥ä¸Šçš„åˆ†æ,ç¬”è€…æŠŠåˆ›å»ºçº¿ç¨‹åˆå§‹åŒ–é€»è¾‘æ”¹äº†ä¸€ä¸‹,æŠŠè™¹è½¯çš„å¼•æ“ç¼“å­˜èµ·æ¥,åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª.è¿™æ ·ä¸ç®¡åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹,æ•´ä¸ªç¨‹åºåªä¼šæœ‰ç¼“å­˜èµ·æ¥çš„é‚£å‡ ä¸ªå¼•æ“,ä¸ä¼šéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»º.ç¬”è€…æŠŠä¿®æ”¹å¥½çš„ä»£ç è¿›è¡Œ10Wæ¬¡å¾ªç¯æµ‹è¯•,æœç„¶æ²¡æœ‰å¤ç°å†…å­˜æ³„éœ²çš„é—®é¢˜,åé¢åˆè¿›è¡Œäº†12å°æ—¶çš„å¾ªç¯æµ‹è¯•,ä¹Ÿæ²¡å‘ç°é—®é¢˜.çº¿ç¨‹æ± çš„é—®é¢˜,å¯è°“æ˜¯çŸ³é”¤äº†.</p>

<h1 id="å…­ç»“è®º">å…­ã€ç»“è®º</h1>

<p>é‡åˆ°è¿™ç§jnaçš„é—®é¢˜,ä¸€å®šä¸è¦æ…Œ,è¦é€šè¿‡å¤šæ–¹é¢çš„åˆ†ææ¥æ–­æ¡ˆ,ä¸è¦æ€•crashçš„æ—¥å¿—.åŸºç¡€è¿˜æ˜¯å¾ˆé‡è¦å‘€,åŸæ¥forkjoinPoolä¸é‡å¤ä½¿ç”¨çº¿ç¨‹,è¿™ç‚¹ä¹‹å‰éƒ½æ²¡æ³¨æ„è¿‡.è®¤çœŸå­¦ä¹ .ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£</p>
:ET