<h1 id="一前言">一、前言</h1>

<p>在这个数据时代,对数据库的要求是越来越高了,百万级的数据毫秒响应,对于mysql来说有很多种的优化方案.但postgresql却用的比较自然</p>

<h2 id="二hash分区">二、hash分区</h2>

<blockquote>
  <p>首先要安装postgresql,安装教程可以百度.很简单.</p>
</blockquote>

<p>在postgresql11之前是不支持hash分区的,支持list和range分区的方式,当然也可以巧妙的利用list实现hash分区的功能.</p>

<ul>
  <li>
    <p>创建主表:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span> <span class="p">(</span>
  <span class="nv">"id"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">"account"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">"operate"</span> <span class="n">int2</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">"tableName"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">"sql"</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">"args"</span> <span class="nb">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">"createTime"</span> <span class="nb">timestamp</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span><span class="n">operate</span><span class="p">)</span>
  
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">IS</span> <span class="s1">'uuid不能为null'</span><span class="p">;</span>
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"account"</span> <span class="k">IS</span> <span class="s1">'用户名不能为null'</span><span class="p">;</span>
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"operate"</span> <span class="k">IS</span> <span class="s1">'0是增加 1是修改 2删除 不能为null'</span><span class="p">;</span>
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"tableName"</span> <span class="k">IS</span> <span class="s1">'表名不能为null'</span><span class="p">;</span>
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"sql"</span> <span class="k">IS</span> <span class="s1">'sql语句,不能为null'</span><span class="p">;</span>
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"args"</span> <span class="k">IS</span> <span class="s1">'参数,默认是 json数组'</span><span class="p">;</span>
  
<span class="k">COMMENT</span> <span class="k">ON</span> <span class="k">COLUMN</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span><span class="p">.</span><span class="nv">"createTime"</span> <span class="k">IS</span> <span class="s1">'创建时间不能为null'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建分区表</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"SysOperateLog0"</span> <span class="n">PARTITION</span> <span class="k">OF</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span> <span class="k">FOR</span> <span class="k">VALUES</span> <span class="k">WITH</span><span class="p">(</span><span class="n">MODULUS</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REMAINDER</span> <span class="mi">0</span><span class="p">);</span>
  
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"SysOperateLog1"</span> <span class="n">PARTITION</span> <span class="k">OF</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span> <span class="k">FOR</span> <span class="k">VALUES</span> <span class="k">WITH</span><span class="p">(</span><span class="n">MODULUS</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REMAINDER</span> <span class="mi">1</span><span class="p">);</span>
  
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"SysOperateLog2"</span> <span class="n">PARTITION</span> <span class="k">OF</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog"</span> <span class="k">FOR</span> <span class="k">VALUES</span> <span class="k">WITH</span><span class="p">(</span><span class="n">MODULUS</span> <span class="mi">3</span><span class="p">,</span> <span class="n">REMAINDER</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>以上就把分成3张分表,根据operate字段进行hash分区.但有个问题是,在主表上是不能创建主键或外键约束的.但可以在分区表上加约束</p>

<ul>
  <li>
    <p>创建主键约束</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog0"</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">"id"</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog1"</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">"id"</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">"public"</span><span class="p">.</span><span class="nv">"SysOperateLog2"</span> <span class="k">ADD</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">"id"</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>但这里还有一个问题,如果在<code class="language-plaintext highlighter-rouge">SysOperateLog0</code>中的id和其他表中的id是不冲突的,也就是说是没有全局主键约束的.为了id不重复,可以采用uuid序列来自动生成.</p>

<ul>
  <li>
    <p>设置id字段默认值</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lter</span> <span class="k">table</span> <span class="nv">"SysOperateLog0"</span> <span class="k">alter</span> <span class="k">column</span> <span class="nv">"id"</span> <span class="k">set</span> <span class="k">default</span> <span class="k">replace</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">uuid_generate_v4</span><span class="p">()</span> <span class="k">as</span> <span class="nb">VARCHAR</span><span class="p">),</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
<span class="k">alter</span> <span class="k">table</span> <span class="nv">"SysOperateLog1"</span> <span class="k">alter</span> <span class="k">column</span> <span class="nv">"id"</span> <span class="k">set</span> <span class="k">default</span> <span class="k">replace</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">uuid_generate_v4</span><span class="p">()</span> <span class="k">as</span> <span class="nb">VARCHAR</span><span class="p">),</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
<span class="k">alter</span> <span class="k">table</span> <span class="nv">"SysOperateLog2"</span> <span class="k">alter</span> <span class="k">column</span> <span class="nv">"id"</span> <span class="k">set</span> <span class="k">default</span> <span class="k">replace</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="n">uuid_generate_v4</span><span class="p">()</span> <span class="k">as</span> <span class="nb">VARCHAR</span><span class="p">),</span> <span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>如果不放心可以创建数据进行测试</p>

<ul>
  <li>
    <p>插入测试数据100W</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"SysOperateLog"</span><span class="p">(</span><span class="nv">"account"</span><span class="p">,</span><span class="nv">"operate"</span><span class="p">,</span><span class="nv">"tableName"</span><span class="p">,</span><span class="nv">"sql"</span><span class="p">,</span><span class="n">args</span><span class="p">)</span> <span class="k">SELECT</span>  <span class="n">n</span> <span class="o">||</span> <span class="s1">'_username'</span><span class="p">,</span><span class="k">mod</span><span class="p">(</span><span class="k">cast</span><span class="p">(</span><span class="k">extract</span><span class="p">(</span><span class="n">epoch</span> <span class="k">from</span> <span class="n">now</span><span class="p">())</span> <span class="k">as</span> <span class="nb">bigint</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span><span class="s1">'table'</span><span class="p">,</span><span class="s1">'sql'</span><span class="p">,</span><span class="s1">'args'</span> <span class="k">FROM</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">)</span> <span class="n">n</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>经测试,是保证了id的唯一性的.</p>

<h1 id="三结束">三、结束</h1>

