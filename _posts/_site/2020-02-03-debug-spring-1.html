<h1 id="一前言">一、前言</h1>

<p>​	在这个春回大地万物复苏的日子,在家里带着口罩,手持消毒液.分析spring是最好消磨时间的方式.不知道在这段时间里面,能否把IOC这个分析完.</p>

<p>​	<code class="language-plaintext highlighter-rouge">Resource</code> 这个接口抽象了资源的获取方式, spring 启动往往都是从这一步开始.</p>

<h1 id="二从那几句代码开始">二、从那几句代码开始</h1>

<ul>
  <li>简单的java bean</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.sjr.test.bean</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTestBean</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="s">"test--one"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTestStr</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">testStr</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">MyTestBean</span> <span class="nf">setTestStr</span><span class="o">(</span><span class="nc">String</span> <span class="n">testStr</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">testStr</span> <span class="o">=</span> <span class="n">testStr</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>一个xml文件</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN" "https://www.springframework.org/dtd/spring-beans-2.0.dtd"&gt;</span>

<span class="nt">&lt;beans&gt;</span>
	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myTestBean"</span> <span class="na">class=</span><span class="s">"com.sjr.test.bean.MyTestBean"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>

</code></pre></div></div>

<ul>
  <li>一段test 代码</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.sjr.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sjr.test.bean.MyTestBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.xml.XmlBeanFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.ClassPathResource</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSpringBean</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringLoadXml</span><span class="o">(){</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>一个输出结果</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test--one
</code></pre></div></div>

<p>​	可以看到spring从xml读取到了配置信息,并且符合预期的获取了bean.那么spring是如何加载xml的?在创建XmlBeanFactory的时候,构造方法接收的是一个Resource对象,Resource是个接口,这里直接使用的它的实现类ClassPathResource.</p>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/ClassPathResource.png" alt="images" /></p>

<h2 id="21-resource-接口">2.1 Resource 接口</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Resource</span> <span class="kd">extends</span> <span class="nc">InputStreamSource</span> <span class="o">{</span>

	<span class="cm">/*
	* 判断资源是否存在
	**/</span>
	<span class="kt">boolean</span> <span class="nf">exists</span><span class="o">();</span>

	<span class="cm">/**
	 * 判断资源是否可读,默认方法JAVA8 新特性
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isReadable</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">exists</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 判断文件是否被打开,默认方法JAVA8 新特性
	 * 默认返回 false
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isOpen</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 判断资源是否是文件,默认方法JAVA8 新特性
	 * 默认返回 false
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isFile</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取资源URL 对象
	 */</span>
	<span class="no">URL</span> <span class="nf">getURL</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * 获取资源 URI 对象
	 */</span>
	<span class="no">URI</span> <span class="nf">getURI</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * 获取资源文件对象
	 */</span>
	<span class="nc">File</span> <span class="nf">getFile</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * 获取资源 Channel 对象 NIO
	 */</span>
	<span class="k">default</span> <span class="nc">ReadableByteChannel</span> <span class="nf">readableChannel</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="n">getInputStream</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取资源长度
	 */</span>
	<span class="kt">long</span> <span class="nf">contentLength</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * 获取资源最后修改时间
	 */</span>
	<span class="kt">long</span> <span class="nf">lastModified</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * 创建资源相对路径
	 */</span>
	<span class="nc">Resource</span> <span class="nf">createRelative</span><span class="o">(</span><span class="nc">String</span> <span class="n">relativePath</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * 获取资源文件名
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="nc">String</span> <span class="nf">getFilename</span><span class="o">();</span>

	<span class="cm">/**
	 * 获取资源描述信息
	 */</span>
	<span class="nc">String</span> <span class="nf">getDescription</span><span class="o">();</span>

<span class="o">}</span>

</code></pre></div></div>

<p>Resource 接口相当于对资源的一种抽象,不管是什么 xml 也好,字节流也好等,统一抽象,由不同的子类分别去实现.</p>

<h2 id="22-xmlbeanfactory">2.2 XmlBeanFactory</h2>

<ul>
  <li>回到问题本身,XmlBeanFactory是怎么加载xml的?</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XmlBeanFactory</span> <span class="kd">extends</span> <span class="nc">DefaultListableBeanFactory</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">XmlBeanDefinitionReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>


	<span class="kd">public</span> <span class="nf">XmlBeanFactory</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">XmlBeanFactory</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">parentBeanFactory</span><span class="o">);</span>
    <span class="c1">// 从这里开始,加载xml </span>
		<span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span> <span class="c1">// A</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>从<code class="language-plaintext highlighter-rouge">A</code> 处XmlBeanFactory,委托<code class="language-plaintext highlighter-rouge">XmlBeanDefinitionReader</code>进行加载xml.跟踪进去看看.</p>

<h2 id="23-xmlbeandefinitionreader">2.3 XmlBeanDefinitionReader</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// 把classPathsResource转换为EncodedResource,默认字符编码为空</span>
		<span class="k">return</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="k">new</span> <span class="nc">EncodedResource</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
	<span class="o">}</span>


	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">EncodedResource</span> <span class="n">encodedResource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// 加载资源,资源不能为空</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">,</span> <span class="s">"EncodedResource must not be null"</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Loading XML bean definitions from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// 判断当前线程是否加载过资源,如果没有则创建一个set来保存encodedResource</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">EncodedResource</span><span class="o">&gt;</span> <span class="n">currentResources</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">currentResources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">currentResources</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// 判断是否有已近添加过相同的encodedResource</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">currentResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
					<span class="s">"Detected cyclic loading of "</span> <span class="o">+</span> <span class="n">encodedResource</span> <span class="o">+</span> <span class="s">" - check your import definitions!"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 获取xml文件流</span>
			<span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="nc">InputSource</span> <span class="n">inputSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
				<span class="c1">// 如果编码不为空,则设置文件编码</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">inputSource</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">());</span>
				<span class="o">}</span>
				<span class="c1">// 加载bean</span>
				<span class="k">return</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">finally</span> <span class="o">{</span>
				<span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
					<span class="s">"IOException parsing XML document from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">finally</span> <span class="o">{</span>
			<span class="n">currentResources</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>从<code class="language-plaintext highlighter-rouge">XmlBeanDefinitionReader</code>代码逻辑可以看出:</p>

<ol>
  <li>把 <code class="language-plaintext highlighter-rouge">Resource</code> 对象转换为 <code class="language-plaintext highlighter-rouge">EncodedResource</code>对象</li>
  <li>判断 xml 资源是否被加载过,如果被加载过 抛出异常 <code class="language-plaintext highlighter-rouge">BeanDefinitionStoreException</code></li>
  <li>xml 资源放入缓存</li>
  <li>获取资源流</li>
  <li>读取文件</li>
  <li>关闭文件流</li>
</ol>

<p>emmm,那么<code class="language-plaintext highlighter-rouge">EncodedResource</code> 对象是个什么玩意儿呢?? 跟踪进去看看.</p>

<h2 id="24-encodedresource">2.4 EncodedResource</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncodedResource</span> <span class="kd">implements</span> <span class="nc">InputStreamSource</span> <span class="o">{</span>
	<span class="c1">// 资源对象</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">;</span>
	<span class="c1">// 编码</span>
	<span class="nd">@Nullable</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">encoding</span><span class="o">;</span>
	<span class="c1">// 字符集</span>
	<span class="nd">@Nullable</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">;</span>


	<span class="kd">public</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">encoding</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">encoding</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">charset</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">encoding</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="s">"Resource must not be null"</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">charset</span> <span class="o">=</span> <span class="n">charset</span><span class="o">;</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * 返回资源对象
	 */</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="nc">Resource</span> <span class="nf">getResource</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取编码
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">getEncoding</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">encoding</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
   * 获取字符集
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="nc">Charset</span> <span class="nf">getCharset</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">charset</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 如果编码 和 字符集 不为空
	 * 则需要reader对象
	 */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">requiresReader</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">charset</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取 Reader 对象
	 */</span>
	<span class="kd">public</span> <span class="nc">Reader</span> <span class="nf">getReader</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">charset</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">charset</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">encoding</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取流对象
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
	<span class="o">}</span>


	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">EncodedResource</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">EncodedResource</span> <span class="n">otherResource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">EncodedResource</span><span class="o">)</span> <span class="n">other</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">otherResource</span><span class="o">.</span><span class="na">resource</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
				<span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">nullSafeEquals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">charset</span><span class="o">,</span> <span class="n">otherResource</span><span class="o">.</span><span class="na">charset</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
				<span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">nullSafeEquals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encoding</span><span class="o">,</span> <span class="n">otherResource</span><span class="o">.</span><span class="na">encoding</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>​	<code class="language-plaintext highlighter-rouge">EncodedResource</code>内部的逻辑很简单,并未做什么特殊操作,看来<code class="language-plaintext highlighter-rouge">EncodedResource</code>只是加了几个工具方法而已,比如获取<code class="language-plaintext highlighter-rouge">Reader</code>.</p>

<p>​	那么接下的重点就是,如何获取xml文件的.上面代码中的<code class="language-plaintext highlighter-rouge">Resource</code>对象的实现类是<code class="language-plaintext highlighter-rouge">ClassPathResource</code>,获取文件流的代码如下.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">InputStream</span> <span class="n">is</span><span class="o">;</span>
    <span class="c1">// 如果指定的 class 对象不为空</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 获取流对象</span>
			<span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">clazz</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
		<span class="o">}</span>
    <span class="c1">// 如果指定的 classLoader 对象不为空</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 获取流对象</span>
			<span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">classLoader</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
      <span class="c1">// 获取流对象</span>
			<span class="n">is</span> <span class="o">=</span> <span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemResourceAsStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
		<span class="o">}</span>
    <span class="c1">// 流对象为空 抛出异常 FileNotFoundException</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">is</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">FileNotFoundException</span><span class="o">(</span><span class="n">getDescription</span><span class="o">()</span> <span class="o">+</span> <span class="s">" cannot be opened because it does not exist"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">is</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<h1 id="三resource-体系">三、Resource 体系</h1>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/resource.png" alt="images" /></p>

<ul>
  <li>
    <p>FileSystemResource</p>

    <p>​	对 <code class="language-plaintext highlighter-rouge">java.io.File</code> 类型资源的封装，只要是跟 File 打交道的，基本上与 FileSystemResource 也可以打交道。</p>
  </li>
  <li>
    <p>ByteArrayResource</p>

    <p>​	对字节数组提供的数据的封装。如果通过 InputStream 形式访问该类型的资源，该实现会根据字节数组的数据构造一个相应的 ByteArrayInputStream。</p>
  </li>
  <li>
    <p>UrlResource</p>

    <p>​	对<code class="language-plaintext highlighter-rouge">java.net.URL</code>类型资源的封装。内部委派 URL 进行具体的资源操作。</p>
  </li>
  <li>
    <p>ClassPathResource</p>

    <p>​	class path 类型资源的实现。使用给定的 ClassLoader 或者给定的 Class 来加载资源。</p>
  </li>
  <li>
    <p>InputStreamResource</p>

    <p>​	将给定的 InputStream 作为一种资源的 Resource 的实现类。</p>
  </li>
  <li>
    <p>VfsResource</p>

    <p>​	VfsResource代表Jboss 虚拟文件系统资源。</p>
  </li>
</ul>

<p>以上6种常用的 <code class="language-plaintext highlighter-rouge">Resource</code> 对象,当然spring 里面可不止这6中 <code class="language-plaintext highlighter-rouge">Resource</code> 实现类.</p>

<h1 id="四思考">四、思考</h1>

<p>​	在 spring 配置文件中,有些资源可能不是从 classPath 获取,可能是从网络获取等,那么 spring 是怎么知道要用那种方式进行资源加载的呢？</p>

<p>​	也许跟 <code class="language-plaintext highlighter-rouge">ResourceLoader</code> 这个有关.</p>

