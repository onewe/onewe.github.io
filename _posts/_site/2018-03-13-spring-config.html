<h1 id="前言">前言</h1>
<blockquote>
  <p>前几天遇到一个需求,那就是mq队列的名称要跟本机的ip地址相关,由于用的是spring的stream模块来进行连接mq的,所以不能通过代码来指定队列的名称(只是我不知道怎么通过代码指定而已…逃),这可把我急坏了,因为队列名称是通过yml配置文件来的,于是我就想能不能再配置文件上面做点文章.</p>
</blockquote>

<h1 id="查资料">查资料</h1>
<p>通过查询spring的yml相关资料,找到了生成随机数和uuid的办法(虽然之前我都知道了,无奈),显然是不符合我们需求的,在看spring官方文档的过程中,发现yml是可以读取环境变量的.这感觉不错,但是服务器上面有关于本机ip地址的环境变量吗??有没有我是不知道的.于是产生了手动设置环境变量的想法.</p>

<h1 id="实现思路">实现思路</h1>
<p>只要在spring读取配置文件之前,把环境变量设置好就可以了.</p>

<h1 id="实现思路-1">实现思路</h1>
<p>代码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
	    <span class="c1">//获取本地ip地址</span>
        <span class="nc">InetAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="n">getAddress</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">address</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//设置环境变量</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"local.ip"</span><span class="o">,</span><span class="s">"127.0.0.1"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="c1">//设置环境变量</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"local.ip"</span><span class="o">,</span><span class="n">address</span><span class="o">.</span><span class="na">getHostAddress</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">StreamApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
<span class="c1">//获取本机ip地址	</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">InetAddress</span> <span class="nf">getAddress</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Enumeration</span><span class="o">&lt;</span><span class="nc">NetworkInterface</span><span class="o">&gt;</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="nc">NetworkInterface</span><span class="o">.</span><span class="na">getNetworkInterfaces</span><span class="o">();</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">();)</span> <span class="o">{</span>
                <span class="nc">NetworkInterface</span> <span class="n">networkInterface</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">networkInterface</span><span class="o">.</span><span class="na">isLoopback</span><span class="o">()</span> <span class="o">||</span> <span class="n">networkInterface</span><span class="o">.</span><span class="na">isVirtual</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">networkInterface</span><span class="o">.</span><span class="na">isUp</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="nc">InetAddress</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">networkInterface</span><span class="o">.</span><span class="na">getInetAddresses</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">addresses</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">addresses</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SocketException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>	
	
</code></pre></div></div>
<p>yml配置如下</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">zzwtec-stream</span>
  <span class="na">cloud</span><span class="pi">:</span>
    <span class="na">stream</span><span class="pi">:</span>
      <span class="na">bindings</span><span class="pi">:</span>
        <span class="na">log_data_channel</span><span class="pi">:</span>
          <span class="na">destination</span><span class="pi">:</span> <span class="s">mq_sys_log_data</span>
          <span class="na">contentType</span><span class="pi">:</span> <span class="s">application/json</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s">sysLogData</span>
        <span class="na">log_status_channel</span><span class="pi">:</span>
          <span class="na">destination</span><span class="pi">:</span> <span class="s">mq_sys_log_data</span>
          <span class="na">contentType</span><span class="pi">:</span> <span class="s">application/json</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s">${local.ip}</span> <span class="c1">#获取名称为local.ip的环境变量</span>
        <span class="na">data_into_redis_channel</span><span class="pi">:</span>
          <span class="na">destination</span><span class="pi">:</span> <span class="s">mq_stream_data</span>
          <span class="na">contentType</span><span class="pi">:</span> <span class="s">application/json</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s">streamIntoRedis</span>
        <span class="na">data_into_database_channel</span><span class="pi">:</span>
          <span class="na">destination</span><span class="pi">:</span> <span class="s">mq_stream_data</span>
          <span class="na">contentType</span><span class="pi">:</span> <span class="s">application/json</span>
          <span class="na">group</span><span class="pi">:</span> <span class="s">streamIntoDatabase</span>

</code></pre></div></div>

<h1 id="总结">总结</h1>
<p>通过以上的方式yml就可以获取本地ip地址了,哎,还是对spring这个框架不太熟悉呀,之前我居然不知道还可以读取环境变量.emmmmmmm还要多学学,不然跟不上历史的进程.</p>
