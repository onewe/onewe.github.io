<h1 id="一前言">一、前言</h1>

<p>​	经过前面的一顿折腾,终于要到了扯开遮羞布的时候了.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringLoadXml</span><span class="o">(){</span>
    <span class="c1">// A</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
    <span class="c1">// B</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>​	前面记录了A这个过程,整个过程总结为:</p>

<ol>
  <li>加载xml文件</li>
  <li>解析xml文件</li>
  <li>选用合适的handler解析标签</li>
  <li>创建bean的定义</li>
  <li>注册bean定义</li>
</ol>

<p>​	那么后面B这一步就是比较重要的一步.</p>

<h1 id="二分析">二、分析</h1>

<p>​	从<code class="language-plaintext highlighter-rouge">MyTestBean testBean = factory.getBean("myTestBean",MyTestBean.class);</code>这句代码开始吧,进去看看里面是啥妖魔鬼怪.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">getBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">doGetBean</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">doGetBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="o">,</span>
			<span class="nd">@Nullable</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">typeCheckOnly</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

		<span class="c1">// 提取 bean name,bean name 可能不是单纯的名称也可能是工厂的名称</span>
		<span class="c1">// 例如 &amp;bean 就代表从名称为bean的工厂中获取 bean</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
		<span class="nc">Object</span> <span class="n">bean</span><span class="o">;</span>

		<span class="c1">// Eagerly check singleton cache for manually registered singletons.</span>
		<span class="c1">// 通过单利工厂获取 bean</span>
		<span class="nc">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning eagerly cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
							<span class="s">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// 如果为原型模式,存在循环依赖则报错</span>
			<span class="c1">// Fail if we're already creating this bean instance:</span>
			<span class="c1">// We're assumably within a circular reference.</span>
			<span class="c1">// 如果是原型模式则不解决循环依赖问题,直接抛出异常</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isPrototypeCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// 获取父bean工厂</span>
			<span class="c1">// Check if bean definition exists in this factory.</span>
			<span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
			<span class="c1">// 通过递归父工厂获取bean对象</span>
			<span class="c1">// 如果无bean定义并且还要加载这个bean 说明这个bean已经被加载过了</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// Not found -&gt; check parent.</span>
				<span class="nc">String</span> <span class="n">nameToLookup</span> <span class="o">=</span> <span class="n">originalBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">((</span><span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">).</span><span class="na">doGetBean</span><span class="o">(</span>
							<span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">typeCheckOnly</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Delegation to parent with explicit args.</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// No args -&gt; delegate to standard getBean method.</span>
					<span class="k">return</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="c1">//记录 bean 正在创建中</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">typeCheckOnly</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">markBeanAsCreated</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>

			<span class="k">try</span> <span class="o">{</span>
				<span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="n">checkMergedBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

				<span class="c1">// Guarantee initialization of beans that the current bean depends on.</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="c1">//依赖注册</span>
						<span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">//获取bean,循环获取依赖</span>
							<span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"'"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' depends on missing bean '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>

				<span class="c1">// 创建bean实例</span>
				<span class="c1">// Create bean instance.</span>
				<span class="c1">// 单利模式</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
							<span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">});</span>
					<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="c1">// 原型模式</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isPrototype</span><span class="o">())</span> <span class="o">{</span>
					<span class="c1">// It's a prototype -&gt; create a new instance.</span>
					<span class="nc">Object</span> <span class="n">prototypeInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="c1">// 前置处理</span>
						<span class="n">beforePrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
						<span class="c1">// 创建bean</span>
						<span class="n">prototypeInstance</span> <span class="o">=</span> <span class="n">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">finally</span> <span class="o">{</span>
						<span class="c1">// 后置处理</span>
						<span class="n">afterPrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">prototypeInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="k">else</span> <span class="o">{</span>
					<span class="c1">// 其他作用域</span>
					<span class="nc">String</span> <span class="n">scopeName</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getScope</span><span class="o">();</span>
					<span class="kd">final</span> <span class="nc">Scope</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scopes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">scopeName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">scope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"No Scope registered for scope name '"</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="nc">Object</span> <span class="n">scopedInstance</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
							<span class="c1">// 前置处理</span>
							<span class="n">beforePrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">try</span> <span class="o">{</span>
								<span class="c1">// 创建 bean</span>
								<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">finally</span> <span class="o">{</span>
								<span class="c1">// 后置处理</span>
								<span class="n">afterPrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">});</span>
						<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">scopedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
								<span class="s">"Scope '"</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">"' is not active for the current thread; consider "</span> <span class="o">+</span>
								<span class="s">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="o">,</span>
								<span class="n">ex</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">cleanupAfterBeanCreationFailure</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">//类型转换</span>
		<span class="c1">// Check if required type matches the type of the actual bean instance.</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">requiredType</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">bean</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="no">T</span> <span class="n">convertedBean</span> <span class="o">=</span> <span class="n">getTypeConverter</span><span class="o">().</span><span class="na">convertIfNecessary</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">convertedBean</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanNotOfRequiredTypeException</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">convertedBean</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">TypeMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Failed to convert bean '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"' to required type '"</span> <span class="o">+</span>
							<span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(</span><span class="n">requiredType</span><span class="o">)</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanNotOfRequiredTypeException</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>​	代码很长,看起来比较费劲.拆分来看看。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="c1">// 提取 bean name,bean name 可能不是单纯的名称也可能是工厂的名称</span>
		<span class="c1">// 例如 &amp;bean 就代表从名称为bean的工厂中获取 bean</span>
<span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
		<span class="nc">Object</span> <span class="n">bean</span><span class="o">;</span>

		<span class="c1">// Eagerly check singleton cache for manually registered singletons.</span>
		<span class="c1">// 通过单利工厂获取 bean</span>
		<span class="nc">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning eagerly cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
							<span class="s">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Returning cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
		<span class="o">}</span>

</code></pre></div></div>

<ol>
  <li>获取bean的真实名称</li>
  <li>获取bean</li>
</ol>

<p>​	这部分分成3句代码</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">String beanName = transformedBeanName(name);</code></li>
  <li><code class="language-plaintext highlighter-rouge">Object sharedInstance = getSingleton(beanName);</code></li>
  <li><code class="language-plaintext highlighter-rouge">bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);</code></li>
</ol>

<h2 id="21-transformedbeanname">2.1 transformedBeanName</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">protected</span> <span class="nc">String</span> <span class="nf">transformedBeanName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">canonicalName</span><span class="o">(</span><span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
	<span class="o">}</span>
<span class="c1">// BeanFactoryUtils</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">transformedBeanName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"'name' must not be null"</span><span class="o">);</span>
		<span class="c1">// 判断是否是以&amp; 开头的名称</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">FACTORY_BEAN_PREFIX</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">name</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// 名称-&gt;真实名称 放入换成中</span>
		<span class="c1">// 不停的循环截取&amp;后面的部分,直到不以&amp;开头为止</span>
		<span class="k">return</span> <span class="n">transformedBeanNameCache</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">beanName</span> <span class="o">-&gt;</span> <span class="o">{</span>
			<span class="k">do</span> <span class="o">{</span>
				<span class="n">beanName</span> <span class="o">=</span> <span class="n">beanName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">FACTORY_BEAN_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">beanName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">FACTORY_BEAN_PREFIX</span><span class="o">));</span>
			<span class="k">return</span> <span class="n">beanName</span><span class="o">;</span>
		<span class="o">});</span>
	<span class="o">}</span>
<span class="c1">// AbstractBeanFactory</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">canonicalName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">canonicalName</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="c1">// Handle aliasing...</span>
		<span class="nc">String</span> <span class="n">resolvedName</span><span class="o">;</span>
		<span class="c1">// 判断bean的名称是否是别名</span>
		<span class="c1">// 一直循环 跟着别名的引用链走</span>
		<span class="c1">// 直到非别名为止</span>
		<span class="c1">// 例如 A-B-C-D-E-F</span>
		<span class="c1">// 从A找到F</span>
		<span class="k">do</span> <span class="o">{</span>
			<span class="n">resolvedName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">canonicalName</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resolvedName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">canonicalName</span> <span class="o">=</span> <span class="n">resolvedName</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">resolvedName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">canonicalName</span><span class="o">;</span>
	<span class="o">}</span>

</code></pre></div></div>

<ol>
  <li>先判断是否是以&amp;开头,这个符号代表着引用的意思,在c/c++里面估计会很熟悉.</li>
  <li>判断是否是别名</li>
  <li>返回最终确定下来的bean名称</li>
</ol>

<h2 id="22--符号的作用">2.2 &amp; 符号的作用</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTestFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">MyTestBean</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">MyTestBean</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">MyTestBean</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"ISO-8859-1"</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span> <span class="n">xmlns</span><span class="o">=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	   <span class="nl">xmlns:</span><span class="n">xsi</span><span class="o">=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	   <span class="nl">xsi:</span><span class="n">schemaLocation</span><span class="o">=</span><span class="s">"http://www.springframework.org/schema/beans
                       https://www.springframework.org/schema/beans/spring-beans-3.0.xsd"</span><span class="o">&gt;</span>
	<span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">"myTestBeanFactory"</span> <span class="kd">class</span><span class="err">="</span><span class="nc">com</span><span class="o">.</span><span class="na">sjr</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">bean</span><span class="o">.</span><span class="na">MyTestFactoryBean</span><span class="err">"</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSpringFactoryBean</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFactoryBean</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBeanFactory.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBeanFactory"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
		<span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean1</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"&amp;myTestBeanFactory"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean1</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>最后结果输出为:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">com.sjr.test.bean.MyTestBean</span>
<span class="err">com.sjr.test.bean.MyTestFactoryBean</span>
</code></pre></div></div>

<p>​	从结果上来应该秒懂吧,如果一<code class="language-plaintext highlighter-rouge">FactoryBean</code>对象在spring创建的时候会判断bean名称,如果bean名称中不带有&amp;符号,说明是要获取<code class="language-plaintext highlighter-rouge">FactoryBean</code>所产生的对象,如果带有&amp;符号,则说明需要获取<code class="language-plaintext highlighter-rouge">FactoryBean</code>对象本身.</p>

<h2 id="22-getsingleton">2.2 getSingleton</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultSingletonBeanRegistry</span>
<span class="nd">@Override</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
	<span class="o">}</span>

<span class="nd">@Nullable</span>
	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowEarlyReference</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 缓存中是否有创建好的bean</span>
		<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="c1">// 缓存中无指定的bean并且该bean未在创建中</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// 加锁 </span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 指定的bean是否在创建中</span>
				<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="c1">// 非创建中,并且允许提前引用</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">allowEarlyReference</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 获取单利工厂</span>
					<span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">singletonFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// 调用工厂创建对象</span>
						<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
						<span class="c1">// 把创建好的对象放入到正在创建的集合中去</span>
						<span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
						<span class="c1">// 移除单利工厂</span>
						<span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>​	逻辑比较简单,这里有几个map 比较重要:</p>

<ol>
  <li>singletonObjects 用于保存BeanName和创建bean实例之间的关系 beanName-&gt;bean</li>
  <li>earlySingletonObjects 用于保存BeanName和创建bean实例之间的关系 beanName-&gt;bean,不同点是,当bean放入到此集合中时,在bean创建的过程中就可以通 过getBean方法来获取bean的引用,主要是用于解决循环依赖问题.</li>
  <li>singletonFactories:用于保存beanName与bean工厂之间的关系</li>
  <li>registeredSingletons:用来保存当前所有已注册的bean</li>
</ol>

<p>​	如果bean名称是工厂的名称,那么这里已经完成了bean的创建了,但仅仅是创建完成还是不够,spring还要插上一脚进行管理.</p>

<h2 id="23-getobjectforbeaninstance">2.3 getObjectForBeanInstance</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getObjectForBeanInstance</span><span class="o">(</span>
			<span class="nc">Object</span> <span class="n">beanInstance</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>

		<span class="c1">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span>
		<span class="c1">// 检查bean名称是否符合bean工厂的命名规范,如果名称是工厂的格式,则获取的bean为工厂实例</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">isFactoryDereference</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// 符合规范但是个null</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">beanInstance</span> <span class="k">instanceof</span> <span class="nc">NullBean</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="c1">// 符合规范但不是factory,异常</span>
			<span class="k">if</span> <span class="o">(!(</span><span class="n">beanInstance</span> <span class="k">instanceof</span> <span class="nc">FactoryBean</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanIsNotAFactoryException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanInstance</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="c1">// 如果bean定义不为空,设置为true表明是个工厂bean</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mbd</span><span class="o">.</span><span class="na">isFactoryBean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span>
		<span class="c1">// If it's a FactoryBean, we use it to create a bean instance, unless the</span>
		<span class="c1">// caller actually wants a reference to the factory.</span>
		<span class="c1">// 如果bean实例为非工厂,直接返回</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">beanInstance</span> <span class="k">instanceof</span> <span class="nc">FactoryBean</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// 后面的逻辑是bean是工厂,而名称则不是工厂的解引用格式</span>
		<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mbd</span><span class="o">.</span><span class="na">isFactoryBean</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// 从缓存中获取对象对应的工厂bean</span>
			<span class="n">object</span> <span class="o">=</span> <span class="n">getCachedObjectForFactoryBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Return bean instance from factory.</span>
			<span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">beanInstance</span><span class="o">;</span>
			<span class="c1">// Caches object obtained from FactoryBean if it is a singleton.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="kt">boolean</span> <span class="n">synthetic</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">());</span>
			<span class="n">object</span> <span class="o">=</span> <span class="n">getObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="o">!</span><span class="n">synthetic</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>如果bean的名称以&amp; 开头并且是<code class="language-plaintext highlighter-rouge">FactoryBean</code>子类,直接返回工厂对象</li>
  <li>如果bean的名称非以&amp;开头并且非<code class="language-plaintext highlighter-rouge">FactoryBean</code>子类直接返回对象</li>
  <li>如果bean的名称非以&amp;开头并且是<code class="language-plaintext highlighter-rouge">FactoryBean</code>子类调用<code class="language-plaintext highlighter-rouge">FactoryBean</code>的getObject方法获取对象</li>
</ol>

<p>以上代码中的核心代码有三处:</p>

<ol>
  <li>getCachedObjectForFactoryBean()</li>
  <li>getMergedLocalBeanDefinition()</li>
  <li>getObjectFromFactoryBean()</li>
</ol>

<h2 id="24-getcachedobjectforfactorybean">2.4 getCachedObjectForFactoryBean</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nullable</span>
	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getCachedObjectForFactoryBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>​	代码很简单,就是根据beanName在换成中获取对应的bean</p>

<h2 id="25-getmergedlocalbeandefinition">2.5 getMergedLocalBeanDefinition</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">protected</span> <span class="nc">RootBeanDefinition</span> <span class="nf">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="c1">// Quick check on the concurrent map first, with minimal locking.</span>
		<span class="c1">// 从缓存中获取</span>
		<span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">stale</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">mbd</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
	<span class="o">}</span>
<span class="kd">protected</span> <span class="nc">RootBeanDefinition</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">bd</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

		<span class="k">return</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bd</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

<span class="kd">protected</span> <span class="nc">RootBeanDefinition</span> <span class="nf">getMergedBeanDefinition</span><span class="o">(</span>
			<span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">bd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">BeanDefinition</span> <span class="n">containingBd</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// 加锁,并发控制</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="nc">RootBeanDefinition</span> <span class="n">previous</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

			<span class="c1">// Check with full lock now in order to enforce the same merged instance.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">containingBd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 如果为空 从缓存中获取</span>
				<span class="n">mbd</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			
			
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">mbd</span><span class="o">.</span><span class="na">stale</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">previous</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">;</span>
				<span class="c1">// 判断是否具有父子关系</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getParentName</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Use copy of given root bean definition.</span>
					<span class="c1">// 判断类型是否是 RootBeanDefinition</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">bd</span> <span class="k">instanceof</span> <span class="nc">RootBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// copy一个</span>
						<span class="n">mbd</span> <span class="o">=</span> <span class="o">((</span><span class="nc">RootBeanDefinition</span><span class="o">)</span> <span class="n">bd</span><span class="o">).</span><span class="na">cloneBeanDefinition</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="c1">// 转换为 RootBeanDefinition</span>
						<span class="n">mbd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">bd</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="c1">// Child bean definition: needs to be merged with parent.</span>
					<span class="nc">BeanDefinition</span> <span class="n">pbd</span><span class="o">;</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="c1">// 获取 父bean 名称</span>
						<span class="nc">String</span> <span class="n">parentBeanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getParentName</span><span class="o">());</span>
						<span class="c1">// 判断父与子的bean 名称是否相同</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">))</span> <span class="o">{</span>
							<span class="c1">// 如果不相同,则顺则 父子关系 一路递归上去</span>
							<span class="c1">// 全部转换为 RootBeanDefinition</span>
							<span class="n">pbd</span> <span class="o">=</span> <span class="n">getMergedBeanDefinition</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">else</span> <span class="o">{</span>
							<span class="c1">// 和上面代码逻辑相同 只是类型不一样</span>
							<span class="nc">BeanFactory</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="k">instanceof</span> <span class="nc">ConfigurableBeanFactory</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">pbd</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurableBeanFactory</span><span class="o">)</span> <span class="n">parent</span><span class="o">).</span><span class="na">getMergedBeanDefinition</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">else</span> <span class="o">{</span>
								<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchBeanDefinitionException</span><span class="o">(</span><span class="n">parentBeanName</span><span class="o">,</span>
										<span class="s">"Parent name '"</span> <span class="o">+</span> <span class="n">parentBeanName</span> <span class="o">+</span> <span class="s">"' is equal to bean name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
										<span class="s">"': cannot be resolved without an AbstractBeanFactory parent"</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
								<span class="s">"Could not resolve parent bean definition '"</span> <span class="o">+</span> <span class="n">bd</span><span class="o">.</span><span class="na">getParentName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="c1">// Deep copy with overridden values.</span>
					<span class="c1">// 深拷贝 转换为RootBeanDefinition</span>
					<span class="n">mbd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">pbd</span><span class="o">);</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">overrideFrom</span><span class="o">(</span><span class="n">bd</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="c1">// Set default singleton scope, if not configured before.</span>
				<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getScope</span><span class="o">()))</span> <span class="o">{</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="no">SCOPE_SINGLETON</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="c1">// A bean contained in a non-singleton bean cannot be a singleton itself.</span>
				<span class="c1">// Let's correct this on the fly here, since this might be the result of</span>
				<span class="c1">// parent-child merging for the outer bean, in which case the original inner bean</span>
				<span class="c1">// definition will not have inherited the merged outer bean's singleton status.</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">containingBd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containingBd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">containingBd</span><span class="o">.</span><span class="na">getScope</span><span class="o">());</span>
				<span class="o">}</span>

				<span class="c1">// Cache the merged bean definition for the time being</span>
				<span class="c1">// (it might still get re-merged later on in order to pick up metadata changes)</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">containingBd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isCacheBeanMetadata</span><span class="o">())</span> <span class="o">{</span>
					<span class="c1">// 加入缓存</span>
					<span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">previous</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">copyRelevantMergedBeanDefinitionCaches</span><span class="o">(</span><span class="n">previous</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">mbd</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>​	说这代码之前,先说说spring中的基本数据结构.在spring中基本数据结构为<code class="language-plaintext highlighter-rouge">BeanDefinition</code>,通过spring产生的普通bean为<code class="language-plaintext highlighter-rouge">GenericBeanDefinition</code>.而spring后续处理的类型则为<code class="language-plaintext highlighter-rouge">RootBeanDefinition</code>.关系图如下:</p>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/BeanDefinition.png" alt="images" /></p>

<p>​	这两个长的都差不多,只不过后续处理的步骤用到的类型为<code class="language-plaintext highlighter-rouge">RootBeanDefinition</code>,所以在上面的方法中,进行递归转换.</p>

<h2 id="26-getobjectfromfactorybean">2.6 getObjectFromFactoryBean</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kt">boolean</span> <span class="n">synthetic</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">());</span>
<span class="n">object</span> <span class="o">=</span> <span class="n">getObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="o">!</span><span class="n">synthetic</span><span class="o">);</span>
</code></pre></div></div>

<p>​	这里这个<code class="language-plaintext highlighter-rouge">isSynthetic</code>方法代表是否是人造的,emma就这样理解吧.什么叫做人造的呢?意思就是不加干预通spring产生的就是非人造的,如果是后面通过代理产生的就是非人造的.</p>

<p>​	看了一下setSynthetic这个方法的调用情况,都是在aop那边调用的比较多.不知道解释的对不对哈.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// FactoryBeanRegistrySupport</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getObjectFromFactoryBean</span><span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">shouldPostProcess</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 判断工厂是否为单利工厂,并且单利对象已被创建完成</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">containsSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// 加锁</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="n">getSingletonMutex</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// 在缓存中获取通过工厂创建的bean</span>
				<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 获取bean通过工厂</span>
					<span class="n">object</span> <span class="o">=</span> <span class="n">doGetObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
					<span class="c1">// Only post-process and store if not put there already during getObject() call above</span>
					<span class="c1">// (e.g. because of circular reference processing triggered by custom getBean calls)</span>
					<span class="c1">// 再次从缓存中获取bean</span>
					<span class="nc">Object</span> <span class="n">alreadyThere</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">alreadyThere</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// 如果缓存中获取到bean,则丢弃当前创建的对象</span>
						<span class="n">object</span> <span class="o">=</span> <span class="n">alreadyThere</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="c1">// 判断是否需要post-processing</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">shouldPostProcess</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// 当前的bean是否被创建中,如果是就直接返回当前的bean不做处理</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
								<span class="c1">// Temporarily return non-post-processed object, not storing it yet..</span>
								<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
							<span class="o">}</span>
							<span class="c1">// bean创建之前,把当前bean加入正在创建中的集合中去</span>
							<span class="n">beforeSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">try</span> <span class="o">{</span>
								<span class="c1">// AOP的核心步骤</span>
								<span class="n">object</span> <span class="o">=</span> <span class="n">postProcessObjectFromFactoryBean</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
								<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
										<span class="s">"Post-processing of FactoryBean's singleton object failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">finally</span> <span class="o">{</span>
								<span class="c1">// bean创建之后,把bean从正在创建中的集合中移除</span>
								<span class="n">afterSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="o">}</span>
						<span class="o">}</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">containsSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
							<span class="c1">// 缓存bean对象</span>
							<span class="k">this</span><span class="o">.</span><span class="na">factoryBeanObjectCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">//创建对象</span>
			<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">doGetObjectFromFactoryBean</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">shouldPostProcess</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="c1">//处理bean流程</span>
					<span class="n">object</span> <span class="o">=</span> <span class="n">postProcessObjectFromFactoryBean</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Post-processing of FactoryBean's object failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">object</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>判断是否是单利工厂,并且缓存中已经创建了该bean的factoryBean</li>
  <li>判断factoryBeanObjectCache缓存中bean是否存在</li>
  <li>通过factoryBean创建bean</li>
</ol>

<p>​	以上逻辑为当有factoryBean的逻辑.</p>

<h1 id="三后半段逻辑">三、后半段逻辑</h1>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//AbstractBeanFactory</span>
			<span class="c1">// 如果为原型模式,存在循环依赖则报错</span>
			<span class="c1">// Fail if we're already creating this bean instance:</span>
			<span class="c1">// We're assumably within a circular reference.</span>
			<span class="c1">// 如果是原型模式则不解决循环依赖问题,直接抛出异常</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isPrototypeCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// 获取父bean工厂</span>
			<span class="c1">// Check if bean definition exists in this factory.</span>
			<span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
			<span class="c1">// 通过递归父工厂获取bean对象</span>
			<span class="c1">// 如果无bean定义并且还要加载这个bean 说明这个bean已经被加载过了</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// Not found -&gt; check parent.</span>
				<span class="nc">String</span> <span class="n">nameToLookup</span> <span class="o">=</span> <span class="n">originalBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">((</span><span class="nc">AbstractBeanFactory</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">).</span><span class="na">doGetBean</span><span class="o">(</span>
							<span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">typeCheckOnly</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Delegation to parent with explicit args.</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// No args -&gt; delegate to standard getBean method.</span>
					<span class="k">return</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
</code></pre></div></div>

<p>​	如果非单利模式,spring在这里不处理循环依赖问题.如果<code class="language-plaintext highlighter-rouge">BeanFactory</code>存在父子关系,则进行递归创建.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="c1">// 记录 bean 正在创建中</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">typeCheckOnly</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">markBeanAsCreated</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
<span class="c1">// 转换BeanDefinition为RootBeanDefinition</span>
<span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="c1">// 检查RootBeanDefinition是否合法</span>
				<span class="n">checkMergedBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

				<span class="c1">// Guarantee initialization of beans that the current bean depends on.</span>
				<span class="c1">// 遍历所有依赖,并进行注册、创建等过程</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="c1">// 依赖注册</span>
						<span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">// 获取bean,循环获取依赖</span>
							<span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"'"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' depends on missing bean '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>

				<span class="c1">// 创建bean实例</span>
				<span class="c1">// Create bean instance.</span>
				<span class="c1">// 单利模式</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
							<span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">});</span>
					<span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
				<span class="o">}</span>			
</code></pre></div></div>

<ol>
  <li>
    <p>标记该bean未正在创建中.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">markBeanAsCreated</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 判断是否包含beanName</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">alreadyCreated</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// 加锁并发控制</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mergedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 双重检查</span>
				<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">alreadyCreated</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="c1">// Let the bean definition get re-merged now that we're actually creating</span>
					<span class="c1">// the bean... just in case some of its metadata changed in the meantime.</span>
					<span class="n">clearMergedBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="c1">// 添加进行已经创建集合中</span>
					<span class="k">this</span><span class="o">.</span><span class="na">alreadyCreated</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>遍历依赖并进行递归创建</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="c1">//依赖注册</span>
						<span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="c1">//获取bean,循环获取依赖</span>
							<span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchBeanDefinitionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
									<span class="s">"'"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' depends on missing bean '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>​	这里的核心逻辑在于<code class="language-plaintext highlighter-rouge">getSingleton</code>这个方法里</p>

<h3 id="31-getsingleton">3.1 getSingleton</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name must not be null"</span><span class="o">);</span>
		<span class="c1">// 加锁</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 从缓存中获取 bean</span>
			<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="c1">// 如果缓存中没有</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 判断当前bean是否被标记为销毁</span>
        <span class="c1">// 相当于不能在destrory方法里面再去创建这个bean</span>
				<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonsCurrentlyInDestruction</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationNotAllowedException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
							<span class="s">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> <span class="o">+</span>
							<span class="s">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Creating shared instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="c1">// 开始创建 bean</span>
				<span class="c1">// 添加到 创建中集合中去</span>
				<span class="c1">// 前置处理</span>
				<span class="n">beforeSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="kt">boolean</span> <span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
				<span class="kt">boolean</span> <span class="n">recordSuppressedExceptions</span> <span class="o">=</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
				<span class="o">}</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="c1">// 从工厂中获取 bean</span>
					<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
					<span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Has the singleton object implicitly appeared in the meantime -&gt;</span>
					<span class="c1">// if yes, proceed with it since the exception indicates that state.</span>
					<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">for</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">suppressedException</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">ex</span><span class="o">.</span><span class="na">addRelatedCause</span><span class="o">(</span><span class="n">suppressedException</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">finally</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="c1">// 移除创建中的集合</span>
					<span class="n">afterSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">newSingleton</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 放入缓存</span>
					<span class="n">addSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>从缓存中获取bean</li>
  <li>如果换成中没有,则判断当前的bean是否被记被销毁</li>
  <li>在创建之前把beanName加入正在创建的缓存中去</li>
  <li>从单利工厂中创建bean</li>
  <li>从正在创建的换成中移除beanName</li>
  <li>把创建好的singletonObject加入缓存中</li>
</ol>

<p>值得注意的是这里的<code class="language-plaintext highlighter-rouge">singletonFactory</code>对象是通过Lambda表达传入进来的</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractBeanFactory</span>
<span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// Explicitly remove instance from singleton cache: It might have been put there</span>
							<span class="c1">// eagerly by the creation process, to allow for circular reference resolution.</span>
							<span class="c1">// Also remove any beans that received a temporary reference to the bean.</span>
							<span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
							<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">});</span>
</code></pre></div></div>

<p>这里的核心逻辑代码是<code class="language-plaintext highlighter-rouge">createBean(beanName, mbd, args)</code></p>

<h3 id="32-createbean">3.2 createBean</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractAutowireCapableBeanFactory</span>
<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">createBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="nc">RootBeanDefinition</span> <span class="n">mbdToUse</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">;</span>

		<span class="c1">// Make sure bean class is actually resolved at this point, and</span>
		<span class="c1">// clone the bean definition in case of a dynamically resolved Class</span>
		<span class="c1">// which cannot be stored in the shared merged bean definition.</span>
		<span class="c1">// 根据类名加载class对象</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolvedClass</span> <span class="o">=</span> <span class="n">resolveBeanClass</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">resolvedClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">hasBeanClass</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mbdToUse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">);</span>
			<span class="n">mbdToUse</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="n">resolvedClass</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="c1">// Prepare method overrides.</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 匹配需要覆盖的方法</span>
			<span class="n">mbdToUse</span><span class="o">.</span><span class="na">prepareMethodOverrides</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span>
					<span class="n">beanName</span><span class="o">,</span> <span class="s">"Validation of method overrides failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
			<span class="c1">// 返回一个代理对象,也可能是非代理对象</span>
			<span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">resolveBeforeInstantiation</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
					<span class="s">"BeanPostProcessor before instantiation of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 创建bean</span>
			<span class="nc">Object</span> <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">doCreateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Finished creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="o">|</span> <span class="nc">ImplicitlyAppearedSingletonException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// A previously detected exception with proper bean creation context already,</span>
			<span class="c1">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
					<span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Unexpected exception during bean creation"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>加载class</li>
  <li>判断该bean是否需要<code class="language-plaintext highlighter-rouge">InstantiationAwareBeanPostProcessor</code>进行处理,这个接口与<code class="language-plaintext highlighter-rouge">BeanPostProcessor</code>不同,主要区别是在调用时机上的区别,<code class="language-plaintext highlighter-rouge">InstantiationAwareBeanPostProcessor</code>会在对象创建前进行调用,而<code class="language-plaintext highlighter-rouge">BeanPostProcessor</code>会在对象初始化前后进行调用,这个可以从doCreateBean看出时机的差别.</li>
  <li>创建对象</li>
</ol>

<h3 id="33-docreatebean">3.3 doCreateBean</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractAutowireCapableBeanFactory</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="kd">final</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

		<span class="c1">// Instantiate the bean.</span>
		<span class="nc">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// 从缓存中获取实例wrapper,并移除它</span>
			<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// 如果没有获取到实例的wrapper,则创建一个实例</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">();</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedClass</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">!=</span> <span class="nc">NullBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">mbd</span><span class="o">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// Allow post-processors to modify the merged bean definition.</span>
		<span class="c1">// 判断是否有 后置处理器</span>
		<span class="c1">// 加锁</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessingLock</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
							<span class="s">"Post-processing of merged bean definition failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// 是否允许循环引用</span>
		<span class="c1">// Eagerly cache singletons to be able to resolve circular references</span>
		<span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
		<span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
				<span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Eagerly caching bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
						<span class="s">"' to allow for resolving potential circular references"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">addSingletonFactory</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getEarlyBeanReference</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bean</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="c1">// Initialize the bean instance.</span>
		<span class="nc">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 填充bean属性</span>
			<span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
			<span class="c1">// 初始化bean</span>
			<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="nc">BeanCreationException</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="nc">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">).</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="o">(</span><span class="nc">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
						<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Initialization of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// 循环依赖处理</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 获取单利对象</span>
			<span class="nc">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
					<span class="nc">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">dependentBeans</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dependentBean</span> <span class="o">:</span> <span class="n">dependentBeans</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
								<span class="s">"Bean with name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' has been injected into other beans ["</span> <span class="o">+</span>
								<span class="nc">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">actualDependentBeans</span><span class="o">)</span> <span class="o">+</span>
								<span class="s">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="o">+</span>
								<span class="s">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="o">+</span>
								<span class="s">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="o">+</span>
								<span class="s">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// Register bean as disposable.</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 注册销毁处理器</span>
			<span class="n">registerDisposableBeanIfNecessary</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invalid destruction signature"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>​	进过以上骚操作就完成了bean的创建,在创建的过程中还会有属性的填充,bean的初始化等.</p>

<h1 id="四小结">四、小结</h1>

<p>​	继续bean的初始化,与属性的填充.</p>
