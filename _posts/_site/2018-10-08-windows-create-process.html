<h1 id="一前言">一、前言</h1>

<p>在windows服务的设计理念中,服务就是应该在后面默默无闻的跑,不要搞什么GUI之类的,但是凡事都有但是的时候,因为有些业务程序需要像服务程序一样的运行方式,也需要拥有GUI界面.然后,后面就有个session 0 隔离了,具体我也不多讲了,我也不懂.具体的百度吧哈哈哈.</p>

<h1 id="二上代码">二、上代码</h1>

<ol>
  <li>
    <p>无GUI创建进程</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   
<span class="n">PROCESS_INFORMATION</span>					<span class="n">pi</span><span class="p">;</span>											<span class="c1">//子进程句柄</span>
<span class="n">DWORD</span>								<span class="n">returnCode</span><span class="p">;</span>									<span class="c1">//子进程返回码</span>
<span class="n">STARTUPINFO</span>							<span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
   
<span class="n">BOOL</span> <span class="nf">CreateProcessNoService</span><span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span> <span class="n">commandLine</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">log_i</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"创建进程中.....</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
	<span class="k">return</span>  <span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">commandLine</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>只要调用上面的函数就可以创建一个进程,如果不是作为服务调用创建的进程是可以创建带有GUI进程的,如果是服务调用的话就不能创建.</p>

    <ul>
      <li>注意:涉及到字符串的都要使用宽字符</li>
    </ul>
  </li>
  <li>
    <p>有GUI创建进程</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PROCESS_INFORMATION</span>					<span class="n">pi</span><span class="p">;</span>											<span class="c1">//子进程句柄</span>
<span class="n">DWORD</span>								<span class="n">returnCode</span><span class="p">;</span>									<span class="c1">//子进程返回码</span>
<span class="n">STARTUPINFO</span>							<span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
   
<span class="c1">//---------------</span>
<span class="n">HANDLE</span>								<span class="n">hToken</span><span class="p">;</span>										<span class="c1">//用户token</span>
<span class="n">HANDLE</span>								<span class="n">hTokenDup</span><span class="p">;</span>									<span class="c1">//用户token</span>
<span class="n">LPVOID</span>								<span class="n">pEnv</span><span class="p">;</span>	
   
   
   
<span class="c1">//服务环境下创建进程</span>
<span class="n">BOOL</span> <span class="nf">CreateProcessForService</span><span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span> <span class="n">commandLine</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">log_i</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"创建进程中.....</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
	<span class="n">DWORD</span> <span class="n">dwSessionID</span> <span class="o">=</span> <span class="n">WTSGetActiveConsoleSessionId</span><span class="p">();</span>
   
	<span class="c1">//获取当前处于活动状态用户的Token</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WTSQueryUserToken</span><span class="p">(</span><span class="n">dwSessionID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hToken</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nCode</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>
		<span class="n">log_e</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"获取用户token失败,错误码:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">nCode</span><span class="p">);</span>
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hToken</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
   
	<span class="c1">//复制新的Token</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DuplicateTokenEx</span><span class="p">(</span><span class="n">hToken</span><span class="p">,</span> <span class="n">MAXIMUM_ALLOWED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SecurityIdentification</span><span class="p">,</span> <span class="n">TokenPrimary</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hTokenDup</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nCode</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>
		<span class="n">log_e</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"复制用户token失败,错误码:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">nCode</span><span class="p">);</span>
   
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hToken</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
   
	<span class="c1">//创建环境信息</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateEnvironmentBlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEnv</span><span class="p">,</span> <span class="n">hTokenDup</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DWORD</span> <span class="n">nCode</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>
		<span class="n">log_e</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"创建环境信息失败,错误码:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">nCode</span><span class="p">);</span>
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hTokenDup</span><span class="p">);</span>
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hToken</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
   
	<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">));</span>
	<span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">);</span>
	<span class="n">si</span><span class="p">.</span><span class="n">lpDesktop</span> <span class="o">=</span> <span class="n">_T</span><span class="p">(</span><span class="s">"winsta0</span><span class="se">\\</span><span class="s">default"</span><span class="p">);</span>
   
	<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_INFORMATION</span><span class="p">));</span>
   
	<span class="c1">//开始创建进程</span>
	<span class="n">DWORD</span> <span class="n">dwCreateFlag</span> <span class="o">=</span> <span class="n">NORMAL_PRIORITY_CLASS</span> <span class="o">|</span> <span class="n">CREATE_NEW_CONSOLE</span> <span class="o">|</span> <span class="n">CREATE_UNICODE_ENVIRONMENT</span><span class="p">;</span>
   
   
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcessAsUser</span><span class="p">(</span><span class="n">hTokenDup</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">commandLine</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">dwCreateFlag</span><span class="p">,</span> <span class="n">pEnv</span><span class="p">,</span> <span class="n">GetFullDir</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">DWORD</span> <span class="n">nCode</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">();</span>
		<span class="n">log_e</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">"创建进程失败,错误码:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="n">nCode</span><span class="p">);</span>
		<span class="n">DestroyEnvironmentBlock</span><span class="p">(</span><span class="n">pEnv</span><span class="p">);</span>
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hTokenDup</span><span class="p">);</span>
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hToken</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="c1">//创建一个进程</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <ul>
      <li>注意:涉及到字符串的都要使用宽字符</li>
    </ul>
  </li>
</ol>

<h1 id="三总结">三、总结</h1>

<p>如果想知道怎么创建服务的朋友可以看我的另外的一篇博文<a href="https://onew.me/2018/10/08/windows-service/">创建windows服务</a>.有什么疑问可以多多交流.</p>
