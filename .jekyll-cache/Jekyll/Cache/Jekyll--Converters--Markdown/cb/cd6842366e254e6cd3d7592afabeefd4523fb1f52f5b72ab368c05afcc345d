I"½<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>â€‹	åœ¨è¿™ä¸ªæ˜¥å›å¤§åœ°ä¸‡ç‰©å¤è‹çš„æ—¥å­,åœ¨å®¶é‡Œå¸¦ç€å£ç½©,æ‰‹æŒæ¶ˆæ¯’æ¶².åˆ†æspringæ˜¯æœ€å¥½æ¶ˆç£¨æ—¶é—´çš„æ–¹å¼.ä¸çŸ¥é“åœ¨è¿™æ®µæ—¶é—´é‡Œé¢,èƒ½å¦æŠŠIOCè¿™ä¸ªåˆ†æå®Œ.</p>

<p>â€‹	<code class="language-plaintext highlighter-rouge">Resource</code> è¿™ä¸ªæ¥å£æŠ½è±¡äº†èµ„æºçš„è·å–æ–¹å¼, spring å¯åŠ¨å¾€å¾€éƒ½æ˜¯ä»è¿™ä¸€æ­¥å¼€å§‹.</p>

<h1 id="äºŒä»é‚£å‡ å¥ä»£ç å¼€å§‹">äºŒã€ä»é‚£å‡ å¥ä»£ç å¼€å§‹</h1>

<ul>
  <li>ç®€å•çš„java bean</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.sjr.test.bean</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTestBean</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="s">"test--one"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTestStr</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">testStr</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">MyTestBean</span> <span class="nf">setTestStr</span><span class="o">(</span><span class="nc">String</span> <span class="n">testStr</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">testStr</span> <span class="o">=</span> <span class="n">testStr</span><span class="o">;</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸€ä¸ªxmlæ–‡ä»¶</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN" "https://www.springframework.org/dtd/spring-beans-2.0.dtd"&gt;</span>

<span class="nt">&lt;beans&gt;</span>
	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myTestBean"</span> <span class="na">class=</span><span class="s">"com.sjr.test.bean.MyTestBean"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>

</code></pre></div></div>

<ul>
  <li>ä¸€æ®µtest ä»£ç </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.sjr.test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sjr.test.bean.MyTestBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.xml.XmlBeanFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.io.ClassPathResource</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestSpringBean</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringLoadXml</span><span class="o">(){</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸€ä¸ªè¾“å‡ºç»“æœ</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test--one
</code></pre></div></div>

<p>â€‹	å¯ä»¥çœ‹åˆ°springä»xmlè¯»å–åˆ°äº†é…ç½®ä¿¡æ¯,å¹¶ä¸”ç¬¦åˆé¢„æœŸçš„è·å–äº†bean.é‚£ä¹ˆspringæ˜¯å¦‚ä½•åŠ è½½xmlçš„?åœ¨åˆ›å»ºXmlBeanFactoryçš„æ—¶å€™,æ„é€ æ–¹æ³•æ¥æ”¶çš„æ˜¯ä¸€ä¸ªResourceå¯¹è±¡,Resourceæ˜¯ä¸ªæ¥å£,è¿™é‡Œç›´æ¥ä½¿ç”¨çš„å®ƒçš„å®ç°ç±»ClassPathResource.</p>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/ClassPathResource.png" alt="images" /></p>

<h2 id="21-resource-æ¥å£">2.1 Resource æ¥å£</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Resource</span> <span class="kd">extends</span> <span class="nc">InputStreamSource</span> <span class="o">{</span>

	<span class="cm">/*
	* åˆ¤æ–­èµ„æºæ˜¯å¦å­˜åœ¨
	**/</span>
	<span class="kt">boolean</span> <span class="nf">exists</span><span class="o">();</span>

	<span class="cm">/**
	 * åˆ¤æ–­èµ„æºæ˜¯å¦å¯è¯»,é»˜è®¤æ–¹æ³•JAVA8 æ–°ç‰¹æ€§
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isReadable</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">exists</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¢«æ‰“å¼€,é»˜è®¤æ–¹æ³•JAVA8 æ–°ç‰¹æ€§
	 * é»˜è®¤è¿”å› false
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isOpen</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * åˆ¤æ–­èµ„æºæ˜¯å¦æ˜¯æ–‡ä»¶,é»˜è®¤æ–¹æ³•JAVA8 æ–°ç‰¹æ€§
	 * é»˜è®¤è¿”å› false
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isFile</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–èµ„æºURL å¯¹è±¡
	 */</span>
	<span class="no">URL</span> <span class="nf">getURL</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * è·å–èµ„æº URI å¯¹è±¡
	 */</span>
	<span class="no">URI</span> <span class="nf">getURI</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * è·å–èµ„æºæ–‡ä»¶å¯¹è±¡
	 */</span>
	<span class="nc">File</span> <span class="nf">getFile</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * è·å–èµ„æº Channel å¯¹è±¡ NIO
	 */</span>
	<span class="k">default</span> <span class="nc">ReadableByteChannel</span> <span class="nf">readableChannel</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Channels</span><span class="o">.</span><span class="na">newChannel</span><span class="o">(</span><span class="n">getInputStream</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–èµ„æºé•¿åº¦
	 */</span>
	<span class="kt">long</span> <span class="nf">contentLength</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * è·å–èµ„æºæœ€åä¿®æ”¹æ—¶é—´
	 */</span>
	<span class="kt">long</span> <span class="nf">lastModified</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * åˆ›å»ºèµ„æºç›¸å¯¹è·¯å¾„
	 */</span>
	<span class="nc">Resource</span> <span class="nf">createRelative</span><span class="o">(</span><span class="nc">String</span> <span class="n">relativePath</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

	<span class="cm">/**
	 * è·å–èµ„æºæ–‡ä»¶å
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="nc">String</span> <span class="nf">getFilename</span><span class="o">();</span>

	<span class="cm">/**
	 * è·å–èµ„æºæè¿°ä¿¡æ¯
	 */</span>
	<span class="nc">String</span> <span class="nf">getDescription</span><span class="o">();</span>

<span class="o">}</span>

</code></pre></div></div>

<p>Resource æ¥å£ç›¸å½“äºå¯¹èµ„æºçš„ä¸€ç§æŠ½è±¡,ä¸ç®¡æ˜¯ä»€ä¹ˆ xml ä¹Ÿå¥½,å­—èŠ‚æµä¹Ÿå¥½ç­‰,ç»Ÿä¸€æŠ½è±¡,ç”±ä¸åŒçš„å­ç±»åˆ†åˆ«å»å®ç°.</p>

<h2 id="22-xmlbeanfactory">2.2 XmlBeanFactory</h2>

<ul>
  <li>å›åˆ°é—®é¢˜æœ¬èº«,XmlBeanFactoryæ˜¯æ€ä¹ˆåŠ è½½xmlçš„?</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">XmlBeanFactory</span> <span class="kd">extends</span> <span class="nc">DefaultListableBeanFactory</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">XmlBeanDefinitionReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>


	<span class="kd">public</span> <span class="nf">XmlBeanFactory</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">XmlBeanFactory</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">parentBeanFactory</span><span class="o">);</span>
    <span class="c1">// ä»è¿™é‡Œå¼€å§‹,åŠ è½½xml </span>
		<span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span> <span class="c1">// A</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>ä»<code class="language-plaintext highlighter-rouge">A</code> å¤„XmlBeanFactory,å§”æ‰˜<code class="language-plaintext highlighter-rouge">XmlBeanDefinitionReader</code>è¿›è¡ŒåŠ è½½xml.è·Ÿè¸ªè¿›å»çœ‹çœ‹.</p>

<h2 id="23-xmlbeandefinitionreader">2.3 XmlBeanDefinitionReader</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// æŠŠclassPathsResourceè½¬æ¢ä¸ºEncodedResource,é»˜è®¤å­—ç¬¦ç¼–ç ä¸ºç©º</span>
		<span class="k">return</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="k">new</span> <span class="nc">EncodedResource</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
	<span class="o">}</span>


	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">EncodedResource</span> <span class="n">encodedResource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// åŠ è½½èµ„æº,èµ„æºä¸èƒ½ä¸ºç©º</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">,</span> <span class="s">"EncodedResource must not be null"</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Loading XML bean definitions from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åŠ è½½è¿‡èµ„æº,å¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªsetæ¥ä¿å­˜encodedResource</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">EncodedResource</span><span class="o">&gt;</span> <span class="n">currentResources</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">currentResources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">currentResources</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æœ‰å·²è¿‘æ·»åŠ è¿‡ç›¸åŒçš„encodedResource</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">currentResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
					<span class="s">"Detected cyclic loading of "</span> <span class="o">+</span> <span class="n">encodedResource</span> <span class="o">+</span> <span class="s">" - check your import definitions!"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// è·å–xmlæ–‡ä»¶æµ</span>
			<span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="nc">InputSource</span> <span class="n">inputSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
				<span class="c1">// å¦‚æœç¼–ç ä¸ä¸ºç©º,åˆ™è®¾ç½®æ–‡ä»¶ç¼–ç </span>
				<span class="k">if</span> <span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">inputSource</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">());</span>
				<span class="o">}</span>
				<span class="c1">// åŠ è½½bean</span>
				<span class="k">return</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">finally</span> <span class="o">{</span>
				<span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
					<span class="s">"IOException parsing XML document from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">finally</span> <span class="o">{</span>
			<span class="n">currentResources</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>ä»<code class="language-plaintext highlighter-rouge">XmlBeanDefinitionReader</code>ä»£ç é€»è¾‘å¯ä»¥çœ‹å‡º:</p>

<ol>
  <li>æŠŠ <code class="language-plaintext highlighter-rouge">Resource</code> å¯¹è±¡è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">EncodedResource</code>å¯¹è±¡</li>
  <li>åˆ¤æ–­ xml èµ„æºæ˜¯å¦è¢«åŠ è½½è¿‡,å¦‚æœè¢«åŠ è½½è¿‡ æŠ›å‡ºå¼‚å¸¸ <code class="language-plaintext highlighter-rouge">BeanDefinitionStoreException</code></li>
  <li>xml èµ„æºæ”¾å…¥ç¼“å­˜</li>
  <li>è·å–èµ„æºæµ</li>
  <li>è¯»å–æ–‡ä»¶</li>
  <li>å…³é—­æ–‡ä»¶æµ</li>
</ol>

<p>emmm,é‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">EncodedResource</code> å¯¹è±¡æ˜¯ä¸ªä»€ä¹ˆç©æ„å„¿å‘¢?? è·Ÿè¸ªè¿›å»çœ‹çœ‹.</p>

<h2 id="24-encodedresource">2.4 EncodedResource</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncodedResource</span> <span class="kd">implements</span> <span class="nc">InputStreamSource</span> <span class="o">{</span>
	<span class="c1">// èµ„æºå¯¹è±¡</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">;</span>
	<span class="c1">// ç¼–ç </span>
	<span class="nd">@Nullable</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">encoding</span><span class="o">;</span>
	<span class="c1">// å­—ç¬¦é›†</span>
	<span class="nd">@Nullable</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">;</span>


	<span class="kd">public</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">encoding</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">encoding</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	
	<span class="kd">public</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">charset</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nf">EncodedResource</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">encoding</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Charset</span> <span class="n">charset</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="s">"Resource must not be null"</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">charset</span> <span class="o">=</span> <span class="n">charset</span><span class="o">;</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * è¿”å›èµ„æºå¯¹è±¡
	 */</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="nc">Resource</span> <span class="nf">getResource</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–ç¼–ç 
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">getEncoding</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">encoding</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
   * è·å–å­—ç¬¦é›†
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="nc">Charset</span> <span class="nf">getCharset</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">charset</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * å¦‚æœç¼–ç  å’Œ å­—ç¬¦é›† ä¸ä¸ºç©º
	 * åˆ™éœ€è¦readerå¯¹è±¡
	 */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">requiresReader</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">charset</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å– Reader å¯¹è±¡
	 */</span>
	<span class="kd">public</span> <span class="nc">Reader</span> <span class="nf">getReader</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">charset</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">charset</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">encoding</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–æµå¯¹è±¡
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
	<span class="o">}</span>


	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">EncodedResource</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">EncodedResource</span> <span class="n">otherResource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">EncodedResource</span><span class="o">)</span> <span class="n">other</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">otherResource</span><span class="o">.</span><span class="na">resource</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
				<span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">nullSafeEquals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">charset</span><span class="o">,</span> <span class="n">otherResource</span><span class="o">.</span><span class="na">charset</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
				<span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">nullSafeEquals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encoding</span><span class="o">,</span> <span class="n">otherResource</span><span class="o">.</span><span class="na">encoding</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">resource</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	<code class="language-plaintext highlighter-rouge">EncodedResource</code>å†…éƒ¨çš„é€»è¾‘å¾ˆç®€å•,å¹¶æœªåšä»€ä¹ˆç‰¹æ®Šæ“ä½œ,çœ‹æ¥<code class="language-plaintext highlighter-rouge">EncodedResource</code>åªæ˜¯åŠ äº†å‡ ä¸ªå·¥å…·æ–¹æ³•è€Œå·²,æ¯”å¦‚è·å–<code class="language-plaintext highlighter-rouge">Reader</code>.</p>

<p>â€‹	é‚£ä¹ˆæ¥ä¸‹çš„é‡ç‚¹å°±æ˜¯,å¦‚ä½•è·å–xmlæ–‡ä»¶çš„.ä¸Šé¢ä»£ç ä¸­çš„<code class="language-plaintext highlighter-rouge">Resource</code>å¯¹è±¡çš„å®ç°ç±»æ˜¯<code class="language-plaintext highlighter-rouge">ClassPathResource</code>,è·å–æ–‡ä»¶æµçš„ä»£ç å¦‚ä¸‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
		<span class="nc">InputStream</span> <span class="n">is</span><span class="o">;</span>
    <span class="c1">// å¦‚æœæŒ‡å®šçš„ class å¯¹è±¡ä¸ä¸ºç©º</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// è·å–æµå¯¹è±¡</span>
			<span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">clazz</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
		<span class="o">}</span>
    <span class="c1">// å¦‚æœæŒ‡å®šçš„ classLoader å¯¹è±¡ä¸ä¸ºç©º</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// è·å–æµå¯¹è±¡</span>
			<span class="n">is</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">classLoader</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
      <span class="c1">// è·å–æµå¯¹è±¡</span>
			<span class="n">is</span> <span class="o">=</span> <span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemResourceAsStream</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
		<span class="o">}</span>
    <span class="c1">// æµå¯¹è±¡ä¸ºç©º æŠ›å‡ºå¼‚å¸¸ FileNotFoundException</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">is</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">FileNotFoundException</span><span class="o">(</span><span class="n">getDescription</span><span class="o">()</span> <span class="o">+</span> <span class="s">" cannot be opened because it does not exist"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">is</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<h1 id="ä¸‰resource-ä½“ç³»">ä¸‰ã€Resource ä½“ç³»</h1>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/resource.png" alt="images" /></p>

<ul>
  <li>
    <p>FileSystemResource</p>

    <p>â€‹	å¯¹ <code class="language-plaintext highlighter-rouge">java.io.File</code> ç±»å‹èµ„æºçš„å°è£…ï¼Œåªè¦æ˜¯è·Ÿ File æ‰“äº¤é“çš„ï¼ŒåŸºæœ¬ä¸Šä¸ FileSystemResource ä¹Ÿå¯ä»¥æ‰“äº¤é“ã€‚</p>
  </li>
  <li>
    <p>ByteArrayResource</p>

    <p>â€‹	å¯¹å­—èŠ‚æ•°ç»„æä¾›çš„æ•°æ®çš„å°è£…ã€‚å¦‚æœé€šè¿‡ InputStream å½¢å¼è®¿é—®è¯¥ç±»å‹çš„èµ„æºï¼Œè¯¥å®ç°ä¼šæ ¹æ®å­—èŠ‚æ•°ç»„çš„æ•°æ®æ„é€ ä¸€ä¸ªç›¸åº”çš„ ByteArrayInputStreamã€‚</p>
  </li>
  <li>
    <p>UrlResource</p>

    <p>â€‹	å¯¹<code class="language-plaintext highlighter-rouge">java.net.URL</code>ç±»å‹èµ„æºçš„å°è£…ã€‚å†…éƒ¨å§”æ´¾ URL è¿›è¡Œå…·ä½“çš„èµ„æºæ“ä½œã€‚</p>
  </li>
  <li>
    <p>ClassPathResource</p>

    <p>â€‹	class path ç±»å‹èµ„æºçš„å®ç°ã€‚ä½¿ç”¨ç»™å®šçš„ ClassLoader æˆ–è€…ç»™å®šçš„ Class æ¥åŠ è½½èµ„æºã€‚</p>
  </li>
  <li>
    <p>InputStreamResource</p>

    <p>â€‹	å°†ç»™å®šçš„ InputStream ä½œä¸ºä¸€ç§èµ„æºçš„ Resource çš„å®ç°ç±»ã€‚</p>
  </li>
  <li>
    <p>VfsResource</p>

    <p>â€‹	VfsResourceä»£è¡¨Jboss è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿèµ„æºã€‚</p>
  </li>
</ul>

<p>ä»¥ä¸Š6ç§å¸¸ç”¨çš„ <code class="language-plaintext highlighter-rouge">Resource</code> å¯¹è±¡,å½“ç„¶spring é‡Œé¢å¯ä¸æ­¢è¿™6ä¸­ <code class="language-plaintext highlighter-rouge">Resource</code> å®ç°ç±».</p>

<h1 id="å››æ€è€ƒ">å››ã€æ€è€ƒ</h1>

<p>â€‹	åœ¨ spring é…ç½®æ–‡ä»¶ä¸­,æœ‰äº›èµ„æºå¯èƒ½ä¸æ˜¯ä» classPath è·å–,å¯èƒ½æ˜¯ä»ç½‘ç»œè·å–ç­‰,é‚£ä¹ˆ spring æ˜¯æ€ä¹ˆçŸ¥é“è¦ç”¨é‚£ç§æ–¹å¼è¿›è¡Œèµ„æºåŠ è½½çš„å‘¢ï¼Ÿ</p>

<p>â€‹	ä¹Ÿè®¸è·Ÿ <code class="language-plaintext highlighter-rouge">ResourceLoader</code> è¿™ä¸ªæœ‰å…³.</p>

:ET