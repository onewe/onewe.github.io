I"Ô'<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>â€‹	æ¥ä¸Šæ–‡,åˆ†æäº†spring æŠŠ xml æ–‡ä»¶è¯»å–åˆ°å†…å­˜ä¸­,å¹¶ç”Ÿæˆä¸€ä¸ª<code class="language-plaintext highlighter-rouge">document</code>å¯¹è±¡,ç„¶è€Œç¦»åˆ›å»º<code class="language-plaintext highlighter-rouge">bean</code>è¿˜æ¯”è¾ƒé¥è¿œ.åœ¨xmlä¸­å®šäº†<code class="language-plaintext highlighter-rouge">bean</code>è¯¥å¦‚ä½•åˆ›å»ºçš„è§„åˆ™,è€Œspringä¹Ÿæ˜¯éµå¾ªxmlä¸­çš„æ ‡ç­¾æ‰€æè¿°è§„åˆ™æ¥è¿›è¡Œåˆ›å»º<code class="language-plaintext highlighter-rouge">bean</code>.æ¥ä¸‹æ¥å°±æ˜¯è¦åˆ†æ,springæ˜¯å¦‚ä½•è§£æè¿™äº›æ ‡ç­¾çš„.</p>

<h1 id="äºŒåˆ†æ">äºŒã€åˆ†æ</h1>

<p>â€‹	è¿˜æ˜¯å¸¸è§„å¥—è·¯,ä»ä¸‹é¢çš„æµ‹è¯•ä»£ç å¼€å§‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringLoadXml</span><span class="o">(){</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	xmlå†…å®¹å¦‚ä¸‹:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	   <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	   <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                       https://www.springframework.org/schema/beans/spring-beans-3.0.xsd"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myTestBean"</span> <span class="na">class=</span><span class="s">"com.sjr.test.bean.MyTestBean"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>

</code></pre></div></div>

<p>â€‹	ç»“åˆxml,å°±å¯ä»¥è®©springåˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">MyTestBean</code>å¯¹è±¡å‡ºæ¥.é‚£ä¹ˆspringæ˜¯æ€ä¹ˆåŠåˆ°çš„å‘¢?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// XmlBeanDefinitionReader</span>
<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="nc">InputSource</span> <span class="n">inputSource</span><span class="o">,</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// åŠ è½½xml</span>
      <span class="c1">// åŠ è½½xmlçš„æ—¶å€™è¿™é‡Œå·²ç»è®²è¿‡äº†</span>
			<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">doLoadDocument</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
			<span class="c1">// æ³¨å†Œbean</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loaded "</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">" bean definitions from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">count</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">SAXParseException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">XmlBeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
					<span class="s">"Line "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getLineNumber</span><span class="o">()</span> <span class="o">+</span> <span class="s">" in XML document from "</span> <span class="o">+</span> <span class="n">resource</span> <span class="o">+</span> <span class="s">" is invalid"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">SAXException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">XmlBeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
					<span class="s">"XML document from "</span> <span class="o">+</span> <span class="n">resource</span> <span class="o">+</span> <span class="s">" is invalid"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">ParserConfigurationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
					<span class="s">"Parser configuration exception parsing XML from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
					<span class="s">"IOException parsing XML document from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span>
					<span class="s">"Unexpected exception parsing XML document from "</span> <span class="o">+</span> <span class="n">resource</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	çœ‹æ¥ç­”æ¡ˆå‡ºç°åœ¨<code class="language-plaintext highlighter-rouge">int count = registerBeanDefinitions(doc, resource);</code>è¿™å¥ä»£ç é‡Œé¢</p>

<h2 id="21-registerbeandefinitions">2.1 registerBeanDefinitions()</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//xmlBeanDefinitionReader</span>
<span class="cm">/***
* @param doc é€šè¿‡xml åˆ›å»ºçš„documentå¯¹è±¡
* @param resource xml èµ„æºå¯¹è±¡
* @return æ³¨å†Œçš„æ•°é‡
*/</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">Document</span> <span class="n">doc</span><span class="o">,</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
		<span class="c1">// åˆ›å»ºBeanDefinitionDocumentReader é»˜è®¤æ˜¯DefaultBeanDefinitionDocumentReader</span>
		<span class="nc">BeanDefinitionDocumentReader</span> <span class="n">documentReader</span> <span class="o">=</span> <span class="n">createBeanDefinitionDocumentReader</span><span class="o">();</span>
		<span class="c1">// è·å–å·²ç»æ³¨å†Œçš„beançš„æ•°é‡,beanDefinitionMap.size()</span>
		<span class="kt">int</span> <span class="n">countBefore</span> <span class="o">=</span> <span class="n">getRegistry</span><span class="o">().</span><span class="na">getBeanDefinitionCount</span><span class="o">();</span>
    <span class="c1">// æ³¨å†Œxml beanå®šä¹‰</span>
		<span class="n">documentReader</span><span class="o">.</span><span class="na">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">createReaderContext</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
  	<span class="c1">// è¿”å›å·²ç»æ³¨å†Œçš„æ•°é‡</span>
		<span class="k">return</span> <span class="nf">getRegistry</span><span class="o">().</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">countBefore</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è§£æxmlæ ‡ç­¾çš„æ ¸å¿ƒé€»è¾‘åœ¨äº<code class="language-plaintext highlighter-rouge">documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</code>,é€æ­¥åˆ†æä¸€ä¸‹.</p>

<h2 id="22-createreadercontextresource">2.2 createReaderContext(resource)</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//xmlBeanDefinitionReader</span>
<span class="kd">public</span> <span class="nc">XmlReaderContext</span> <span class="nf">createReaderContext</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">XmlReaderContext</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">eventListener</span><span class="o">,</span>
				<span class="k">this</span><span class="o">.</span><span class="na">sourceExtractor</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">getNamespaceHandlerResolver</span><span class="o">());</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™ä¸ªå¯¹è±¡ç›¸å½“äºæ˜¯ä¸ªå·¥å…·ç±»,é‡Œé¢æœªå°è£…é€»è¾‘ä»£ç .å°è£…äº†ä¸€äº›æ—¥å¿—ç›¸å…³çš„å‡½æ•°,è·å–resourceçš„å‡½æ•°ç­‰.è¿™é‡Œå€¼å¾—æ³¨æ„æ˜¯<code class="language-plaintext highlighter-rouge">getNamespaceHandlerResolver()</code>è¿™ä¸ªæ–¹æ³•,è¿™ä¸ªæ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">NamespaceHandlerResolver</code>å¯¹è±¡,è¿™ä¸ªå¯¹è±¡æ˜¯ç”¨äºè§£ææŒ‡å®šåç§°ç©ºé—´çš„è§£æå™¨,å¦‚æœè¦è‡ªå®šä¹‰æ ‡ç­¾å°±å¾—è¦è¿™ä¸ªå¯¹è±¡æ¥å¸®å¿™.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">//xmlBeanDefinitionReader</span>
	<span class="kd">public</span> <span class="nc">NamespaceHandlerResolver</span> <span class="nf">getNamespaceHandlerResolver</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// å¦‚æœåç§°ç©ºé—´è§£æå™¨ä¸ºç©º,åˆ™åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„åç§°ç©ºé—´è§£æå™¨</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">namespaceHandlerResolver</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">namespaceHandlerResolver</span> <span class="o">=</span> <span class="n">createDefaultNamespaceHandlerResolver</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">namespaceHandlerResolver</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Create the default implementation of {@link NamespaceHandlerResolver} used if none is specified.
	 * &lt;p&gt;The default implementation returns an instance of {@link DefaultNamespaceHandlerResolver}.
	 * @see DefaultNamespaceHandlerResolver#DefaultNamespaceHandlerResolver(ClassLoader)
	 */</span>
	<span class="kd">protected</span> <span class="nc">NamespaceHandlerResolver</span> <span class="nf">createDefaultNamespaceHandlerResolver</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// è·å–classLoader</span>
    <span class="nc">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="o">(</span><span class="n">getResourceLoader</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">getResourceLoader</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">()</span> <span class="o">:</span> <span class="n">getBeanClassLoader</span><span class="o">());</span>
    <span class="c1">// åˆ›å»ºé»˜è®¤çš„åç§°ç©ºé—´è§£æå™¨</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultNamespaceHandlerResolver</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<h2 id="23-registerbeandefinitions">2.3 registerBeanDefinitions()</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// DefaultBeanDefinitionDocumentReader</span>
	<span class="c1">// bean</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">BEAN_ELEMENT</span> <span class="o">=</span> <span class="nc">BeanDefinitionParserDelegate</span><span class="o">.</span><span class="na">BEAN_ELEMENT</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">NESTED_BEANS_ELEMENT</span> <span class="o">=</span> <span class="s">"beans"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ALIAS_ELEMENT</span> <span class="o">=</span> <span class="s">"alias"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">NAME_ATTRIBUTE</span> <span class="o">=</span> <span class="s">"name"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ALIAS_ATTRIBUTE</span> <span class="o">=</span> <span class="s">"alias"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">IMPORT_ELEMENT</span> <span class="o">=</span> <span class="s">"import"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RESOURCE_ATTRIBUTE</span> <span class="o">=</span> <span class="s">"resource"</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PROFILE_ATTRIBUTE</span> <span class="o">=</span> <span class="s">"profile"</span><span class="o">;</span>


	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">Document</span> <span class="n">doc</span><span class="o">,</span> <span class="nc">XmlReaderContext</span> <span class="n">readerContext</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">readerContext</span> <span class="o">=</span> <span class="n">readerContext</span><span class="o">;</span>
		<span class="n">doRegisterBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">.</span><span class="na">getDocumentElement</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doRegisterBeanDefinitions</span><span class="o">(</span><span class="nc">Element</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span>
		<span class="c1">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span>
		<span class="c1">// keep track of the current (parent) delegate, which may be null. Create</span>
		<span class="c1">// the new (child) delegate with a reference to the parent for fallback purposes,</span>
		<span class="c1">// then ultimately reset this.delegate back to its original (parent) reference.</span>
		<span class="c1">// this behavior emulates a stack of delegates without actually necessitating one.</span>
		<span class="c1">// rootèŠ‚ç‚¹è¿›æ¥é»˜è®¤å§”æ‰˜ä¸ºnull</span>
		<span class="nc">BeanDefinitionParserDelegate</span> <span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">;</span>
		<span class="c1">// åˆ›å»ºå§”æ‰˜,ç”¨äºè§£æå„ä¸ªæ ‡ç­¾</span>
    <span class="c1">// BeanDefinitionParserDelegate</span>
		<span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">createDelegate</span><span class="o">(</span><span class="n">getReaderContext</span><span class="o">(),</span> <span class="n">root</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>

		<span class="c1">// å¤„ç†profileå±æ€§,ç”¨äºåˆ‡æ¢ä¸åŒç¯å¢ƒçš„é…ç½®æ–‡ä»¶</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">root</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// åˆ¤æ–­æ˜¯å¦å«æœ‰profileå±æ€§</span>
			<span class="nc">String</span> <span class="n">profileSpec</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">PROFILE_ATTRIBUTE</span><span class="o">);</span>
			<span class="c1">// å¦‚æœprofileå±æ€§ä¸ä¸ºç©º</span>
			<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">profileSpec</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// å¯èƒ½ä¼šæœ‰å¤šä¸ªprofileå±æ€§,ä½¿ç”¨,;è¿›è¡Œåˆ†å‰²</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">specifiedProfiles</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">tokenizeToStringArray</span><span class="o">(</span>
						<span class="n">profileSpec</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span><span class="o">.</span><span class="na">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="o">);</span>
				<span class="c1">// We cannot use Profiles.of(...) since profile expressions are not supported</span>
				<span class="c1">// in XML config. See SPR-12458 for details.</span>
				<span class="c1">// å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„profile åˆ™è¿”å›</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">getReaderContext</span><span class="o">().</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">acceptsProfiles</span><span class="o">(</span><span class="n">specifiedProfiles</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
						<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Skipped XML bean definition file due to specified profiles ["</span> <span class="o">+</span> <span class="n">profileSpec</span> <span class="o">+</span>
								<span class="s">"] not matching: "</span> <span class="o">+</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getResource</span><span class="o">());</span>
					<span class="o">}</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// å‰ç½®è§£æå™¨(ç©ºé€»è¾‘,ç•™ç»™å­ç±»å»å®Œå–„)</span>
		<span class="n">preProcessXml</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
		<span class="c1">// æ ¸å¿ƒé€»è¾‘</span>
		<span class="n">parseBeanDefinitions</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">);</span>
		<span class="c1">// åç½®è§£æå™¨(ç©ºé€»è¾‘,ç•™ç»™å­ç±»å»å®Œå–„)</span>
		<span class="n">postProcessXml</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>

		<span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>æ ¹èŠ‚ç‚¹é»˜è®¤æ²¡æœ‰çˆ¶èŠ‚ç‚¹ä¸ºNULL</li>
  <li>åˆ›å»ºå§”æ‰˜ç”¨äºè§£æxmlæ ‡ç­¾</li>
  <li>åˆ¤æ–­æ˜¯å¦æœ‰å¤šä¸ªç¯å¢ƒé…ç½®,å¹¶åˆ‡æ¢é…ç½®</li>
  <li>å¼€å§‹è§£æ</li>
</ol>

<p>â€‹	<code class="language-plaintext highlighter-rouge">preProcessXml(root)</code>æ–¹æ³•å’Œ<code class="language-plaintext highlighter-rouge">postProcessXm(root)</code>é»˜è®¤éƒ½æ˜¯ç©ºå®ç°,è¿™é‡Œæ˜¯åº”ç”¨çš„è®¾è®¡æ¨¡å¼ä¸º æ¨¡æ¿æ¨¡å¼,å¢å¼ºæ‰©å±•æ–°,å­ç±»éœ€è¦æ‰©å±•åªéœ€è¦å»å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•å³å¯.</p>

<h2 id="24-parsebeandefinitions">2.4 parseBeanDefinitions</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">parseBeanDefinitions</span><span class="o">(</span><span class="nc">Element</span> <span class="n">root</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// å¦‚æœæ ¹èŠ‚ç‚¹ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œæ‰§è¡Œé»˜è®¤è§£æ</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">root</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// è·å–èŠ‚ç‚¹ä¸‹é¢çš„å­èŠ‚ç‚¹</span>
			<span class="nc">NodeList</span> <span class="n">nl</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getChildNodes</span><span class="o">();</span>
			<span class="c1">// éå†å­èŠ‚ç‚¹</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="nc">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="nc">Element</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">Element</span> <span class="n">ele</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Element</span><span class="o">)</span> <span class="n">node</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">ele</span><span class="o">))</span> <span class="o">{</span>
						<span class="c1">// è§£æé»˜è®¤åç§°ç©ºé—´å…ƒç´ </span>
						<span class="n">parseDefaultElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="c1">// è§£æè‡ªå®šä¹‰åç§°å‘½åç©ºé—´</span>
						<span class="n">delegate</span><span class="o">.</span><span class="na">parseCustomElement</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// è§£æè‡ªå®šä¹‰åç§°å‘½åç©ºé—´</span>
			<span class="n">delegate</span><span class="o">.</span><span class="na">parseCustomElement</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œä»åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ˜¯é»˜è®¤çš„åç§°å‘½åç©ºé—´,ä»è€Œå¼•å‘äº†2ç§ä¸åŒçš„é€»è¾‘åˆ†æ”¯.ä¸€ä¸ªæ˜¯æ‰§è¡Œspringçš„å†…ç½®çš„è§£æé€»è¾‘,å¦ä¸€ä¸ªæ˜¯æ‰§è¡Œè‡ªå®šä¹‰çš„è§£æé€»è¾‘.</p>

<p>â€‹	springåˆ¤æ–­æ˜¯å¦æ˜¯é»˜è®¤çš„åç§°ç©ºé—´ä¾æ®æ˜¯:å¦‚æœ<code class="language-plaintext highlighter-rouge">namespaceUri</code>ä¸ºç©ºå¹¶ä¸”ä¸ç­‰äº<code class="language-plaintext highlighter-rouge">http://www.springframework.org/schema/beans</code>,åˆ™åˆ¤æ–­ä¸ºéé»˜è®¤åç§°ç©ºé—´.</p>

<h1 id="ä¸‰é»˜è®¤è§£æ">ä¸‰ã€é»˜è®¤è§£æ</h1>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultBeanDefinitionDocumentReader</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseDefaultElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// é»˜è®¤åç§°ç©ºé—´è§£æ,ç”±æ­¤å¯è§springé»˜è®¤åç§°å‘½åç©ºé—´åªæœ‰4ä¸ª</span>
		<span class="c1">// import alias bean beans</span>
		<span class="c1">// import æ ‡ç­¾å¤„ç†.ç”¨äºåŠ è½½å¼•ç”¨è¿›æ¥çš„xml</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">IMPORT_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">importBeanDefinitionResource</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// alias æ ‡ç­¾å¤„ç†</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">ALIAS_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">processAliasRegistration</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// bean æ ‡ç­¾å¤„ç†</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">BEAN_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">processBeanDefinition</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// beans æ ‡ç­¾å¤„ç†</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">NESTED_BEANS_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// recurse é€’å½’è§£æ</span>
			<span class="n">doRegisterBeanDefinitions</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<h2 id="31-importæ ‡ç­¾">3.1 importæ ‡ç­¾</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultBeanDefinitionDocumentReader</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">importBeanDefinitionResource</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// è·å–resourceå±æ€§,ç”¨äºåŠ è½½æ–‡ä»¶</span>
		<span class="nc">String</span> <span class="n">location</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">RESOURCE_ATTRIBUTE</span><span class="o">);</span>
		<span class="c1">// å¦‚æœä¸ºç©ºåˆ™é€€å‡º</span>
		<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">location</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Resource location must not be empty"</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// è§£æå½“å‰ç¯å¢ƒä¸­çš„æ–‡ä»¶è·¯å¾„</span>
		<span class="c1">// Resolve system properties: e.g. "${user.dir}"</span>
		<span class="n">location</span> <span class="o">=</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">resolveRequiredPlaceholders</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>

		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Resource</span><span class="o">&gt;</span> <span class="n">actualResources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>

		<span class="c1">// Discover whether the location is an absolute or relative URI</span>
		<span class="kt">boolean</span> <span class="n">absoluteLocation</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">absoluteLocation</span> <span class="o">=</span> <span class="nc">ResourcePatternUtils</span><span class="o">.</span><span class="na">isUrl</span><span class="o">(</span><span class="n">location</span><span class="o">)</span> <span class="o">||</span> <span class="nc">ResourceUtils</span><span class="o">.</span><span class="na">toURI</span><span class="o">(</span><span class="n">location</span><span class="o">).</span><span class="na">isAbsolute</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">URISyntaxException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// cannot convert to an URI, considering the location relative</span>
			<span class="c1">// unless it is the well-known Spring prefix "classpath*:"</span>
		<span class="o">}</span>

		<span class="c1">// åˆ¤æ–­æ˜¯ç»å¯¹è·¯å¾„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„</span>
		<span class="c1">// Absolute or relative?</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">absoluteLocation</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// ç»å¯¹è·¯å¾„</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// åŠ è½½resourceå±æ€§ä¸­çš„xmlæ–‡ä»¶,åŠ è½½beanå®šä¹‰</span>
				<span class="kt">int</span> <span class="n">importCount</span> <span class="o">=</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getReader</span><span class="o">().</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">actualResources</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Imported "</span> <span class="o">+</span> <span class="n">importCount</span> <span class="o">+</span> <span class="s">" bean definitions from URL location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span>
						<span class="s">"Failed to import bean definitions from URL location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// ç›¸å¯¹è·¯å¾„</span>
			<span class="c1">// No URL -&gt; considering resource location as relative to the current file.</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">importCount</span><span class="o">;</span>
				<span class="nc">Resource</span> <span class="n">relativeResource</span> <span class="o">=</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getResource</span><span class="o">().</span><span class="na">createRelative</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
				<span class="c1">// åˆ¤æ–­èµ„æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">relativeResource</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
					<span class="c1">// åŠ è½½æ–‡ä»¶</span>
					<span class="n">importCount</span> <span class="o">=</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getReader</span><span class="o">().</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">relativeResource</span><span class="o">);</span>
					<span class="n">actualResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">relativeResource</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="c1">// è½¬æ¢ä¸ºç»å¯¹è·¯å¾„</span>
					<span class="nc">String</span> <span class="n">baseLocation</span> <span class="o">=</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getResource</span><span class="o">().</span><span class="na">getURL</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
					<span class="c1">// åŠ è½½æ–‡ä»¶</span>
					<span class="n">importCount</span> <span class="o">=</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getReader</span><span class="o">().</span><span class="na">loadBeanDefinitions</span><span class="o">(</span>
							<span class="c1">// è®¡ç®—ç»å¯¹è·¯å¾„</span>
							<span class="nc">StringUtils</span><span class="o">.</span><span class="na">applyRelativePath</span><span class="o">(</span><span class="n">baseLocation</span><span class="o">,</span> <span class="n">location</span><span class="o">),</span> <span class="n">actualResources</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Imported "</span> <span class="o">+</span> <span class="n">importCount</span> <span class="o">+</span> <span class="s">" bean definitions from relative location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to resolve current resource location"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span>
						<span class="s">"Failed to import bean definitions from relative location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// è½¬æ¢ä¸ºæ•°ç»„</span>
		<span class="nc">Resource</span><span class="o">[]</span> <span class="n">actResArray</span> <span class="o">=</span> <span class="n">actualResources</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Resource</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
		<span class="c1">// é‡Šæ”¾èµ„æº</span>
		<span class="n">getReaderContext</span><span class="o">().</span><span class="na">fireImportProcessed</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">actResArray</span><span class="o">,</span> <span class="n">extractSource</span><span class="o">(</span><span class="n">ele</span><span class="o">));</span>
	<span class="o">}</span>

</code></pre></div></div>

<ol>
  <li>åˆ¤æ–­è·¯å¾„æ˜¯å¦ä¸ºç©º</li>
  <li>å¦‚æœä¸ºç›¸å¯¹è·¯å¾„,åŠ è½½xmlæ–‡ä»¶</li>
  <li>å¦‚æœä¸ºç»å¯¹è·¯å¾„,åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨,å­˜åœ¨åˆ™åŠ è½½æ–‡ä»¶</li>
  <li>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨,è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„,åŠ è½½æ–‡ä»¶</li>
</ol>

<h2 id="32-aliasæ ‡ç­¾">3.2 aliasæ ‡ç­¾</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultBeanDefinitionDocumentReader	</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processAliasRegistration</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// è·å–nameå±æ€§å€¼</span>
		<span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">NAME_ATTRIBUTE</span><span class="o">);</span>
    <span class="c1">// è·å–aliaså±æ€§å€¼</span>
		<span class="nc">String</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">ALIAS_ATTRIBUTE</span><span class="o">);</span>
		<span class="kt">boolean</span> <span class="n">valid</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="c1">// éªŒè¯åç§°æ˜¯å¦åˆæ³•</span>
		<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Name must not be empty"</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// éªŒè¯åˆ«åæ˜¯å¦åˆæ³•</span>
		<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">alias</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Alias must not be empty"</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// éªŒè¯é€šè¿‡æ˜ å°„åˆ«å</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">valid</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
        <span class="c1">// æ³¨å†Œåˆ«å</span>
				<span class="n">getReaderContext</span><span class="o">().</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">registerAlias</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">alias</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to register alias '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span>
						<span class="s">"' for bean with name '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// å‘é€äº‹ä»¶</span>
			<span class="n">getReaderContext</span><span class="o">().</span><span class="na">fireAliasRegistered</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">alias</span><span class="o">,</span> <span class="n">extractSource</span><span class="o">(</span><span class="n">ele</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>è·å–nameå±æ€§å€¼</li>
  <li>è·å–aliaså±æ€§å€¼</li>
  <li>éªŒè¯aliasæ˜¯å¦åˆæ³•</li>
  <li>å¦‚æœåˆæ³•åˆ™è¿›è¡Œæ³¨å†Œ</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultBeanDefinitionDocumentReader</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerAlias</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">alias</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"'name' must not be empty"</span><span class="o">);</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">alias</span><span class="o">,</span> <span class="s">"'alias' must not be empty"</span><span class="o">);</span>
		<span class="c1">// åŠ é” å¹¶å‘æ§åˆ¶</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// åˆ¤æ–­ bean åç§°æ˜¯å¦ä¸åˆ«åç›¸åŒ,å¦‚æœç›¸åŒåˆ™å¿½ç•¥</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">alias</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// ç§»é™¤åˆ«å</span>
				<span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Alias definition '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> <span class="s">"' ignored since it points to same name"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="c1">// åˆ¤æ–­åˆ«åæ˜¯å¦å·²å­˜åœ¨</span>
				<span class="nc">String</span> <span class="n">registeredName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">registeredName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// å¦‚æœåˆ«åå¯¹åº”çš„beançš„åç§°ä¸nameç›¸åŒåˆ™å¿½ç•¥</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">registeredName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
						<span class="c1">// An existing alias - no need to re-register</span>
						<span class="k">return</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="c1">// æ˜¯å¦å…è®¸è¦†ç›–,å¦‚æœä¸å…è®¸åˆ™æŠ¥é”™</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">allowAliasOverriding</span><span class="o">())</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Cannot define alias '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> <span class="s">"' for name '"</span> <span class="o">+</span>
								<span class="n">name</span> <span class="o">+</span> <span class="s">"': It is already registered for name '"</span> <span class="o">+</span> <span class="n">registeredName</span> <span class="o">+</span> <span class="s">"'."</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
						<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Overriding alias '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> <span class="s">"' definition for registered name '"</span> <span class="o">+</span>
								<span class="n">registeredName</span> <span class="o">+</span> <span class="s">"' with new target name '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="c1">//æ£€æŸ¥æ˜¯å¦æœ‰å¾ªç¯å¼•ç”¨åˆ«å ä¾‹å¦‚:A-B C-B A-C</span>
				<span class="n">checkForAliasCircle</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">alias</span><span class="o">);</span>
				<span class="c1">//æ˜ å°„åˆ«åå’Œåç§°åˆ°mapä¸­</span>
				<span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">alias</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Alias definition '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> <span class="s">"' registered for name '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•,å¾ªç¯å¼•ç”¨è¿™é‡Œæœ‰ç‚¹æ„æ€.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultBeanDefinitionDocumentReader</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkForAliasCircle</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">alias</span><span class="o">)</span> <span class="o">{</span>
  	<span class="c1">// æ³¨æ„è¿™é‡ŒæŠŠ alias å’Œ name è°ƒæ¢äº†ä¸€ä¸‹ä½ç½®</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hasAlias</span><span class="o">(</span><span class="n">alias</span><span class="o">,</span> <span class="n">name</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Cannot register alias '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span>
					<span class="s">"' for name '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"': Circular reference - '"</span> <span class="o">+</span>
					<span class="n">name</span> <span class="o">+</span> <span class="s">"' is a direct or indirect alias for '"</span> <span class="o">+</span> <span class="n">alias</span> <span class="o">+</span> <span class="s">"' already"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="cm">/**
* ç”±äºè°ƒæ¢è¿‡å‚æ•°é¡ºåº,æ‰€ä»¥ç†è§£çš„æ—¶å€™éœ€è¦è°ƒæ¢å›æ¥
*/</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasAlias</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">alias</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">aliasMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">registeredName</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">registeredName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
				<span class="nc">String</span> <span class="n">registeredAlias</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">registeredAlias</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">alias</span><span class="o">)</span> <span class="o">||</span> <span class="n">hasAlias</span><span class="o">(</span><span class="n">registeredAlias</span><span class="o">,</span> <span class="n">alias</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	å…‰çœ‹ä»£ç ä¼°è®¡ä¼šæ¯”è¾ƒè’™,æ¥ä¸¾ä¾‹çœ‹çœ‹.</p>

<p>â€‹	å‡†å¤‡ä¸‰å¯¹ åˆ«å-&gt;åç§°:</p>

<table>
  <thead>
    <tr>
      <th>alias</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A</td>
      <td>B</td>
    </tr>
    <tr>
      <td>B</td>
      <td>C</td>
    </tr>
    <tr>
      <td>C</td>
      <td>A</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>æ£€æŸ¥ A-&gt;B æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨
    <ul>
      <li>ç”±äºé›†åˆæ˜¯ç©ºçš„,æ‰€ä»¥ä¸å­˜åœ¨å¾ªç¯å¼•ç”¨.</li>
    </ul>
  </li>
  <li>æ£€æŸ¥B-&gt;Cæ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨
    <ul>
      <li>éå†é›†åˆè·å–value: B</li>
      <li>B==B(æ³¨æ„è¿™é‡Œçš„nameå…¶å®æ˜¯alias)</li>
      <li>è·å–é›†åˆä¸­çš„key: A</li>
      <li>A != C æŠŠ A-&gt;Cå½“ä½œå‚æ•°è¿›è¡Œé€’å½’</li>
      <li>é€’å½’æ£€æŸ¥ä¸å­˜åœ¨å¾ªç¯å¼•ç”¨</li>
    </ul>
  </li>
  <li>æ£€æŸ¥C-Aæ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨
    <ul>
      <li>éå†é›†åˆè·å–value: B</li>
      <li>B != C</li>
      <li>éå†é›†åˆè·å–value: C</li>
      <li>C == C</li>
      <li>è·å–é›†åˆä¸­çš„key: B</li>
      <li>B != A,æŠŠB-&gt;Aä½œä¸ºå‚æ•°é€’å½’</li>
      <li>éå†é›†åˆè·å–value: B</li>
      <li>B==B</li>
      <li>è·å–é›†åˆä¸­çš„key: A</li>
      <li>A == A åœæ­¢é€’å½’,è¿”å›true</li>
      <li>å­˜åœ¨å¾ªç¯å¼•ç”¨</li>
    </ul>
  </li>
</ol>

<p>ä¹‹æ‰€ä»¥è¿™ä¸ªé€»è¾‘æœ‰ç‚¹ç»•å› ä¸ºè¿™ä¸ªå‚æ•°è°ƒæ¢äº†ä¸€ä¸‹ä½ç½®,å»ºè®®ç”¨ç¬”ç”»ä¸€ä¸‹å°±è±è¾¾äº†.LOL :).</p>

<h2 id="33-beanæ ‡ç­¾">3.3 beanæ ‡ç­¾</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DefaultBeanDefinitionDocumentReader</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processBeanDefinition</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// è§£æxmlå…ƒç´ </span>
		<span class="nc">BeanDefinitionHolder</span> <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">bdHolder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// è£…é¥°bean</span>
			<span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">decorateBeanDefinitionIfRequired</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bdHolder</span><span class="o">);</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// Register the final decorated instance.</span>
				<span class="c1">// æ³¨å†Œbeanåˆ°å®¹å™¨ä¸­</span>
				<span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">,</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getRegistry</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to register bean definition with name '"</span> <span class="o">+</span>
						<span class="n">bdHolder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// Send registration event.</span>
			<span class="c1">// å‘é€äº‹ä»¶</span>
			<span class="n">getReaderContext</span><span class="o">().</span><span class="na">fireComponentRegistered</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanComponentDefinition</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>è§£æxmlåˆ›å»º<code class="language-plaintext highlighter-rouge">BeanDefinitionHolder</code></li>
  <li>å¦‚æœä¸ä¸ºç©º,è¿›è¡Œè¿›è¡Œè£…é¥°</li>
  <li>æ³¨å†Œåˆ°å®¹å™¨ä¸­</li>
  <li>å‘é€äº‹ä»¶</li>
</ol>

<h3 id="331-parsebeandefinitionelement">3.3.1 parseBeanDefinitionElement()</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// BeanDefinitionParserDelegate</span>
 <span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="nc">BeanDefinitionHolder</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Parses the supplied {@code &lt;bean&gt;} element. May return {@code null}
	 * if there were errors during parse. Errors are reported to the
	 * {@link org.springframework.beans.factory.parsing.ProblemReporter}.
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="nc">BeanDefinitionHolder</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">BeanDefinition</span> <span class="n">containingBean</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// è·å–id</span>
		<span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">ID_ATTRIBUTE</span><span class="o">);</span>
		<span class="c1">// è·å–åç§°</span>
		<span class="nc">String</span> <span class="n">nameAttr</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">NAME_ATTRIBUTE</span><span class="o">);</span>
		<span class="c1">// è·å–åˆ«å,åˆ«åå¯ä»¥ä½¿ç”¨å¤šä¸ª</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">aliases</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
		<span class="c1">// åç§°ä¸ä¸ºç©º</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">nameAttr</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// å¦‚æœæœ‰å¤šä¸ªåç§°,ä½¿ç”¨,;åˆ‡å‰²</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">nameArr</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">tokenizeToStringArray</span><span class="o">(</span><span class="n">nameAttr</span><span class="o">,</span> <span class="no">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="o">);</span>
			<span class="n">aliases</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">nameArr</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="c1">// beanåç§°å°±æ˜¯id</span>
		<span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
		<span class="c1">// å¦‚æœåç§°ä¸ºç©º,å¹¶ä¸”åˆ«åé›†åˆä¸ä¸ºç©º,åˆ™ä»åˆ«åä¸­è·å–ç¬¬ä¸€ä¸ª,ä½œä¸ºåç§°</span>
		<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aliases</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">beanName</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"No XML 'id' specified - using '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
						<span class="s">"' as bean name and "</span> <span class="o">+</span> <span class="n">aliases</span> <span class="o">+</span> <span class="s">" as aliases"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">containingBean</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// æ£€æŸ¥beanNameæ˜¯å¦å”¯ä¸€(åç§°æœªè¢«ä½¿ç”¨è¿‡)</span>
			<span class="n">checkNameUniqueness</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">aliases</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// è§£ææ ‡ç­¾å°è£…ä¸ºbeanDefinition</span>
		<span class="nc">AbstractBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">containingBean</span><span class="o">);</span>
		<span class="c1">// beanDefinitionå¯¹è±¡ä¸ä¸ºç©º</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanDefinition</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// beanNameä¸ºç©º</span>
			<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">containingBean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// ç”Ÿæˆbeançš„ name</span>
						<span class="n">beanName</span> <span class="o">=</span> <span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span>
								<span class="n">beanDefinition</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
            <span class="c1">// ç”Ÿæˆbeançš„ name</span>
						<span class="n">beanName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">);</span>
						<span class="c1">// Register an alias for the plain bean class name, if still possible,</span>
						<span class="c1">// if the generator returned the class name plus a suffix.</span>
						<span class="c1">// This is expected for Spring 1.2/2.0 backwards compatibility.</span>
            <span class="c1">// è·å– className</span>
						<span class="nc">String</span> <span class="n">beanClassName</span> <span class="o">=</span> <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">();</span>
            <span class="c1">// åˆ¤æ–­beanåç§°ä¸ä¸ºç©º å¹¶ä¸” ä»¥ç±»åå¼€å¤´ å¹¶ä¸”åç§°æ²¡æœ‰è¢«ä½¿ç”¨</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">beanClassName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
								<span class="n">beanName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">beanClassName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
								<span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">isBeanNameInUse</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">))</span> <span class="o">{</span>
							<span class="n">aliases</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
						<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Neither XML 'id' nor 'name' specified - "</span> <span class="o">+</span>
								<span class="s">"using generated bean name ["</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">error</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ele</span><span class="o">);</span>
					<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="c1">// åˆ«åé›†åˆè½¬ä¸ºæ•°ç»„</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">aliasesArray</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">toStringArray</span><span class="o">(</span><span class="n">aliases</span><span class="o">);</span>
			<span class="c1">// è¿”å›BeanDefinitionHolder</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">aliasesArray</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä»¥ä¸Šä»£ç é€»è¾‘ä¸æ˜¯å¾ˆå¤æ‚,æ ¸å¿ƒé€»è¾‘åœ¨äºé€šè¿‡<code class="language-plaintext highlighter-rouge">AbstractBeanDefinition</code>è½¬æ¢ä¸º<code class="language-plaintext highlighter-rouge">BeanDefinitionHolder</code>,æ ¸å¿ƒä»£ç <code class="language-plaintext highlighter-rouge">AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</code></p>

<h1 id="å››å°ç»“">å››ã€å°ç»“</h1>

<p>â€‹	ç”±äºåé¢çš„é€»è¾‘æ¯”è¾ƒå¤æ‚,æ‰“ç®—åˆ†ä¸¤ç« æ¥å†™,å¤©è‰²å·²æ™š,å‡†å¤‡åƒé¥­.</p>

:ET