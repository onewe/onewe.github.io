I"ÊK<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>â€‹	beanæ˜¯åˆ›å»ºå¥½äº†,ä½†è¿˜éœ€è¦ä¸€äº›å±æ€§å¡«å……,åˆå§‹åŒ–ç­‰æ“ä½œ.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1">// å±æ€§å¡«å……</span>
	<span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
	<span class="c1">// åˆå§‹åŒ–bean</span>
	<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
</code></pre></div></div>

<h1 id="äºŒpopulatebean">äºŒã€populateBean</h1>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">BeanWrapper</span> <span class="n">bw</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// è·³è¿‡ null bean èµ‹å€¼</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">bw</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">hasPropertyValues</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
						<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Cannot apply property values to null instance"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="c1">// Skip property population phase for null instance.</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span>
		<span class="c1">// state of the bean before properties are set. This can be used, for example,</span>
		<span class="c1">// to support styles of field injection.</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯æ‹¥æœ‰InstantiationAwareBeanPostProcessor</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">hasInstantiationAwareBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// éå†æ‰€æœ‰BeanPostProcessor</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">BeanPostProcessor</span> <span class="n">bp</span> <span class="o">:</span> <span class="n">getBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// é’ˆå¯¹InstantiationAwareBeanPostProcessor è¿›è¡Œè°ƒç”¨</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">bp</span> <span class="k">instanceof</span> <span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">InstantiationAwareBeanPostProcessor</span> <span class="n">ibp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="n">bp</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">ibp</span><span class="o">.</span><span class="na">postProcessAfterInstantiation</span><span class="o">(</span><span class="n">bw</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
						<span class="k">return</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="nc">PropertyValues</span> <span class="n">pvs</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">hasPropertyValues</span><span class="o">()</span> <span class="o">?</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>

		<span class="c1">// è·å–è‡ªåŠ¨æ³¨å…¥æ¨¡å¼</span>
		<span class="kt">int</span> <span class="n">resolvedAutowireMode</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getResolvedAutowireMode</span><span class="o">();</span>
		<span class="c1">// æ ¹æ®åç§° æˆ–è€… ç±»å‹ è‡ªåŠ¨æ³¨å…¥</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">resolvedAutowireMode</span> <span class="o">==</span> <span class="no">AUTOWIRE_BY_NAME</span> <span class="o">||</span> <span class="n">resolvedAutowireMode</span> <span class="o">==</span> <span class="no">AUTOWIRE_BY_TYPE</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">MutablePropertyValues</span> <span class="n">newPvs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutablePropertyValues</span><span class="o">(</span><span class="n">pvs</span><span class="o">);</span>
			<span class="c1">// Add property values based on autowire by name if applicable.</span>
			<span class="c1">// å¤„ç†æ ¹æ®åç§°æ³¨å…¥</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resolvedAutowireMode</span> <span class="o">==</span> <span class="no">AUTOWIRE_BY_NAME</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">autowireByName</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bw</span><span class="o">,</span> <span class="n">newPvs</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// Add property values based on autowire by type if applicable.</span>
			<span class="c1">// å¤„ç†æ ¹æ®ç±»å‹æ³¨å…¥</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resolvedAutowireMode</span> <span class="o">==</span> <span class="no">AUTOWIRE_BY_TYPE</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">autowireByType</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bw</span><span class="o">,</span> <span class="n">newPvs</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">pvs</span> <span class="o">=</span> <span class="n">newPvs</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kt">boolean</span> <span class="n">hasInstAwareBpps</span> <span class="o">=</span> <span class="n">hasInstantiationAwareBeanPostProcessors</span><span class="o">();</span>
		<span class="c1">// æ˜¯å¦éœ€è¦ä¾èµ–æ£€æŸ¥</span>
		<span class="kt">boolean</span> <span class="n">needsDepCheck</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getDependencyCheck</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">AbstractBeanDefinition</span><span class="o">.</span><span class="na">DEPENDENCY_CHECK_NONE</span><span class="o">);</span>

		<span class="nc">PropertyDescriptor</span><span class="o">[]</span> <span class="n">filteredPds</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="c1">// BeanPostProcessor å¤„ç†</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hasInstAwareBpps</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">pvs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">pvs</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="c1">// éå†æ‰€æœ‰çš„ BeanPostProcessor</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">BeanPostProcessor</span> <span class="n">bp</span> <span class="o">:</span> <span class="n">getBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">bp</span> <span class="k">instanceof</span> <span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">InstantiationAwareBeanPostProcessor</span> <span class="n">ibp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="n">bp</span><span class="o">;</span>
					<span class="nc">PropertyValues</span> <span class="n">pvsToUse</span> <span class="o">=</span> <span class="n">ibp</span><span class="o">.</span><span class="na">postProcessProperties</span><span class="o">(</span><span class="n">pvs</span><span class="o">,</span> <span class="n">bw</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">pvsToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">filteredPds</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">filteredPds</span> <span class="o">=</span> <span class="n">filterPropertyDescriptorsForDependencyCheck</span><span class="o">(</span><span class="n">bw</span><span class="o">,</span> <span class="n">mbd</span><span class="o">.</span><span class="na">allowCaching</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="n">pvsToUse</span> <span class="o">=</span> <span class="n">ibp</span><span class="o">.</span><span class="na">postProcessPropertyValues</span><span class="o">(</span><span class="n">pvs</span><span class="o">,</span> <span class="n">filteredPds</span><span class="o">,</span> <span class="n">bw</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">pvsToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="k">return</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="n">pvs</span> <span class="o">=</span> <span class="n">pvsToUse</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// ä¾èµ–æ£€æŸ¥</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">needsDepCheck</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">filteredPds</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">filteredPds</span> <span class="o">=</span> <span class="n">filterPropertyDescriptorsForDependencyCheck</span><span class="o">(</span><span class="n">bw</span><span class="o">,</span> <span class="n">mbd</span><span class="o">.</span><span class="na">allowCaching</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">checkDependencies</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">filteredPds</span><span class="o">,</span> <span class="n">pvs</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// å°†å±æ€§åº”ç”¨åˆ° bean ä¸­</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">pvs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">applyPropertyValues</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bw</span><span class="o">,</span> <span class="n">pvs</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	å¯ä»¥çœ‹åˆ°<code class="language-plaintext highlighter-rouge">InstantiationAwareBeanPostProcessor</code>å¯¹è±¡çš„è°ƒç”¨æ—¶æœºåˆ†åˆ«æ˜¯åœ¨åˆ›å»ºå¯¹è±¡åè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">postProcessAfterInstantiation</code>æ–¹æ³•,åœ¨æ³¨å…¥å®Œäº†åè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">postProcessProperties</code>æ–¹æ³•,éšå³å¡«å……å±æ€§.</p>

<h1 id="ä¸‰initializebean">ä¸‰ã€initializeBean</h1>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">initializeBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">((</span><span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
				<span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// å¯¹å®ç°Awareæ¥å£çš„ç±»è¿›è¡Œæ³¨å…¥ä¾‹å¦‚BeanFactoryAwareç­‰æ¥å£</span>
			<span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nc">Object</span> <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// å‰ç½®å¤„ç†</span>
			<span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsBeforeInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// è°ƒç”¨ç”¨æˆ·çš„initæ–¹æ³•</span>
			<span class="n">invokeInitMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">wrappedBean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
					<span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">),</span>
					<span class="n">beanName</span><span class="o">,</span> <span class="s">"Invocation of init method failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// åç½®å¤„ç†</span>
			<span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">return</span> <span class="n">wrappedBean</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>å¯¹å®ç°Awareæ¥å£çš„è¿›è¡Œæ³¨å…¥</li>
  <li>è°ƒç”¨PostProcessorçš„å‰ç½®æ–¹æ³•<code class="language-plaintext highlighter-rouge">postProcessBeforeInitialization</code></li>
  <li>åˆå§‹åŒ–bean åˆå§‹åŒ–æ–¹æ³•</li>
  <li>åˆå§‹åŒ–å®Œæ¯•åè°ƒç”¨PostProcessorsçš„åç½®æ–¹æ³•<code class="language-plaintext highlighter-rouge">postProcessAfterInitialization</code></li>
</ol>

<p>å•åˆ©çš„åˆ›å»ºæµç¨‹è®°å½•å®Œæ¯•,å…¶ä»–scopeçš„åˆ›å»ºæ–¹å¼éƒ½æ˜¯å¤§åŒå°å¼‚,ä¸å†é‡å¤è®°å½•.</p>

<h1 id="å››å°ç»“">å››ã€å°ç»“</h1>

<p>â€‹	åˆ›å»ºçš„è¿‡ç¨‹ç»ˆäºèµ°å®Œäº†:)</p>
:ET