I"N<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>â€‹	èµ„æºç»Ÿä¸€æŠ½è±¡ä¸º<code class="language-plaintext highlighter-rouge">Resource</code>å¯¹è±¡.å¯æ›¾è®°å¾—åœ¨ spring é…ç½®æ–‡ä»¶ä¸­çš„è¿™ç§å†™æ³•:<code class="language-plaintext highlighter-rouge">classpath:com/sjr/test/bean/MyTestBean.xml</code>,é‚£ä¹ˆè¿™ç§å†™æ³•çš„æ„æ€æ˜¯ä»classpathè·¯å¾„ä¸‹åŠ è½½xml,é‚£ä¹ˆspringæ˜¯å¦‚ä½•å®šä½åˆ°æ–‡ä»¶çš„?</p>

<p>â€‹	ä¸Šé¢è¿™ç§å†™æ³•ç›¸å½“äºæ˜¯ä¸ªåè®®,åœ¨springä¸­é»˜è®¤æ”¯æŒ9ç§æ–‡ä»¶åè®®.</p>

<ul>
  <li>
    <p>URL_PROTOCOL_FILE</p>

    <p>ä»æ–‡ä»¶ç³»ç»Ÿä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_JAR</p>

    <p>ä»jaråŒ…ä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_WAR</p>

    <p>ä»waråŒ…ä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_ZIP</p>

    <p>ä»zipä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_WSJAR</p>

    <p>ä»wsjarä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_VFSZIP</p>

    <p>ä»vfszipä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_VFSFILE</p>

    <p>ä»vfsfileä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
  <li>
    <p>URL_PROTOCOL_VFS</p>

    <p>ä»vfsä¸­åŠ è½½æ–‡ä»¶</p>
  </li>
</ul>

<h1 id="äºŒåˆ†æ">äºŒã€åˆ†æ</h1>

<p>â€‹	è¿™ä¸ªæ•…äº‹è¦ä»ä¸€æ®µä»£ç å¼€å§‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringResourceLoader</span><span class="o">(){</span>
		<span class="nc">DefaultResourceLoader</span> <span class="n">defaultResourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="n">defaultResourceLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">"classpath:com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä¹‹å‰çš„ä»£ç ,æˆ‘ä»¬æ˜¯ç›´æ¥ä½¿ç”¨çš„<code class="language-plaintext highlighter-rouge">ClassPathResource</code>æ¥åŠ è½½æ–‡ä»¶,è¿™é‡Œä½¿ç”¨çš„<code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code>å¯¹è±¡æ¥åŠ è½½æ–‡ä»¶.é‚£<code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code>æœ‰ä»€ä¹ˆç”¨å¤„å‘¢?</p>

<ol>
  <li>è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶è¯¥å¦‚ä½•åŠ è½½</li>
</ol>

 	2. ç®€åŒ–æ–‡ä»¶åŠ è½½æ“ä½œæµç¨‹

<h2 id="21-defaultresourceloader">2.1 DefaultResourceLoader</h2>

<p>â€‹	<code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code> æ˜¯<code class="language-plaintext highlighter-rouge">ResourceLoader</code>çš„é»˜è®¤å®ç°.</p>

<p><img src="https://itinfo.oss-cn-hongkong.aliyuncs.com/img/yQS6mB.jpg" alt="yQS6mB" /></p>

<p>ä¸Šå›¾å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code> è¿˜æœ‰3ä¸ªå­ç±»è¿›è¡Œäº†åŠŸèƒ½çš„æ‰©å±•.å…ˆçœ‹çœ‹<code class="language-plaintext highlighter-rouge">ResourceLoader</code>è¿™ä¸ªæ¥å£.</p>

<h2 id="22-resourceloader">2.2 ResourceLoader</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ResourceLoader</span> <span class="o">{</span>

	<span class="cm">/**
	 *  classpath: å‰ç¼€å¸¸é‡
	 * */</span>
	<span class="nc">String</span> <span class="no">CLASSPATH_URL_PREFIX</span> <span class="o">=</span> <span class="nc">ResourceUtils</span><span class="o">.</span><span class="na">CLASSPATH_URL_PREFIX</span><span class="o">;</span>


	<span class="cm">/**
	 * é€šè¿‡ è·¯å¾„ è·å– Resource å¯¹è±¡
	 */</span>
	<span class="nc">Resource</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">location</span><span class="o">);</span>

	<span class="cm">/**
	 * è·å–ç±»åŠ è½½å™¨
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="nc">ClassLoader</span> <span class="nf">getClassLoader</span><span class="o">();</span>

<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	ä»ä»£ç å¯ä»¥çœ‹å‡º,è¯¥æ¥å£åªæœ‰2ä¸ªæ–¹æ³•,ä¸€ä¸ªæ˜¯é€šè¿‡è·¯å¾„è·å– <code class="language-plaintext highlighter-rouge">Resource</code> å¯¹è±¡,å¦å¤–ä¸€ä¸ªæ˜¯è·å–ç±»åŠ è½½å™¨.é‚£ä¹ˆåœ¨æ¥çœ‹çœ‹ <code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code> çš„é»˜è®¤å®ç°ä»£ç å§.</p>

<h2 id="23-defaultresourceloader-å…·ä½“å®ç°">2.3 DefaultResourceLoader å…·ä½“å®ç°</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultResourceLoader</span> <span class="kd">implements</span> <span class="nc">ResourceLoader</span> <span class="o">{</span>

	<span class="nd">@Nullable</span>
	<span class="kd">private</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">;</span>
	<span class="c1">// åè®®è§£æå™¨ set</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ProtocolResolver</span><span class="o">&gt;</span> <span class="n">protocolResolvers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>
	<span class="c1">// ç¼“å­˜</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Resource</span><span class="o">,</span> <span class="o">?&gt;&gt;</span> <span class="n">resourceCaches</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>


	<span class="cm">/**
	 * ä½¿ç”¨é»˜è®¤æ„é€ å™¨,é»˜è®¤æ„é€ å™¨ä¸­ä½¿ç”¨é»˜è®¤çš„ç±»åŠ è½½å™¨
	 */</span>
	<span class="kd">public</span> <span class="nf">DefaultResourceLoader</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">=</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getDefaultClassLoader</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * ä½¿ç”¨æŒ‡å®šçš„ç±»åŠ è½½å™¨
	 */</span>
	<span class="kd">public</span> <span class="nf">DefaultResourceLoader</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">;</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * è®¾ç½®ç±»åŠ è½½å™¨
	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClassLoader</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–ç±»åŠ è½½å™¨
	 */</span>
	<span class="nd">@Override</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="nc">ClassLoader</span> <span class="nf">getClassLoader</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">classLoader</span> <span class="o">:</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getDefaultClassLoader</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * æ·»åŠ åè®®è§£æå™¨
	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addProtocolResolver</span><span class="o">(</span><span class="nc">ProtocolResolver</span> <span class="n">resolver</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">resolver</span><span class="o">,</span> <span class="s">"ProtocolResolver must not be null"</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">protocolResolvers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–åè®®è§£æå™¨é›†åˆ
	 */</span>
	<span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ProtocolResolver</span><span class="o">&gt;</span> <span class="nf">getProtocolResolvers</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">protocolResolvers</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–èµ„æºç¼“å­˜
	 */</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Resource</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="nf">getResourceCache</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">valueType</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Resource</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;)</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceCaches</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">valueType</span><span class="o">,</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;());</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * æ¸…é™¤æ‰€æœ‰èµ„æºç¼“å­˜
	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearResourceCaches</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">resourceCaches</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * è·å–èµ„æº
	 * **/</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Resource</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="s">"Location must not be null"</span><span class="o">);</span>
		<span class="c1">// éå†æ‰€æœ‰åè®®è§£æå™¨</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">ProtocolResolver</span> <span class="n">protocolResolver</span> <span class="o">:</span> <span class="n">getProtocolResolvers</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// è§£æèµ„æº</span>
			<span class="nc">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">protocolResolver</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
			<span class="c1">// å¦‚æœèµ„æºè§£æåˆ°åˆ™è¿”å› resource å¯¹è±¡</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">resource</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯/å¼€å¤´</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/"</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// è·å–classpathä¸Šä¸‹æ–‡ä¸­çš„èµ„æº</span>
			<span class="k">return</span> <span class="nf">getResourceByPath</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯classpath:å¼€å¤´è·¯å¾„,å¦‚æœæ˜¯åˆ™ä»classpathä¸­è·å–èµ„æº</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">CLASSPATH_URL_PREFIX</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">ClassPathResource</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="no">CLASSPATH_URL_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">()),</span> <span class="n">getClassLoader</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// å°è¯•æŠŠè·¯å¾„è½¬åŒ–ä¸ºurl</span>
				<span class="c1">// Try to parse the location as a URL...</span>
				<span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
				<span class="c1">// åˆ¤æ–­æ˜¯æ–‡ä»¶èµ„æº è¿˜æ˜¯urlèµ„æº</span>
				<span class="k">return</span> <span class="o">(</span><span class="nc">ResourceUtils</span><span class="o">.</span><span class="na">isFileURL</span><span class="o">(</span><span class="n">url</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">FileUrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">UrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">MalformedURLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// No URL -&gt; resolve as resource path.</span>
				<span class="c1">// éurl å°è¯•ä» classpath ä¸Šä¸‹æ–‡ä¸­è·å–èµ„æº</span>
				<span class="k">return</span> <span class="nf">getResourceByPath</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * é€šè¿‡è·¯å¾„è·å– Resource å¯¹è±¡
	 * ä» classPath ä¸­åŠ è½½æ–‡ä»¶
	 */</span>
	<span class="kd">protected</span> <span class="nc">Resource</span> <span class="nf">getResourceByPath</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ClassPathContextResource</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">getClassLoader</span><span class="o">());</span>
	<span class="o">}</span>


	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ClassPathContextResource</span> <span class="kd">extends</span> <span class="nc">ClassPathResource</span> <span class="kd">implements</span> <span class="nc">ContextResource</span> <span class="o">{</span>

		<span class="kd">public</span> <span class="nf">ClassPathContextResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
			<span class="kd">super</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPathWithinContext</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nf">getPath</span><span class="o">();</span>
		<span class="o">}</span>
		
    <span class="cm">/**
    * åˆ›å»ºç›¸å¯¹è·¯å¾„çš„ Resource å¯¹è±¡
    */</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">Resource</span> <span class="nf">createRelative</span><span class="o">(</span><span class="nc">String</span> <span class="n">relativePath</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">pathToUse</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">applyRelativePath</span><span class="o">(</span><span class="n">getPath</span><span class="o">(),</span> <span class="n">relativePath</span><span class="o">);</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">ClassPathContextResource</span><span class="o">(</span><span class="n">pathToUse</span><span class="o">,</span> <span class="n">getClassLoader</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	ä»¥ä¸Šä»£ç çš„é€»è¾‘æ¯”è¾ƒç®€å•æ˜äº†,æ ¸å¿ƒé€»è¾‘åœ¨ <code class="language-plaintext highlighter-rouge">getResource</code> è¿™ä¸ªæ–¹æ³•ä¸­.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="kd">public</span> <span class="nc">Resource</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="s">"Location must not be null"</span><span class="o">);</span>
		<span class="c1">// éå†æ‰€æœ‰åè®®è§£æå™¨</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">ProtocolResolver</span> <span class="n">protocolResolver</span> <span class="o">:</span> <span class="n">getProtocolResolvers</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// è§£æèµ„æº</span>
			<span class="nc">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">protocolResolver</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
			<span class="c1">// å¦‚æœèµ„æºè§£æåˆ°åˆ™è¿”å› resource å¯¹è±¡</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">resource</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯/å¼€å¤´</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/"</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// è·å–classpathä¸Šä¸‹æ–‡ä¸­çš„èµ„æº</span>
			<span class="k">return</span> <span class="nf">getResourceByPath</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯classpath:å¼€å¤´è·¯å¾„,å¦‚æœæ˜¯åˆ™ä»classpathä¸­è·å–èµ„æº</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">CLASSPATH_URL_PREFIX</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">ClassPathResource</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="no">CLASSPATH_URL_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">()),</span> <span class="n">getClassLoader</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// å°è¯•æŠŠè·¯å¾„è½¬åŒ–ä¸ºurl</span>
				<span class="c1">// Try to parse the location as a URL...</span>
				<span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
				<span class="c1">// åˆ¤æ–­æ˜¯æ–‡ä»¶èµ„æº è¿˜æ˜¯urlèµ„æº</span>
				<span class="k">return</span> <span class="o">(</span><span class="nc">ResourceUtils</span><span class="o">.</span><span class="na">isFileURL</span><span class="o">(</span><span class="n">url</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">FileUrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">UrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">MalformedURLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// No URL -&gt; resolve as resource path.</span>
				<span class="c1">// éurl å°è¯•ä» classpath ä¸Šä¸‹æ–‡ä¸­è·å–èµ„æº</span>
				<span class="k">return</span> <span class="nf">getResourceByPath</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	é€»è¾‘æµç¨‹ä¸ºä»¥ä¸‹å‡ æ­¥:</p>

<ol>
  <li>
    <p>åˆ¤æ–­æ˜¯å¦è®¾ç½®äº† åè®®è§£æå™¨,å¦‚æœè®¾ç½®äº†,åˆ™éå†æ‰€æœ‰çš„åè®®è§£æ,</p>

    <p>å¹¶è§£ææ–‡ä»¶,å¦‚æœè§£ææˆåŠŸåˆ™è¿”å› Resource å¯¹è±¡å¦åˆ™æ‰§è¡Œç¬¬äºŒæ­¥.</p>

    <ol>
      <li>åˆ¤æ–­è·¯å¾„æ˜¯å¦æ˜¯ <code class="language-plaintext highlighter-rouge">/ </code> å¼€å¤´,è‹¥æ˜¯åˆ™ä»classPath åŠ è½½æ–‡ä»¶,è°ƒç”¨</li>
    </ol>

    <p><code class="language-plaintext highlighter-rouge">getResourceByPath</code>æ–¹æ³•,è¿”å› <code class="language-plaintext highlighter-rouge">Resource</code> å¯¹è±¡</p>

    <ol>
      <li>
        <p>åˆ¤æ–­æ˜¯å¦æ˜¯ <code class="language-plaintext highlighter-rouge">classpath:</code> å¼€å¤´,è‹¥æ˜¯åˆ™ä» classPath åŠ è½½æ–‡ä»¶</p>
      </li>
      <li>
        <p>è‹¥æ˜¯ä»¥ä¸Šå‡ æ­¥éƒ½å¤±è´¥,åˆ™å°è¯•æŠŠè·¯å¾„è½¬ä¸ºURL,å¦‚æœæˆåŠŸåˆ™è¿”å›</p>
      </li>
    </ol>

    <p><code class="language-plaintext highlighter-rouge">FileUrlResource</code> æˆ– <code class="language-plaintext highlighter-rouge">UrlResource</code> å¯¹è±¡</p>

    <ol>
      <li>æœ€åæŒ£æ‰ä»¥ä¸‹,ä»classPath åŠ è½½æ–‡ä»¶</li>
    </ol>
  </li>
</ol>

<h2 id="24-fileurlresource">2.4 FileUrlResource</h2>

<p>â€‹	å¼€ç¯‡è¯´é“ spring é»˜è®¤æ”¯æŒ 9ä¸­åè®®(å¦‚æœæŠŠ classPath ä¹Ÿç®—ä¸Šçš„è¯),é‚£ä¹ˆé™¤äº† å¸¸ç”¨çš„ classPath ä»¥å¤–,å…¶ä»–çš„æ€ä¹ˆä½¿ç”¨å‘¢?å…¶ä»–çš„ç¬”è€…æœ¬äººéƒ½æ²¡ç”¨è¿‡å¤šå°‘,å°±æ¥çœ‹çœ‹ file åè®®å§.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringResourceLoaderForFileProtocol</span><span class="o">(){</span>
		<span class="nc">DefaultResourceLoader</span> <span class="n">defaultResourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="n">defaultResourceLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">"file:///src/test/resources/com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ç›¸å½“äºæ˜¯ä¸ªç»å¯¹è·¯å¾„äº†.å…¶ä»–åè®®å¯ä»¥æŸ¥æŸ¥èµ„æ–™.</p>

<h1 id="ä¸‰è‡ªå®šä¹‰æ–‡ä»¶åè®®è§£æå™¨">ä¸‰ã€è‡ªå®šä¹‰æ–‡ä»¶åè®®è§£æå™¨</h1>

<p>â€‹	åœ¨<code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code> ä¸­çš„æ ¸å¿ƒä»£ç ä¸­æœ‰æ®µéå†è§£æå™¨çš„ä»£ç ,æ¥ç§ç§.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		<span class="c1">// éå†æ‰€æœ‰åè®®è§£æå™¨</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">ProtocolResolver</span> <span class="n">protocolResolver</span> <span class="o">:</span> <span class="n">getProtocolResolvers</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// è§£æèµ„æº</span>
			<span class="nc">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">protocolResolver</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
			<span class="c1">// å¦‚æœèµ„æºè§£æåˆ°åˆ™è¿”å› resource å¯¹è±¡</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">resource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">resource</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	é€šè¿‡è¿™æ®µä»£ç ,å¯ä»¥å®ç°è‡ªå®šä¹‰æ–‡ä»¶åè®®è§£æå™¨çš„é€»è¾‘,æ–¹ä¾¿æ‰©å±•.<code class="language-plaintext highlighter-rouge">ProtocolResolver</code>æ˜¯ä¸ªæ¥å£,é‡Œé¢å°±ä¸€ä¸ªæ–¹æ³•,éå¸¸ç®€å•.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProtocolResolver</span> <span class="o">{</span>

	<span class="cm">/**
	 * è§£æ
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="nc">Resource</span> <span class="nf">resolve</span><span class="o">(</span><span class="nc">String</span> <span class="n">location</span><span class="o">,</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">);</span>

<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	è¯¥æ¥å£ä¹Ÿæ˜¯ä¸ªå‡½æ•°æ¥å£(å¯ä»¥ä½¿ç”¨Lambdaè¡¨è¾¾å¼).æ¥å®ç°ä¸€ä¸ªåè®®è¯•ä¸€è¯•.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å®ç°ProtocolResolver æ¥å£ è‡ªå®šä¹‰è§£æé€»è¾‘</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SjrProtocolResolver</span> <span class="kd">implements</span> <span class="nc">ProtocolResolver</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Resource</span> <span class="nf">resolve</span><span class="o">(</span><span class="nc">String</span> <span class="n">location</span><span class="o">,</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span><span class="o">(</span><span class="n">resourceLoader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span><span class="o">(</span><span class="n">location</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">location</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"sjr"</span><span class="o">)){</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"sjr:"</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">4</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSpringProtocolResolverOfAdv</span><span class="o">(){</span>
		<span class="nc">DefaultResourceLoader</span> <span class="n">defaultResourceLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
		<span class="n">defaultResourceLoader</span><span class="o">.</span><span class="na">addProtocolResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">SjrProtocolResolver</span><span class="o">());</span>
		<span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="n">defaultResourceLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">"sjr:com/sjr/test/bean/MyTestBean.xml"</span><span class="o">));</span>
		<span class="kd">final</span> <span class="nc">MyTestBean</span> <span class="n">testBean</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myTestBean"</span><span class="o">,</span><span class="nc">MyTestBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="kd">final</span> <span class="nc">String</span> <span class="n">testStr</span> <span class="o">=</span> <span class="n">testBean</span><span class="o">.</span><span class="na">getTestStr</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testStr</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™æ ·å°±å®Œæˆäº†è‡ªå®šä¹‰åè®®çš„è§£æ.</p>

<p>â€‹	<code class="language-plaintext highlighter-rouge">DefaultResourceLoader</code> è¿˜æœ‰ä¸‰ä¸ªå­ç±»:</p>

<ul>
  <li>
    <p>ServletContextResourceLoader</p>

    <p>è¿”å›<code class="language-plaintext highlighter-rouge">ServletContextResource</code>,ä»<code class="language-plaintext highlighter-rouge">ServletContext</code>è·å–èµ„æº.</p>
  </li>
  <li>
    <p>FileSystemResourceLoader</p>

    <p>è¿”å›<code class="language-plaintext highlighter-rouge">FileSystemContextResource</code> ,ä»æ–‡ä»¶ç³»ç»Ÿä¸­è·å–èµ„æº,</p>

    <p>å…¶æœ¬è´¨ä¸Šæ˜¯<code class="language-plaintext highlighter-rouge">FileSystemResource</code>,å®ç°äº†<code class="language-plaintext highlighter-rouge">ContextResource</code>æ¥å£</p>
  </li>
  <li>
    <p>ClassRelativeResourceLoader</p>

    <p>è¿”å›<code class="language-plaintext highlighter-rouge">ClassRelativeContextResource</code> ,ä»classPathè·å–èµ„æº,</p>

    <p>å…¶æœ¬è´¨ä¸Šæ˜¯<code class="language-plaintext highlighter-rouge">ClassPathResource</code>,å®ç°äº†<code class="language-plaintext highlighter-rouge">ContextResource</code>æ¥å£</p>

    <p>è¿™ä¸‰ä¸ªå­ç±»,éƒ½æ˜¯åšçš„ç®€å•æ‰©å±•,é€»è¾‘ç®€å•,æœ‰å…´è¶£å¯ä»¥å»çœ‹çœ‹.</p>
  </li>
</ul>

<h1 id="å››å°ç»“">å››ã€å°ç»“</h1>

<p>â€‹	æ–‡ä»¶æ˜¯åŠ è½½åˆ°,é‚£ä¹ˆspring æ˜¯æ€ä¹ˆè§£æxmlæ–‡ä»¶çš„å‘¢?</p>
:ET