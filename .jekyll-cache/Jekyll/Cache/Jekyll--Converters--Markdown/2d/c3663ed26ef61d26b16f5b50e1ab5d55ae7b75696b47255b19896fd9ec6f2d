I"±´<h1 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h1>

<p>â€‹	æœ€è¿‘æœ‰å°æœ‹å‹åœ¨å­¦ä¹ spring bootçš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜,æŒ‰ç…§æ•™ç¨‹ä¸Šæ“ä½œå§‹ç»ˆæ˜¯404.äºæ˜¯å°±ç™¾äº‹ä¸å¾—å…¶è§£.é—®æˆ‘çš„æ—¶å€™,æˆ‘ä¹Ÿä¸€è„¸è’™B,æ¯•ç«Ÿjspè¿™ç©æ„å„¿å¥½ä¹…éƒ½æ²¡ç¢°åˆ°è¿‡äº†,ä¹‹å‰ç¢°jspçš„æ—¶å€™è¿˜æ˜¯åœ¨sshçš„æ—¶å€™.</p>

<p>â€‹	æ—¢ç„¶é‡åˆ°é—®é¢˜å°±æ¥åˆ†æä¸€ä¸‹å‘—,è¶ç€æœ€è¿‘åœ¨çœ‹springçš„æºç .</p>

<h1 id="äºŒæ¡ˆå‘ç°åœº">äºŒã€æ¡ˆå‘ç°åœº</h1>

<p>ymal:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">mvc</span><span class="pi">:</span>
    <span class="na">view</span><span class="pi">:</span>
      <span class="na">prefix</span><span class="pi">:</span> <span class="s">/WEB-INF/jsp/</span>
      <span class="na">suffix</span><span class="pi">:</span> <span class="s">.jsp</span>
</code></pre></div></div>

<p>pom:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-aop<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-jasper<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jstl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>

    <span class="nt">&lt;/build&gt;</span>
</code></pre></div></div>

<p>ä»£ç :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">App</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	æŒ‰ç…§ä»¥ä¸Šä»£ç ,åº”è¯¥æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„,æ¯•ç«Ÿäººå®¶çš„æ•™ç¨‹ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„,åªä¸è¿‡åˆ«äººæ˜¯ç”¨eclipse,ä»–æ˜¯ç”¨çš„ideaç½¢äº†.æˆ‘ä¹Ÿæ‡’å¾—å»åˆ†æä¸ºå•¥eclipseæ²¡å¾—é—®é¢˜äº†,ç›´æ¥æ¥çœ‹çœ‹ä¸ºå•¥ä¼šæœ‰è¿™ä¸ªé—®é¢˜.</p>

<h1 id="ä¸‰åˆ†æ">ä¸‰ã€åˆ†æ</h1>

<p>â€‹	ä¼—æ‰€å‘¨çŸ¥,spring bootåªæ˜¯åœ¨springä¸Šé¢åŒ…äº†ä¸€å±‚çš®,é‡Œé¢è¿˜æ˜¯åˆ©ç”¨äº†springçš„ä¸€äº›æœºåˆ¶æ¥å®Œæˆ,å½“ç„¶åŠ è½½è‡ªåŠ¨åŒ–é…ç½®,å¼€ç®±å³ç”¨,æ„Ÿè§‰å¾ˆæ™ºèƒ½.</p>

<p>â€‹	springbootä¸ºæˆ‘ä»¬å¼€å‘è€…çœå»äº†å¾ˆå¤šé…ç½®ä¸Šçš„éº»çƒ¦,å¤§éƒ¨åˆ†éƒ½é»˜è®¤é…ç½®å¥½äº†,ä½†æ˜¯è™½ç„¶ä¾¿åˆ©äº†å¼€å‘è€…,ä½†ä¹Ÿå¸¦æ¥äº†ä¸€äº›éº»çƒ¦,å°±å¦‚è¿™ä¸ªé—®é¢˜,æ•´ä¸ªæ—¥å­è¾“å‡ºçª—å£éƒ½æ²¡æœ‰æ—¥å¿—æ˜¾ç¤ºä¸ºå•¥ä¼šæ˜¯404,æ–‡ä»¶æ˜æ˜åœ¨é‚£,ä¸ºå•¥ä¼šæ‰¾ä¸åˆ°å‘¢?</p>

<p>â€‹	è¦è§£å†³è¿™ä¸ªé—®é¢˜,å°±è¦ä»springBootçš„è‡ªåŠ¨é…ç½®ä¸Šå…¥æ‰‹.æŒ‰ç…§ä¸Šé¢çš„é…ç½®,ç”¨çš„æ˜¯åµŒå…¥å¼çš„tomcat,é‚£ä¹ˆå°±ä»tomcatçš„é…ç½®å¼€å§‹.</p>

<h2 id="31-servletwebserverfactoryconfiguration">3.1 ServletWebServerFactoryConfiguration</h2>

<p>â€‹	å½“ä½¿ç”¨springbootçš„wenåŠŸèƒ½çš„æ—¶å€™,æœ‰ä¸ªå…³é”®çš„é…ç½®å°±é¿å…ä¸äº†äº†,ä»£ç å¦‚ä¸‹:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">ServletWebServerFactoryConfiguration</span> <span class="o">{</span>
  
		<span class="c1">// åˆ¤æ–­classpathæ˜¯å¦å­˜åœ¨ Servlet,Tomcat,UpgradeProtocolç±»</span>
   <span class="c1">// å¦‚æœå­˜åœ¨å°±å¯ç”¨æ­¤é…ç½®</span>
   <span class="c1">// å½“ç„¶è¿˜è¦ ServletWebServerFactory æœŸå­ç±»æ²¡æœ‰ åœ¨å®¹å™¨ä¸­</span>
   <span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Tomcat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">UpgradeProtocol</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
   <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">ServletWebServerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">)</span>
   <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmbeddedTomcat</span> <span class="o">{</span>

      <span class="nd">@Bean</span>
      <span class="nc">TomcatServletWebServerFactory</span> <span class="nf">tomcatServletWebServerFactory</span><span class="o">(</span>
            <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">TomcatConnectorCustomizer</span><span class="o">&gt;</span> <span class="n">connectorCustomizers</span><span class="o">,</span>
            <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">TomcatContextCustomizer</span><span class="o">&gt;</span> <span class="n">contextCustomizers</span><span class="o">,</span>
            <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">TomcatProtocolHandlerCustomizer</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">protocolHandlerCustomizers</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// åˆ›å»ºtomcat å·¥å‚</span>
         <span class="nc">TomcatServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TomcatServletWebServerFactory</span><span class="o">();</span>
         <span class="n">factory</span><span class="o">.</span><span class="na">getTomcatConnectorCustomizers</span><span class="o">()</span>
               <span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">connectorCustomizers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
         <span class="n">factory</span><span class="o">.</span><span class="na">getTomcatContextCustomizers</span><span class="o">()</span>
               <span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">contextCustomizers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
         <span class="n">factory</span><span class="o">.</span><span class="na">getTomcatProtocolHandlerCustomizers</span><span class="o">()</span>
               <span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">protocolHandlerCustomizers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
         <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
      <span class="o">}</span>

   <span class="o">}</span>

   <span class="cm">/**
    * Nested configuration if Jetty is being used.
    * åŒtomcatçš„é€»è¾‘
    */</span>
   <span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Server</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Loader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">WebAppContext</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
   <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">ServletWebServerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">)</span>
   <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmbeddedJetty</span> <span class="o">{</span>

      <span class="nd">@Bean</span>
      <span class="nc">JettyServletWebServerFactory</span> <span class="nf">JettyServletWebServerFactory</span><span class="o">(</span>
            <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">JettyServerCustomizer</span><span class="o">&gt;</span> <span class="n">serverCustomizers</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">JettyServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JettyServletWebServerFactory</span><span class="o">();</span>
         <span class="n">factory</span><span class="o">.</span><span class="na">getServerCustomizers</span><span class="o">().</span><span class="na">addAll</span><span class="o">(</span><span class="n">serverCustomizers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
         <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
      <span class="o">}</span>

   <span class="o">}</span>

   <span class="cm">/**
    * Nested configuration if Undertow is being used.
    * åŒtomcatçš„é€»è¾‘
    */</span>
   <span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
   <span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Undertow</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">SslClientAuthMode</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
   <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">ServletWebServerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">)</span>
   <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmbeddedUndertow</span> <span class="o">{</span>

      <span class="nd">@Bean</span>
      <span class="nc">UndertowServletWebServerFactory</span> <span class="nf">undertowServletWebServerFactory</span><span class="o">(</span>
            <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">UndertowDeploymentInfoCustomizer</span><span class="o">&gt;</span> <span class="n">deploymentInfoCustomizers</span><span class="o">,</span>
            <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">UndertowBuilderCustomizer</span><span class="o">&gt;</span> <span class="n">builderCustomizers</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">UndertowServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UndertowServletWebServerFactory</span><span class="o">();</span>
         <span class="n">factory</span><span class="o">.</span><span class="na">getDeploymentInfoCustomizers</span><span class="o">()</span>
               <span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">deploymentInfoCustomizers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
         <span class="n">factory</span><span class="o">.</span><span class="na">getBuilderCustomizers</span><span class="o">().</span><span class="na">addAll</span><span class="o">(</span><span class="n">builderCustomizers</span><span class="o">.</span><span class="na">orderedStream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
         <span class="k">return</span> <span class="n">factory</span><span class="o">;</span>
      <span class="o">}</span>

   <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œå¯ä»¥çœ‹åˆ°,é…ç½®ç±»æŒ‰ç…§classpathä¸­çš„ç±»åˆ›å»ºäº†ä¸åŒçš„<code class="language-plaintext highlighter-rouge">ServletWebServerFactory</code>,æœ¬æ–‡è¿™é‡ŒåŠ å…¥äº†tomcat,æ‰€ä»¥è¿™é‡Œå°†ä¼šåˆ›å»º<code class="language-plaintext highlighter-rouge">TomcatServletWebServerFactory</code>.</p>

<p>â€‹	å½“ç„¶å…‰çœ‹è¿™ä¸ªè¿˜æ˜¯ä¸è¡Œçš„,è¦æ˜ç™½ä¸ºå•¥ä¼šè¿™ä¹ˆåˆ›å»º,é‚£ä¹ˆè¿™ä¸€åˆ‡è¦ä»springbootçš„å¯åŠ¨æµç¨‹å¼€å§‹åˆ†ææ‰èƒ½è§£é‡Šæ•´ä¸ªæƒ…å†µ.</p>

<h1 id="å››springbootå¯åŠ¨æµç¨‹åˆ†æ">å››ã€SpringBootå¯åŠ¨æµç¨‹åˆ†æ</h1>

<p>â€‹	å¤ªé˜³åº•ä¸‹æ— æ–°é²œäº‹,æ¥æ­å¼€åä¸ºæ–¹ä¾¿çš„é¢çº±.å½“ç„¶è¿™åªæ˜¯åˆæ­¥çš„æ¢è®¨.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	ç†Ÿæ‚‰springBootçš„äººçœ‹åˆ°è¿™æ ·çš„å†™æ³•æ˜¯å¦æ˜¯æ„Ÿåˆ°å¹³æ·¡æ— å¥‡?é‚£ä¹ˆè¿™çŸ­çŸ­çš„ä¸€è¡Œä»£ç åé¢åˆ°åº•å‘ç”Ÿäº†å•¥??</p>

<h2 id="41-springapplicationrun">4.1 SpringApplication.run</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">primarySource</span><span class="o">,</span> <span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">run</span><span class="o">(</span><span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="o">{</span> <span class="n">primarySource</span> <span class="o">},</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">primarySources</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">SpringApplication</span><span class="o">(</span><span class="n">primarySources</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åˆ›å»ºäº†ä¸ª<code class="language-plaintext highlighter-rouge">SpringApplication</code>å¯¹è±¡åœ¨runï¼Ÿçœ‹çœ‹æ„é€ å‡½æ•°æ˜¯å¦æœ‰å•¥é€»è¾‘.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">SpringApplication</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">primarySources</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">primarySources</span><span class="o">);</span>
	<span class="o">}</span>
<span class="kd">public</span> <span class="nf">SpringApplication</span><span class="o">(</span><span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">primarySources</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span><span class="o">;</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">primarySources</span><span class="o">,</span> <span class="s">"PrimarySources must not be null"</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">primarySources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">primarySources</span><span class="o">));</span>
		<span class="c1">// åˆ¤æ–­ web åº”ç”¨çš„ç±»å‹</span>
		<span class="c1">// åˆ¤æ–­ä¾æ®ä¸º æ˜¯å¦å­˜åœ¨æŒ‡å®š DispatcherServlet,DispatcherHandler,ServletContainer,WebApplicationContext,ReactiveWebApplicationContextç­‰ç±»</span>
		<span class="c1">// ä½¿ç”¨ class.forName è¿›è¡ŒæŸ¥æ‰¾</span>
  	<span class="c1">// åˆ¤æ–­springç¨‹åºçš„ç±»å‹</span>
		<span class="k">this</span><span class="o">.</span><span class="na">webApplicationType</span> <span class="o">=</span> <span class="nc">WebApplicationType</span><span class="o">.</span><span class="na">deduceFromClasspath</span><span class="o">();</span>
		<span class="c1">// åŠ è½½ META-INF/spring.factories é…ç½®æ–‡ä»¶,å¹¶æŠŠ ApplicationContextInitializer ç›¸å…³çš„ç±»å…¨éƒ¨å®ä¾‹åŒ–</span>
		<span class="n">setInitializers</span><span class="o">((</span><span class="nc">Collection</span><span class="o">)</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">ApplicationContextInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
		<span class="c1">// åŠ è½½ META-INF/spring.factories é…ç½®æ–‡ä»¶,å¹¶æŠŠ ApplicationListener ç›¸å…³çš„ç±» å…¨éƒ¨å®ä¾‹åŒ–</span>
		<span class="n">setListeners</span><span class="o">((</span><span class="nc">Collection</span><span class="o">)</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
		<span class="c1">// æ£€æŸ¥ main æ–¹æ³•æ‰€åœ¨çš„ç±»</span>
		<span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span> <span class="o">=</span> <span class="n">deduceMainApplicationClass</span><span class="o">();</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åœ¨æ„é€ çš„æ—¶å€™è¿˜æ˜¯åšäº†ä¸å°‘çš„é€»è¾‘,è¿™é‡Œå°±ä¸å¾—ä¸æä¸€ä¸‹springçš„é»‘é­”æ³•äº†,é‚£å°±æ˜¯<code class="language-plaintext highlighter-rouge">SpringFactoriesLoader</code>,è¿™ä¸ªä¸œè¥¿æœ‰ç‚¹åƒjavaä¸­çš„spiæœºåˆ¶,ä¸ä¹‹ä¸åŒæ˜¯springæ˜¯è¯»å–çš„æ˜¯<code class="language-plaintext highlighter-rouge">META-INF/spring.factories</code>æ–‡ä»¶.è‡³äºä¸ºå•¥ä¸ç”¨spiè¦è‡ªå·±å•æä¸ª,emmmmmm.</p>

<p>â€‹	æ„é€ çš„é€»è¾‘å¾ˆç®€å•,ä¸æ˜¯å¾ˆå¤æ‚,å°±æ˜¯æ£€æµ‹ä¸€ä¸‹è¦å¯åŠ¨ä»€ä¹ˆç±»å‹çš„spring,å…·ä½“æ“ä½œæ˜¯åœ¨<code class="language-plaintext highlighter-rouge">WebApplicationType.deduceFromClasspath();</code>,è¿™ä¸ªç±»å‹åˆ¤æ–­è¿˜æ˜¯å¾ˆé‡è¦çš„,åé¢åˆ›å»ºspringä¸Šä¸‹æ–‡çš„æ—¶å€™ä¼šç”¨å¾—ä¸Š.</p>

<h2 id="42-springapplicationrun">4.2 springApplication.run</h2>

<p>â€‹	å¯¹è±¡åˆ›å»ºå¥½äº†,åˆè¦ç»§ç»­runäº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// åˆ›å»ºä¸€ä¸ªç”¨äºè®°å½• å¯åŠ¨-å…³é—­ æ—¶é—´çš„ StopWatch</span>
		<span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
		<span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
		<span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SpringBootExceptionReporter</span><span class="o">&gt;</span> <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
		<span class="c1">// è®¾ç½®ç¯å¢ƒå˜é‡</span>
		<span class="n">configureHeadlessProperty</span><span class="o">();</span>
		<span class="c1">// åˆ›å»º EventPublishingRunListener</span>
		<span class="c1">// ç›¸å½“äºæ˜¯ä¸ªç»„åˆæ¨¡å¼,æ‰€æœ‰listener éƒ½é›†ä¸­åœ¨ SpringApplicationRunListeners ä¸­</span>
		<span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span> <span class="o">=</span> <span class="n">getRunListeners</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
		<span class="c1">// å¯åŠ¨å®¹å™¨,å‘é€æ—¶é—´</span>
		<span class="n">listeners</span><span class="o">.</span><span class="na">starting</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// æŠŠ args å°è£…ä¸ºå¯¹è±¡,æ˜ å°„åˆ°ç¯å¢ƒä¸­</span>
			<span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultApplicationArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
			<span class="c1">// åˆå§‹åŒ–ç¯å¢ƒ</span>
			<span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">prepareEnvironment</span><span class="o">(</span><span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
			<span class="c1">// è®¾ç½®ç¯å¢ƒå˜é‡ spring.beaninfo.ignore</span>
			<span class="n">configureIgnoreBeanInfo</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
			<span class="c1">// è·å– éœ€è¦æ‰“å°çš„ Banner å¹¶æŠŠ banner æ‰“å°åˆ°æ§åˆ¶å°</span>
			<span class="nc">Banner</span> <span class="n">printedBanner</span> <span class="o">=</span> <span class="n">printBanner</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
      
      
			<span class="c1">// æ ¹æ®ä¸åŒçš„ç±»å‹ åˆ›å»ºä¸åŒçš„ä¸Šä¸‹æ–‡</span>
			<span class="n">context</span> <span class="o">=</span> <span class="n">createApplicationContext</span><span class="o">();</span>
      
      
			<span class="c1">// è·å– æ‰€æœ‰ SpringBootExceptionReporter ç›¸å…³çš„ç±»</span>
			<span class="n">exceptionReporters</span> <span class="o">=</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">SpringBootExceptionReporter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
					<span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="n">context</span><span class="o">);</span>
			<span class="c1">// å‡†å¤‡ä¸Šä¸‹æ–‡</span>
			<span class="n">prepareContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
      
      
      
			<span class="c1">// åˆ·æ–°ä¸Šä¸‹æ–‡,å‘é€äº‹ä»¶</span>
			<span class="n">refreshContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
      
      
			<span class="c1">// æ¨¡æ¿æ–¹æ³•</span>
			<span class="n">afterRefresh</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
			<span class="c1">// åœæ­¢</span>
			<span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">new</span> <span class="nf">StartupInfoLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span><span class="o">).</span><span class="na">logStarted</span><span class="o">(</span><span class="n">getApplicationLog</span><span class="o">(),</span> <span class="n">stopWatch</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// é€šçŸ¥ç›‘å¬å™¨,å·²ç»å¯åŠ¨</span>
			<span class="n">listeners</span><span class="o">.</span><span class="na">started</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
			<span class="c1">// è°ƒç”¨ runnerçš„ run æ–¹æ³•</span>
			<span class="n">callRunners</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// å¤„ç†è¿è¡Œæ—¶çš„é”™è¯¯</span>
			<span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="n">listeners</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// é€šçŸ¥ç›‘å¬å™¨,æ­£åœ¨è¿è¡Œ</span>
			<span class="n">listeners</span><span class="o">.</span><span class="na">running</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// å¤„ç†è¿è¡Œæ—¶çš„é”™è¯¯</span>
			<span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// è¿”å›ä¸Šä¸‹æ–‡</span>
		<span class="k">return</span> <span class="n">context</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ç”±äºæœ¬æ–‡ä¸æ˜¯åˆ†æä»£ç çš„æ–‡ç« ,æ‰€ä»¥å…³æ³¨ç‚¹æ”¾åœ¨åˆ›å»ºspringä¸Šä¸‹æ–‡å’Œä¸Šä¸‹æ–‡çš„æ“ä½œä¸Š.åˆ†åˆ«æ˜¯<code class="language-plaintext highlighter-rouge">createApplicationContext</code>å’Œ<code class="language-plaintext highlighter-rouge">refreshContext</code></p>

<h2 id="43-createapplicationcontext">4.3 createApplicationContext</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">createApplicationContext</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">contextClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationContextClass</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">contextClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">switch</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">webApplicationType</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">case</span> <span class="nl">SERVLET:</span>
					<span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_SERVLET_WEB_CONTEXT_CLASS</span><span class="o">);</span>
					<span class="k">break</span><span class="o">;</span>
				<span class="k">case</span> <span class="nl">REACTIVE:</span>
					<span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS</span><span class="o">);</span>
					<span class="k">break</span><span class="o">;</span>
				<span class="k">default</span><span class="o">:</span>
					<span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_CONTEXT_CLASS</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
						<span class="s">"Unable create a default ApplicationContext, please specify an ApplicationContextClass"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="o">(</span><span class="nc">ConfigurableApplicationContext</span><span class="o">)</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">contextClass</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œçš„ç±»å‹,æ˜¯æŒ‰ç…§ä¹‹å‰æ„é€ æ–¹æ³•ä¸­çš„ç±»å‹è¿›è¡Œåˆ›å»ºçš„,å¦‚æœä¸æ¸…æ¥šçš„å¯ä»¥å¾€ä¸Šç¿»ä¸€å“ˆ.</p>

<ol>
  <li>å¦‚æœç±»å‹ä¸º: SERVLET å°±åˆ›å»º AnnotationConfigServletWebServerApplicationContext</li>
  <li>å¦‚æœç±»å‹ä¸º: REACTIVE å°±åˆ›å»º AnnotationConfigReactiveWebServerApplicationContext</li>
  <li>é»˜è®¤åˆ›å»º : AnnotationConfigApplicationContext</li>
</ol>

<p>â€‹	å¾ˆæ˜¾ç„¶è¿™é‡Œçš„ç±»å‹æ˜¯ SERVLET æ‰€ä»¥åˆ›å»ºäº† AnnotationConfigServletWebServerApplicationContext,ç»§æ‰¿å…³ç³»å¦‚ä¸‹.</p>

<p><img src="https://gitee.com/oneww/onew_image/raw/master/AnnotationConfigServletWebServerApplicationContext.png" alt="images" /></p>

<p>â€‹	ç†Ÿæ‚‰springçš„åŒå­¦æ˜¯ä¸æ˜¯æ„Ÿè§‰ä¸<code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>å·®ä¸å¤šï¼Ÿæˆ‘è§‰å¾—æ˜¯å·®ä¸å¤šçš„,åªæ˜¯å¹²äº‹çš„æ–¹å¼æœ‰ç‚¹åŒºåˆ«.</p>

<p>â€‹	è¿™é‡ŒæŠŠå¯¹è±¡åˆ›å»ºå®Œäº†,ç„¶åè¿›è¡Œä¸€é¡¿éªšæ“ä½œ,è®¾ç½®å€¼,ç¯å¢ƒç­‰ç­‰.ä¸å†è¿™é‡Œè¿›è¡Œåˆ†æ.è¦çœ‹çš„å…³é”®ç‚¹æ˜¯<code class="language-plaintext highlighter-rouge">refreshContext</code>.</p>

<h2 id="45-refreshcontext">4.5 refreshContext</h2>

<p>â€‹	åˆ·æ–°ä¸Šä¸‹æ–‡,è¿™é‡Œåˆ·æ–°ä¼šæœ‰ä»€ä¹ˆéªšæ“ä½œå‘¢?æ¥ç§ç§å°±çŸ¥é“äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">refreshContext</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">refresh</span><span class="o">((</span><span class="nc">ApplicationContext</span><span class="o">)</span> <span class="n">context</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registerShutdownHook</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// æ·»åŠ å…³é—­é’©å­,å…³é—­ç¨‹åºæ—¶,å…³é—­ä¸Šä¸‹æ–‡ é‡Šæ”¾èµ„æº</span>
				<span class="n">context</span><span class="o">.</span><span class="na">registerShutdownHook</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">AccessControlException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Not allowed in some environments.</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	æ·»åŠ é’©å­è¿™ä¸ªå¯ä»¥ä¸ç”¨ç®¡,ä¸å½±å“é€»è¾‘.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Deprecated</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">applicationContext</span><span class="o">);</span>
		<span class="n">refresh</span><span class="o">((</span><span class="nc">ConfigurableApplicationContext</span><span class="o">)</span> <span class="n">applicationContext</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è™½ç„¶è¿™ä¸ªæ–¹æ³•è¿‡æ—¶,ä½†springè¿˜æ˜¯æ²¡æœ‰ç›´æ¥åˆ é™¤,çœŸå¤Ÿè‰¯å¿ƒçš„,ä¸åƒæŸFinal,ç›´æ¥åˆ ,çœŸTMSB.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	æ³¨æ„è¿™é‡Œçš„context å®é™…ä¸Šæ˜¯<code class="language-plaintext highlighter-rouge">AnnotationConfigServletWebServerApplicationContext</code>,è€Œ<code class="language-plaintext highlighter-rouge">AnnotationConfigServletWebServerApplicationContext</code>æ²¡æœ‰é‡å†™è¿™ä¸ªæ–¹æ³•,æ˜¯ç»§æ‰¿çš„å®ƒçˆ¶ç±»<code class="language-plaintext highlighter-rouge">ServletWebServerApplicationContext</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ServletWebServerApplicationContext</span>
<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="kd">super</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">stopAndReleaseWebServer</span><span class="o">();</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	<code class="language-plaintext highlighter-rouge">ServletWebServerApplicationContext</code>çš„çˆ¶ç±»æ˜¯<code class="language-plaintext highlighter-rouge">AbstractApplicationContext</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// AbstractApplicationContext</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Prepare this context for refreshing.</span>
			<span class="c1">// å‡†å¤‡åˆ·æ–°ä¸Šä¸‹æ–‡ç¯å¢ƒ</span>
			<span class="n">prepareRefresh</span><span class="o">();</span>

			<span class="c1">// Tell the subclass to refresh the internal bean factory.</span>
			<span class="c1">// åˆå§‹åŒ–beanFactory,è¿›è¡Œxmlé¢„è¯»å–</span>
			<span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>

			<span class="c1">// Prepare the bean factory for use in this context.</span>
			<span class="c1">// å¯¹beanFactoryè¿›è¡Œå¡«å……</span>
			<span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// Allows post-processing of the bean factory in context subclasses.</span>
				<span class="c1">// å­ç±»è¦†ç›–æ–¹æ³•åšé¢å¤–çš„å¤„ç†</span>
				<span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

				<span class="c1">// Invoke factory processors registered as beans in the context.</span>
				<span class="c1">// æ¿€æ´»å„ç§beanFactoryProcessors</span>
				<span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

				<span class="c1">// Register bean processors that intercept bean creation.</span>
				<span class="c1">//æ³¨å†Œæ‹¦æˆªbeanåˆ›å»ºçš„beanå¤„ç†å™¨</span>
				<span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

				<span class="c1">// Initialize message source for this context.</span>
				<span class="c1">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯æº</span>
				<span class="n">initMessageSource</span><span class="o">();</span>

				<span class="c1">// Initialize event multicaster for this context.</span>
				<span class="c1">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯å¹¿æ’­</span>
				<span class="n">initApplicationEventMulticaster</span><span class="o">();</span>

				<span class="c1">// Initialize other special beans in specific context subclasses.</span>
				<span class="c1">// ç•™ç»™å­ç±»æ¥åˆå§‹åŒ–å…¶ä»–çš„bean</span>
				<span class="n">onRefresh</span><span class="o">();</span>

				<span class="c1">// Check for listener beans and register them.</span>
				<span class="c1">// æ³¨å†Œæ‰€æœ‰beançš„ç›‘å¬å™¨</span>
				<span class="n">registerListeners</span><span class="o">();</span>

				<span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
				<span class="c1">// åˆå§‹åŒ–å»¶è¿ŸåŠ è½½çš„bean</span>
				<span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

				<span class="c1">// Last step: publish corresponding event.</span>
				<span class="c1">// æœ€åä¸€æ­¥,å‘å¸ƒæ¶ˆæ¯</span>
				<span class="n">finishRefresh</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Exception encountered during context initialization - "</span> <span class="o">+</span>
							<span class="s">"cancelling refresh attempt: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="c1">//å‘ç”Ÿå¼‚å¸¸,é”€æ¯æ‰€æœ‰bean</span>
				<span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
				<span class="n">destroyBeans</span><span class="o">();</span>

				<span class="c1">// Reset 'active' flag.</span>
				<span class="c1">// é‡ç½®flag</span>
				<span class="n">cancelRefresh</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>

				<span class="c1">// Propagate exception to caller.</span>
				<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="k">finally</span> <span class="o">{</span>
				<span class="c1">// Reset common introspection caches in Spring's core, since we</span>
				<span class="c1">// might not ever need metadata for singleton beans anymore...</span>
				<span class="c1">// é‡ç½®ç¼“å­˜</span>
				<span class="n">resetCommonCaches</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œçš„é‡ç‚¹æ˜¯<code class="language-plaintext highlighter-rouge">onRefresh</code>,è¿™é‡Œ<code class="language-plaintext highlighter-rouge">onRefresh</code>æ˜¯ç”±å­ç±»<code class="language-plaintext highlighter-rouge">ServletWebServerApplicationContext</code>è¿›è¡Œå®ç°çš„.</p>

<h2 id="46-onrefresh">4.6 onRefresh</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="c1">// ServletWebServerApplicationContext</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">onRefresh</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// åˆ›å»ºserver</span>
			<span class="n">createWebServer</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start web server"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	ç»ˆäºç»•åˆ°äº†åˆ›å»º server è¿™é‡Œäº†,ä¸çŸ¥å°‘ä¾ æ˜¯å¦è¿˜è®°å¾—é‚£ä¸ªé…ç½®ç±»??<code class="language-plaintext highlighter-rouge">ServletWebServerFactoryConfiguration</code>.é‚£ä¹ˆç°åœ¨æ‰çœŸæ­£çš„å¼€å§‹äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createWebServer</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">WebServer</span> <span class="n">webServer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">webServer</span><span class="o">;</span>
  	<span class="c1">// è·å–servlet ä¸Šä¸‹æ–‡</span>
		<span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
    <span class="c1">// å¦‚æœ server ä¸ºç©º æˆ–è€… servletä¸Šä¸‹æ–‡ä¸ºç©º,å°±åˆ›å»ºserver</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">webServer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">servletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">ServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">getWebServerFactory</span><span class="o">();</span>
			<span class="k">this</span><span class="o">.</span><span class="na">webServer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="n">initPropertySources</span><span class="o">();</span>
	<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>åˆ¤æ–­serveræ˜¯å¦åˆ›å»º</li>
  <li>æœªåˆ›å»ºå°±åˆ›å»º</li>
  <li>åˆå§‹åŒ–</li>
  <li>åˆå§‹åŒ–èµ„æº</li>
</ol>

<p>â€‹	è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">getWebServerFactory()</code> æ–¹æ³•ä»å®¹å™¨ä¸­è·å–çš„,å®¹å™¨é‡Œé¢çš„æ˜¯ä¹‹å‰é…ç½®ç±»ä¸­åˆ›å»ºçš„.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä»å®¹å™¨ä¸­è·å– ServletWebServerFactory</span>
<span class="kd">protected</span> <span class="nc">ServletWebServerFactory</span> <span class="nf">getWebServerFactory</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// Use bean names so that we don't consider the hierarchy</span>
		<span class="nc">String</span><span class="o">[]</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">().</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">ServletWebServerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanNames</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start ServletWebServerApplicationContext due to missing "</span>
					<span class="o">+</span> <span class="s">"ServletWebServerFactory bean."</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanNames</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start ServletWebServerApplicationContext due to multiple "</span>
					<span class="o">+</span> <span class="s">"ServletWebServerFactory beans : "</span> <span class="o">+</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">arrayToCommaDelimitedString</span><span class="o">(</span><span class="n">beanNames</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="nf">getBeanFactory</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span><span class="n">beanNames</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="nc">ServletWebServerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<h1 id="äº”tomcatçš„åˆ›å»º">äº”ã€tomcatçš„åˆ›å»º</h1>

<p>â€‹	å‰é¢åƒè¾›ä¸‡è‹¦çš„è·å–åˆ°äº† tomcatServerçš„å·¥å‚,æ¥ä¸‹æ¥å°±çœ‹çœ‹æ˜¯æ€ä¹ˆåˆ›å»ºçš„å§.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">WebServer</span> <span class="nf">getWebServer</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">...</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// .. çœç•¥</span>
    <span class="c1">// åˆå§‹åŒ–</span>
		<span class="n">prepareContext</span><span class="o">(</span><span class="n">tomcat</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">initializers</span><span class="o">);</span>
		<span class="k">return</span> <span class="nf">getTomcatWebServer</span><span class="o">(</span><span class="n">tomcat</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œ<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>æ˜¯ä¸æ˜¯å’Œ<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>æœ‰ç‚¹ç¥ä¼¼?åˆ«è¯´ä¸ä»”ç»†çœ‹è¿˜æ˜¯ä¼šçœ‹é”™,è‡³äºè¿™ä¸¤ä¸ªæ˜¯å•¥å…³ç³»,è¿™é‡Œå°±ä¸ç¢ç£¨äº†,æ¯•ç«Ÿè¿™ä¸ªä¸æ˜¯é‡ç‚¹.</p>

<h2 id="51-åˆå§‹åŒ–">5.1 åˆå§‹åŒ–</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareContext</span><span class="o">(</span><span class="nc">Host</span> <span class="n">host</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">//... çœç•¥</span>
  	<span class="c1">// æ·»åŠ ç›‘å¬å™¨</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addLifecycleListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">StaticResourceConfigurer</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
		<span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializersToUse</span> <span class="o">=</span> <span class="n">mergeInitializers</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
		<span class="n">host</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="n">configureContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">initializersToUse</span><span class="o">);</span>
		<span class="n">postProcessContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ·»åŠ äº†ä¸€ä¸ªåå­—ä¸ºé™æ€èµ„æºé…ç½®çš„ç›‘å¬å™¨,åå­—éƒ½å¾ˆæ€ªæ€ªçš„å¥½å§.å»çœ‹çœ‹è¿™ä¸ªç›‘å¬å™¨æ˜¯å¹²å˜›çš„.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StaticResourceConfigurer</span> <span class="kd">implements</span> <span class="nc">LifecycleListener</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>

		<span class="kd">private</span> <span class="nf">StaticResourceConfigurer</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">lifecycleEvent</span><span class="o">(</span><span class="nc">LifecycleEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// åˆ¤æ–­æ—¶æœº</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">CONFIGURE_START_EVENT</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">addResourceJars</span><span class="o">(</span><span class="n">getUrlsOfJarsWithMetaInfResources</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addResourceJars</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">resourceJarUrls</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="no">URL</span> <span class="n">url</span> <span class="o">:</span> <span class="n">resourceJarUrls</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar"</span><span class="o">)</span> <span class="o">||</span> <span class="n">path</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar!/"</span><span class="o">))</span> <span class="o">{</span>
					<span class="nc">String</span> <span class="n">jar</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">jar</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"jar:"</span><span class="o">))</span> <span class="o">{</span>
						<span class="c1">// A jar file in the file system. Convert to Jar URL.</span>
						<span class="n">jar</span> <span class="o">=</span> <span class="s">"jar:"</span> <span class="o">+</span> <span class="n">jar</span> <span class="o">+</span> <span class="s">"!/"</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="n">addResourceSet</span><span class="o">(</span><span class="n">jar</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">addResourceSet</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addResourceSet</span><span class="o">(</span><span class="nc">String</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isInsideNestedJar</span><span class="o">(</span><span class="n">resource</span><span class="o">))</span> <span class="o">{</span>
					<span class="c1">// It's a nested jar but we now don't want the suffix because Tomcat</span>
					<span class="c1">// is going to try and locate it as a root URL (not the resource</span>
					<span class="c1">// inside it)</span>
					<span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">resource</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
				<span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"/META-INF/resources"</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">createWebResourceSet</span><span class="o">(</span><span class="nc">ResourceSetType</span><span class="o">.</span><span class="na">RESOURCE_JAR</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Ignore (probably not a directory)</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isInsideNestedJar</span><span class="o">(</span><span class="nc">String</span> <span class="n">dir</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">dir</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"!/"</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">dir</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"!/"</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä»è¿™ä¸ªç›‘å¬å™¨çš„ä»£ç é€»è¾‘ä¸Šçœ‹ æ˜¯å¾€<code class="language-plaintext highlighter-rouge">context.getResources</code>ä¸¢ä¸œè¥¿å‘€.è²Œä¼¼æ˜¯è·¯å¾„å•¥çš„,è¿™ä¼šä¸ä¼šä¸å¼€å¤´çš„404é—®é¢˜æœ‰å…³å‘¢ï¼Ÿ</p>

<p>â€‹	<code class="language-plaintext highlighter-rouge">createWebResourceSet</code>è¿™ä¸ªæ–¹æ³•å«Œç–‘å¾ˆå¤§,å»çœ‹çœ‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// StandardRoot </span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createWebResourceSet</span><span class="o">(</span><span class="nc">ResourceSetType</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">webAppMount</span><span class="o">,</span>
            <span class="nc">String</span> <span class="n">base</span><span class="o">,</span> <span class="nc">String</span> <span class="n">archivePath</span><span class="o">,</span> <span class="nc">String</span> <span class="n">internalPath</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebResourceSet</span><span class="o">&gt;</span> <span class="n">resourceList</span><span class="o">;</span>
        <span class="nc">WebResourceSet</span> <span class="n">resourceSet</span><span class="o">;</span>

        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nl">PRE:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">preResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">CLASSES_JAR:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">classResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">RESOURCE_JAR:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">jarResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">POST:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">postResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                        <span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"standardRoot.createUnknownType"</span><span class="o">,</span> <span class="n">type</span><span class="o">));</span>
        <span class="o">}</span>
					<span class="c1">// ..... çœç•¥</span>
        <span class="n">resourceList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resourceSet</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä»¥ä¸Šé€»è¾‘ä¸ºæ ¹æ®ä¸åŒçš„ç±»å‹,å¾€ä¸åŒçš„listä¸­æ·»åŠ è·¯å¾„.å¥½å§è¿˜æ˜¯çœ‹ä¸å‡ºæ¥è¿™ä¸ªåˆ°åº•æœ‰ä»€ä¹ˆç”¨,404çš„é—®é¢˜ä¹Ÿæ²¡æ‰¾åˆ°,ä¸å¦‚æœè·Ÿè¸ªä¸€ä¸‹è¯·æ±‚çœ‹çœ‹.</p>

<h1 id="å…­è¯·æ±‚çš„è·Ÿè¸ª">å…­ã€è¯·æ±‚çš„è·Ÿè¸ª</h1>

<p>â€‹	springMVCå¯¹è¯·æ±‚çš„å¤„ç†é€»è¾‘ä¸€èˆ¬ä¸º DispatcherServletæ¥ç®¡è¯·æ±‚-&gt;æŸ¥æ‰¾handler-&gt;æŸ¥æ‰¾handlerDapter-&gt;è§†å›¾è§£æå™¨-&gt;è§£æè§†å›¾-&gt;æ¸²æŸ“è§†å›¾.</p>

<p>â€‹	è™½ç„¶è¿™ä¸ªé€»è¾‘ä¸ä¸å®Œå–„,å¯èƒ½è¿˜æ˜¯é”™çš„,ä½†å·®ä¸å¤š,ç¬”è€…è®¤ä¸ºå“ˆ.</p>

<p>â€‹	é‚£ä¹ˆé—®é¢˜æ¥äº†,åœ¨springMVCä¸­çš„è§†å›¾è§£æå™¨æ˜¯å•¥å‘¢ï¼Ÿçœ‹çœ‹ViewResolverçš„å­ç±»å°±çŸ¥é“æ˜¯InternalResourceViewResolveräº†.ä½†è¿™ä¸ªæ²¡å•¥ç”¨å‘€,å› ä¸ºå…·ä½“çš„æ¸²æŸ“é€»è¾‘æ˜¯åœ¨è§†å›¾å¯¹è±¡é‡Œ,è§£æå™¨åœ¨è¿™é‡Œæ²¡å•¥å¤ªå¤§çš„ç”¨å¤„.æ‰€ä»¥æ¥çœ‹çœ‹jspçš„è§†å›¾<code class="language-plaintext highlighter-rouge">JstlView</code>ä¸­çš„æ“ä½œå§.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JstlView</span> <span class="kd">extends</span> <span class="nc">InternalResourceView</span> <span class="o">{</span>

	<span class="nd">@Nullable</span>
	<span class="kd">private</span> <span class="nc">MessageSource</span> <span class="n">messageSource</span><span class="o">;</span>


	<span class="cm">/**
	 * Constructor for use as a bean.
	 * @see #setUrl
	 */</span>
	<span class="kd">public</span> <span class="nf">JstlView</span><span class="o">()</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Create a new JstlView with the given URL.
	 * @param url the URL to forward to
	 */</span>
	<span class="kd">public</span> <span class="nf">JstlView</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Create a new JstlView with the given URL.
	 * @param url the URL to forward to
	 * @param messageSource the MessageSource to expose to JSTL tags
	 * (will be wrapped with a JSTL-aware MessageSource that is aware of JSTL's
	 * {@code javax.servlet.jsp.jstl.fmt.localizationContext} context-param)
	 * @see JstlUtils#getJstlAwareMessageSource
	 */</span>
	<span class="kd">public</span> <span class="nf">JstlView</span><span class="o">(</span><span class="nc">String</span> <span class="n">url</span><span class="o">,</span> <span class="nc">MessageSource</span> <span class="n">messageSource</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">=</span> <span class="n">messageSource</span><span class="o">;</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * Wraps the MessageSource with a JSTL-aware MessageSource that is aware
	 * of JSTL's {@code javax.servlet.jsp.jstl.fmt.localizationContext}
	 * context-param.
	 * @see JstlUtils#getJstlAwareMessageSource
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initServletContext</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">=</span> <span class="nc">JstlUtils</span><span class="o">.</span><span class="na">getJstlAwareMessageSource</span><span class="o">(</span><span class="n">servletContext</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="kd">super</span><span class="o">.</span><span class="na">initServletContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Exposes a JSTL LocalizationContext for Spring's locale and MessageSource.
	 * @see JstlUtils#exposeLocalizationContext
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">exposeHelpers</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">JstlUtils</span><span class="o">.</span><span class="na">exposeLocalizationContext</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="nc">JstlUtils</span><span class="o">.</span><span class="na">exposeLocalizationContext</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestContext</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">getServletContext</span><span class="o">()));</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åœ¨jstlViewä¸­å¹¶æ²¡æœ‰çœ‹åˆ°jspçš„å¤„ç†é€»è¾‘,å»çˆ¶ç±»çœ‹çœ‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InternalResourceView</span> <span class="kd">extends</span> <span class="nc">AbstractUrlBasedView</span> <span class="o">{</span>
<span class="c1">// çœç•¥...</span>

	<span class="cm">/**
	 * Render the internal resource given the specified model.
	 * This includes setting the model as request attributes.
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">renderMergedOutputModel</span><span class="o">(</span>
			<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">model</span><span class="o">,</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

		<span class="c1">// Expose the model object as request attributes.</span>
		<span class="n">exposeModelAsRequestAttributes</span><span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>

		<span class="c1">// Expose helpers as request attributes, if any.</span>
		<span class="n">exposeHelpers</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

		<span class="c1">// Determine the path for the request dispatcher.</span>
		<span class="nc">String</span> <span class="n">dispatcherPath</span> <span class="o">=</span> <span class="n">prepareForRendering</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

		<span class="c1">// Obtain a RequestDispatcher for the target resource (typically a JSP).</span>
		<span class="nc">RequestDispatcher</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">getRequestDispatcher</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">dispatcherPath</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">rd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="s">"Could not get RequestDispatcher for ["</span> <span class="o">+</span> <span class="n">getUrl</span><span class="o">()</span> <span class="o">+</span>
					<span class="s">"]: Check that the corresponding file exists within your web application archive!"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="c1">// If already included or response already committed, perform include, else forward.</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">useInclude</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">getContentType</span><span class="o">());</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Including ["</span> <span class="o">+</span> <span class="n">getUrl</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">rd</span><span class="o">.</span><span class="na">include</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Note: The forwarded resource is supposed to determine the content type itself.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Forwarding to ["</span> <span class="o">+</span> <span class="n">getUrl</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">rd</span><span class="o">.</span><span class="na">forward</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
  
  <span class="c1">// çœç•¥....</span>

<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	æ ¸å¿ƒå¤„ç†é€»è¾‘åœ¨<code class="language-plaintext highlighter-rouge">renderMergedOutputModel</code>,ç»è¿‡<code class="language-plaintext highlighter-rouge">renderMergedOutputModel</code>æ–¹æ³•ä¸€é¡¿éªšæ“ä½œä»¥å,æœ€åå‘ç°è¯·æ±‚è¢«<code class="language-plaintext highlighter-rouge">RequestDispatcher</code>æ¥ç®¡äº†.emmm,çº¿ç´¢åˆæ–­äº†,é‚£ä¹ˆæœ€åæ˜¯è¢«è°æ¥ç®¡çš„å‘¢?åœ¨j2eeçš„ä¸–ç•Œé‡Œ,èƒ½è¢«å•¥æ¥ç®¡?ä¸å°±æ˜¯ä¸ªservletæˆ–è€…filterå˜›.</p>

<p>â€‹	é‚£ä¹ˆæ¥ä¸‹æ¥è¦ææ¸…æ¥šæ˜¯è°æ¥ç®¡äº†è¯·æ±‚,å¹¶æ¸²æŸ“äº†jsp,è™½ç„¶ç­”æ¡ˆå¾ˆæ˜¾ç„¶äº†,ä½†è¿˜æ˜¯è¦èµ°ä¸€ä¸‹æµç¨‹.</p>

<h2 id="61-çŒœæµ‹æ˜¯servletæ¥ç®¡äº†è¯·æ±‚">6.1 çŒœæµ‹æ˜¯servletæ¥ç®¡äº†è¯·æ±‚</h2>

<p>â€‹	springMVC é‡Œ servlet?é‚£ä¸å°±æ˜¯DispatcherServletå˜›?ä½†æ€»è§‰å¾—ä¸å¯èƒ½,ä¸å¯èƒ½è¯·æ±‚ä»DispatcherServletæ¥åˆå›å»å§?é‚£å°±çœ‹çœ‹åœ¨åˆ›å»ºtomcatçš„æ—¶å€™æœ‰æ²¡æœ‰æ³¨å†Œå…¶ä»–çš„servelt.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareContext</span><span class="o">(</span><span class="nc">Host</span> <span class="n">host</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// çœç•¥ ..</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">isRegisterDefaultServlet</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">addDefaultServlet</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="o">}</span>
  
		<span class="k">if</span> <span class="o">(</span><span class="n">shouldRegisterJspServlet</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">addJspServlet</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
			<span class="n">addJasperInitializer</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// çœç•¥	...</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	å¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–çš„æ—¶å€™,æ³¨å†Œäº†ä¸¤ä¸ªservlet,ä¸€ä¸ªé»˜è®¤çš„servletä¸€ä¸ªæ˜¯jspçš„servlet</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addDefaultServlet</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Wrapper</span> <span class="n">defaultServlet</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createWrapper</span><span class="o">();</span>
		<span class="c1">// åç§°</span>
		<span class="n">defaultServlet</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"default"</span><span class="o">);</span>
		<span class="n">defaultServlet</span><span class="o">.</span><span class="na">setServletClass</span><span class="o">(</span><span class="s">"org.apache.catalina.servlets.DefaultServlet"</span><span class="o">);</span>
		<span class="n">defaultServlet</span><span class="o">.</span><span class="na">addInitParameter</span><span class="o">(</span><span class="s">"debug"</span><span class="o">,</span> <span class="s">"0"</span><span class="o">);</span>
		<span class="n">defaultServlet</span><span class="o">.</span><span class="na">addInitParameter</span><span class="o">(</span><span class="s">"listings"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>
		<span class="n">defaultServlet</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
		<span class="c1">// Otherwise the default location of a Spring DispatcherServlet cannot be set</span>
  	<span class="c1">// æ˜¯å¦è¿è¡Œè¦†ç›–,è¿™æ˜¯ä¸ºäº†dispatcherServletåšå‡†å¤‡</span>
  	<span class="c1">// æ–¹ä¾¿åœ¨åå…æŠŠè¿™ä¸ªé»˜è®¤çš„servletç»™è¦†ç›–æ‰</span>
		<span class="n">defaultServlet</span><span class="o">.</span><span class="na">setOverridable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">defaultServlet</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addServletMappingDecoded</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"default"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addJspServlet</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Wrapper</span> <span class="n">jspServlet</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">createWrapper</span><span class="o">();</span>
		<span class="n">jspServlet</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"jsp"</span><span class="o">);</span>
		<span class="n">jspServlet</span><span class="o">.</span><span class="na">setServletClass</span><span class="o">(</span><span class="n">getJsp</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
		<span class="n">jspServlet</span><span class="o">.</span><span class="na">addInitParameter</span><span class="o">(</span><span class="s">"fork"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>
		<span class="n">getJsp</span><span class="o">().</span><span class="na">getInitParameters</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nl">jspServlet:</span><span class="o">:</span><span class="n">addInitParameter</span><span class="o">);</span>
		<span class="n">jspServlet</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">jspServlet</span><span class="o">);</span>
    <span class="c1">// æ‹¦æˆª *.jsp åç¼€çš„è¯·æ±‚</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addServletMappingDecoded</span><span class="o">(</span><span class="s">"*.jsp"</span><span class="o">,</span> <span class="s">"jsp"</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addServletMappingDecoded</span><span class="o">(</span><span class="s">"*.jspx"</span><span class="o">,</span> <span class="s">"jsp"</span><span class="o">);</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>ä¸¤ä¸ªservlet,ä¸€ä¸ªé»˜è®¤çš„,ä¸€ä¸ªjspçš„.çœ‹åˆ°è¿™å„¿ä¼šä¸ä¼šæœ‰ç‚¹å¥‡æ€ª,ä¸ºå•¥ä¸æ³¨å†ŒdispatcherServlet?emmmä¸æ˜¯å¾ˆæ˜ç™½æ˜‚,ä½†æ˜¯è¿™ä¸ªæ ¸å¿ƒçš„servletæ˜¯ä¸ä¼šè½ä¸‹çš„.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@AutoConfigureOrder</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="cm">/**
 * åŒ¹é…å®¹å™¨ä¸º servlet
 * **/</span>
<span class="nd">@ConditionalOnWebApplication</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">Type</span><span class="o">.</span><span class="na">SERVLET</span><span class="o">)</span>
<span class="cm">/**
 * åˆ¤æ–­ class path è·¯å¾„ä¸‹æœ‰ DispatcherServlet.class
 * **/</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">DispatcherServlet</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="cm">/***
 * åœ¨ ServletWebServerFactoryAutoConfiguration ä¹‹åç”Ÿæ•ˆ
 * */</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">ServletWebServerFactoryAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatcherServletAutoConfiguration</span> <span class="o">{</span>

	<span class="cm">/*
	 * The bean name for a DispatcherServlet that will be mapped to the root URL "/"
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span> <span class="o">=</span> <span class="s">"dispatcherServlet"</span><span class="o">;</span>

	<span class="cm">/*
	 * The bean name for a ServletRegistrationBean for the DispatcherServlet "/"
	 */</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME</span> <span class="o">=</span> <span class="s">"dispatcherServletRegistration"</span><span class="o">;</span>

	<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
	<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">DefaultDispatcherServletCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="c1">// å¯ç”¨é…ç½® WebMvcProperties</span>
	<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">WebMvcProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DispatcherServletConfiguration</span> <span class="o">{</span>

		<span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DispatcherServlet</span> <span class="nf">dispatcherServlet</span><span class="o">(</span><span class="nc">WebMvcProperties</span> <span class="n">webMvcProperties</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">DispatcherServlet</span> <span class="n">dispatcherServlet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DispatcherServlet</span><span class="o">();</span>
			<span class="n">dispatcherServlet</span><span class="o">.</span><span class="na">setDispatchOptionsRequest</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">isDispatchOptionsRequest</span><span class="o">());</span>
			<span class="n">dispatcherServlet</span><span class="o">.</span><span class="na">setDispatchTraceRequest</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">isDispatchTraceRequest</span><span class="o">());</span>
			<span class="n">dispatcherServlet</span><span class="o">.</span><span class="na">setThrowExceptionIfNoHandlerFound</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">isThrowExceptionIfNoHandlerFound</span><span class="o">());</span>
			<span class="n">dispatcherServlet</span><span class="o">.</span><span class="na">setPublishEvents</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">isPublishRequestHandledEvents</span><span class="o">());</span>
			<span class="n">dispatcherServlet</span><span class="o">.</span><span class="na">setEnableLoggingRequestDetails</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">isLogRequestDetails</span><span class="o">());</span>
			<span class="k">return</span> <span class="n">dispatcherServlet</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span>
		<span class="nd">@ConditionalOnBean</span><span class="o">(</span><span class="nc">MultipartResolver</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
		<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="nc">DispatcherServlet</span><span class="o">.</span><span class="na">MULTIPART_RESOLVER_BEAN_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">MultipartResolver</span> <span class="nf">multipartResolver</span><span class="o">(</span><span class="nc">MultipartResolver</span> <span class="n">resolver</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Detect if the user has created a MultipartResolver but named it incorrectly</span>
			<span class="k">return</span> <span class="n">resolver</span><span class="o">;</span>
		<span class="o">}</span>

	<span class="o">}</span>

	<span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
	<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">DispatcherServletRegistrationCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">WebMvcProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">DispatcherServletConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DispatcherServletRegistrationConfiguration</span> <span class="o">{</span>

		<span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME</span><span class="o">)</span>
		<span class="nd">@ConditionalOnBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">DispatcherServlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="no">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DispatcherServletRegistrationBean</span> <span class="nf">dispatcherServletRegistration</span><span class="o">(</span><span class="nc">DispatcherServlet</span> <span class="n">dispatcherServlet</span><span class="o">,</span>
				<span class="nc">WebMvcProperties</span> <span class="n">webMvcProperties</span><span class="o">,</span> <span class="nc">ObjectProvider</span><span class="o">&lt;</span><span class="nc">MultipartConfigElement</span><span class="o">&gt;</span> <span class="n">multipartConfig</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">DispatcherServletRegistrationBean</span> <span class="n">registration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DispatcherServletRegistrationBean</span><span class="o">(</span><span class="n">dispatcherServlet</span><span class="o">,</span>
					<span class="n">webMvcProperties</span><span class="o">.</span><span class="na">getServlet</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
      <span class="c1">// åç§°</span>
			<span class="n">registration</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="no">DEFAULT_DISPATCHER_SERVLET_BEAN_NAME</span><span class="o">);</span>
      <span class="c1">// å¯åŠ¨é¡ºåº</span>
			<span class="n">registration</span><span class="o">.</span><span class="na">setLoadOnStartup</span><span class="o">(</span><span class="n">webMvcProperties</span><span class="o">.</span><span class="na">getServlet</span><span class="o">().</span><span class="na">getLoadOnStartup</span><span class="o">());</span>
			<span class="n">multipartConfig</span><span class="o">.</span><span class="na">ifAvailable</span><span class="o">(</span><span class="nl">registration:</span><span class="o">:</span><span class="n">setMultipartConfig</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">registration</span><span class="o">;</span>
		<span class="o">}</span>

	<span class="o">}</span>
  <span class="c1">// çœç•¥....</span>

<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åœ¨è‡ªåŠ¨é…ç½®çš„è¿™ä¸ªç±»é‡Œé¢ç”Ÿæˆäº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>å¯¹è±¡,è¿™ä¸ªå¯¹è±¡å°±æ˜¯ç”¨äºç»„æµ‹dispatcherServletçš„.<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>æ˜¯<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>çš„å­ç±»,ç”¨äºåˆå§‹åŒ–,æ³¨å†Œç­‰æ“ä½œç­‰.</p>

<p>â€‹	é‚£ä¹ˆè¿™ä¸ªå¯¹è±¡æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ³¨å†Œçš„å‘¢?åˆè¦å›åˆ°tomcatåˆ›å»ºçš„æ—¶å€™äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">WebServer</span> <span class="nf">getWebServer</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">...</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// çœç•¥..</span>
		<span class="n">prepareContext</span><span class="o">(</span><span class="n">tomcat</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">initializers</span><span class="o">);</span>
		<span class="k">return</span> <span class="nf">getTomcatWebServer</span><span class="o">(</span><span class="n">tomcat</span><span class="o">);</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	åœ¨è°ƒç”¨åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„æ—¶å€™æŠŠè¿™ä¸ªç©æ„å„¿ç»™ä¼ è¿›å»äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareContext</span><span class="o">(</span><span class="nc">Host</span> <span class="n">host</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// çœç•¥...</span>
		<span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializersToUse</span> <span class="o">=</span> <span class="n">mergeInitializers</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
		<span class="n">host</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
		<span class="n">configureContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">initializersToUse</span><span class="o">);</span>
		<span class="n">postProcessContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œåˆå¹¶äº†æ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>å¯¹è±¡,ä¼ å…¥åˆ°äº†<code class="language-plaintext highlighter-rouge">configureContext</code>æ–¹æ³•ä¸­.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">TomcatStarter</span> <span class="n">starter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TomcatStarter</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addServletContainerInitializer</span><span class="o">(</span><span class="n">starter</span><span class="o">,</span> <span class="no">NO_CLASSES</span><span class="o">);</span>

	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡ŒæŠŠ<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>è½¬æˆäº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">TomcatStarter</code>å¯¹è±¡,å¹¶æŠŠè¿™ä¸ªå¯¹è±¡æ·»åŠ åˆ°äº†ä¸Šä¸‹æ–‡ä¸­å».è¿™ä¸ª</p>

<p><code class="language-plaintext highlighter-rouge">TomcatStarter</code>å°±å‰å®³äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TomcatStarter</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Log</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="nc">TomcatStarter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Exception</span> <span class="n">startUpException</span><span class="o">;</span>

	<span class="nc">TomcatStarter</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="n">initializers</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// åˆå§‹åŒ–æ‰€æœ‰éœ€è¦ åˆå§‹åŒ–çš„ç±»</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">startUpException</span> <span class="o">=</span> <span class="n">ex</span><span class="o">;</span>
			<span class="c1">// Prevent Tomcat from logging and re-throwing when we know we can</span>
			<span class="c1">// deal with it in the main thread, but log for information here.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isErrorEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error starting Tomcat context. Exception: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">". Message: "</span>
						<span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nc">Exception</span> <span class="nf">getStartUpException</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">startUpException</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	<code class="language-plaintext highlighter-rouge">TomcatStarter</code>å®ç°äº†<code class="language-plaintext highlighter-rouge">ServletContainerInitializer</code>æ¥å£,è¿™ä¸ªæ¥å£å°±å‰å®³äº†,åœ¨servletçš„ç”Ÿå‘½ä¸­æœŸä¸­,ä¼šè°ƒç”¨å®ç°è¿™ä¸ªæ¥å£çš„<code class="language-plaintext highlighter-rouge">onStartup</code>æ–¹æ³•,è‡³äºä»€ä¹ˆæ˜¯servletçš„ç”Ÿå‘½å‘¨æœŸ,å°±ä¸å¼•å‡ºäº†,ä¼°è®¡ä¸€æ—¶åŠä¼šä¹Ÿè¯´ä¸å®Œ.</p>

<p>â€‹	å—¯,çŸ¥é“è¿™ä¸ªä¸œè¥¿çš„å‰å®³,è¯´äº†è¿™ä¹ˆå¤š,ä¹Ÿæ²¡è¯´<code class="language-plaintext highlighter-rouge">ServletContextInitializer</code>è¿™ä¸ªä¸œè¥¿å“ªæ¥çš„.ä¸æ˜¯æ–¹æ³•ä¼ è¿›æ¥çš„å˜›?ä¸è¡Œå°±å›å»çœ‹çœ‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">WebServer</span> <span class="nf">getWebServer</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">...</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// çœç•¥...</span>
		<span class="k">return</span> <span class="nf">getTomcatWebServer</span><span class="o">(</span><span class="n">tomcat</span><span class="o">);</span>
	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	å—¯,æ˜¯ä¼ è¿›æ¥çš„,æ€ä¹ˆä¼ è¿›æ¥çš„ï¼Ÿå½“ç„¶æ˜¯åˆ›å»ºçš„æ—¶å€™ä¼ çš„äº†0.0</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ServletWebServerApplicationContext</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">createWebServer</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">WebServer</span> <span class="n">webServer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">webServer</span><span class="o">;</span>
		<span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">webServer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">servletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">ServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">getWebServerFactory</span><span class="o">();</span>
			<span class="k">this</span><span class="o">.</span><span class="na">webServer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="n">initPropertySources</span><span class="o">();</span>
	<span class="o">}</span>
</code></pre></div></div>

<h2 id="62-servletcontextinitializer-æ€ä¹ˆæ¥çš„">6.2 ServletContextInitializer æ€ä¹ˆæ¥çš„</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 	ServletWebServerApplicationContext</span>
<span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ServletContextInitializer</span> <span class="nf">getSelfInitializer</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">::</span><span class="n">selfInitialize</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">selfInitialize</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
		<span class="n">prepareWebApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
		<span class="n">registerApplicationScope</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
		<span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">registerEnvironmentBeans</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">(),</span> <span class="n">servletContext</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">beans</span> <span class="o">:</span> <span class="n">getServletContextInitializerBeans</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">beans</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™å°±æ˜¯äº†,é‚£é…ç½®ç±»<code class="language-plaintext highlighter-rouge">DispatcherServletAutoConfiguration</code>é‡Œé¢çš„<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>å“ªå»äº†?è¿™é‡Œçš„ç¡®æ²¡æœ‰,ä¸è¿‡åœ¨<code class="language-plaintext highlighter-rouge">getServletContextInitializerBeans()</code>æ–¹æ³•è¿”å›çš„é›†åˆé‡Œé¢.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ServletWebServerApplicationContext</span>
<span class="kd">protected</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="nf">getServletContextInitializerBeans</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">());</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	<code class="language-plaintext highlighter-rouge">ServletContextInitializerBeans</code>æ˜¯ä¸€ä¸ªç»§æ‰¿äº†<code class="language-plaintext highlighter-rouge">AbstractCollection</code>çš„é›†åˆå¯¹è±¡.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ServletContextInitializerBeans</span>
<span class="kd">public</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span>
			<span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;...</span> <span class="n">initializerTypes</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
		<span class="k">this</span><span class="o">.</span><span class="na">initializerTypes</span> <span class="o">=</span> <span class="o">(</span><span class="n">initializerTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">initializerTypes</span><span class="o">)</span>
				<span class="o">:</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">addServletContextInitializerBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
		<span class="n">addAdaptableBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">sortedInitializers</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
				<span class="o">.</span><span class="na">flatMap</span><span class="o">((</span><span class="n">value</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">sorted</span><span class="o">(</span><span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">))</span>
				<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
		<span class="k">this</span><span class="o">.</span><span class="na">sortedList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">sortedInitializers</span><span class="o">);</span>
		<span class="n">logMappings</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">initializers</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	æ ¸å¿ƒé€»è¾‘å°±åœ¨æ„é€ æ–¹æ³•ä¸­çš„<code class="language-plaintext highlighter-rouge">addServletContextInitializerBeans</code>æ–¹æ³•ä¸­.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ServletContextInitializerBeans</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">initializerType</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializerTypes</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">initializerBean</span> <span class="o">:</span> <span class="n">getOrderedBeansOfType</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span>
					<span class="n">initializerType</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">addServletContextInitializerBean</span><span class="o">(</span><span class="n">initializerBean</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">initializerBean</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">beanFactory</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;&gt;</span> <span class="nf">getOrderedBeansOfType</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">getOrderedBeansOfType</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;&gt;</span> <span class="nf">getOrderedBeansOfType</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span>
			<span class="nc">Set</span><span class="o">&lt;?&gt;</span> <span class="n">excludes</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span><span class="o">[]</span> <span class="n">names</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">names</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">excludes</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">ScopedProxyUtils</span><span class="o">.</span><span class="na">isScopedTarget</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
				<span class="no">T</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">excludes</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bean</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">beans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">());</span>
		<span class="n">beans</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">o2</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
		<span class="k">return</span> <span class="n">beans</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ä»iocä¸­è·å–æ‰€æœ‰<code class="language-plaintext highlighter-rouge">ServletContextInitialize</code>çš„å­ç±»,è€Œè¿™ä¸ªbeanå°±åˆšå¥½æ˜¯ä¹‹å‰é…ç½®ç±»ä¸­çš„bean,<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>.</p>

<p>â€‹	è‡³äºæ³¨å†Œçš„é€»è¾‘å°±ä¸é˜è¿°äº†,å¾ˆç®€å•,é¡ºç€<code class="language-plaintext highlighter-rouge">DispatcherServletRegistrationBean</code>çš„çˆ¶ç±»<code class="language-plaintext highlighter-rouge">RegistrationBean</code>çœ‹ä¸‹å»å°±å¥½.</p>

<h1 id="ä¸ƒæ•´ç†çº¿ç´¢">ä¸ƒã€æ•´ç†çº¿ç´¢</h1>

<p>â€‹	å‰é¢è¯´äº†é‚£ä¹ˆå¤šè·Ÿ404å®Œå…¨æ²¡æœ‰å…³ç³»å‘€,å…¶å®å‰é¢æ˜¯åœ¨åšé“ºå«è€Œå·²,çœ‹å®˜åˆ«ç€æ€¥.ç”±å‰æ–‡çš„é€»è¾‘å¯ä»¥çŸ¥é“åœ¨tomcaté‡Œé¢è‡³å°‘æ³¨å†Œäº†2ä¸ªservetl,ä¸€ä¸ªæ˜¯springçš„(åé¢è¦†ç›–çš„),ä¸€ä¸ªæ˜¯jspçš„.é‚£ä¹ˆå®Œå…¨ç”±ç†ç”±çŒœæµ‹,æœ€åç”±JstlViewè½¬å‘çš„è¯·æ±‚åˆ°äº†jspServleté‡Œé¢.æ¥çœ‹çœ‹jspSerlveté‡Œé¢å¹²äº†å•¥?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// JspServlet</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">service</span> <span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>

       	<span class="c1">// çœç•¥....</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">serviceJspFile</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">jspUri</span><span class="o">,</span> <span class="n">precompile</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ExceptionUtils</span><span class="o">.</span><span class="na">handleThrowable</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åˆ«é—®æˆ‘ä¸ºå•¥åªè´´äº†serviceè¿™ä¸ªæ–¹æ³•.å…ˆçœ‹çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•<code class="language-plaintext highlighter-rouge">serviceJspFile</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// JspServlet </span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">serviceJspFile</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                                <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jspUri</span><span class="o">,</span>
                                <span class="kt">boolean</span> <span class="n">precompile</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">JspServletWrapper</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="n">rctxt</span><span class="o">.</span><span class="na">getWrapper</span><span class="o">(</span><span class="n">jspUri</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">wrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">wrapper</span> <span class="o">=</span> <span class="n">rctxt</span><span class="o">.</span><span class="na">getWrapper</span><span class="o">(</span><span class="n">jspUri</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">wrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Check if the requested JSP page exists, to avoid</span>
                    <span class="c1">// creating unnecessary directories and files.</span>
                  	<span class="c1">// åˆ¤æ–­ jsp æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
                    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">jspUri</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">handleMissingResource</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">jspUri</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JspServletWrapper</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="n">jspUri</span><span class="o">,</span>
                                                    <span class="n">rctxt</span><span class="o">);</span>
                    <span class="n">rctxt</span><span class="o">.</span><span class="na">addWrapper</span><span class="o">(</span><span class="n">jspUri</span><span class="o">,</span><span class="n">wrapper</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">wrapper</span><span class="o">.</span><span class="na">service</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">precompile</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">fnfe</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleMissingResource</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">jspUri</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¯º,æ ¸å¿ƒä»£ç è¢«æŠ“äº†.è¿™ä¸ªSerlvetContext,æ—¢ç„¶åœ¨tomcaté‡Œé¢é‚£ä¹ˆå®ƒçš„å®ç°ç±»è‚¯å®šæ˜¯<code class="language-plaintext highlighter-rouge">ApplicationContext</code>,ä¸ç”¨æ€€ç–‘,ä¸ä¿¡ä½ è·Ÿè·Ÿæµç¨‹çœ‹çœ‹.</p>

<p>â€‹	æ—¢ç„¶æ˜¯<code class="language-plaintext highlighter-rouge">ApplicationContext</code>ä¸­è·å–èµ„æº,é‚£æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆæ‹¿çš„æ–‡ä»¶å§.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//  ApplicationContext</span>
<span class="kd">public</span> <span class="no">URL</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MalformedURLException</span> <span class="o">{</span>

      	<span class="c1">// çœç•¥... </span>
        <span class="nc">WebResourceRoot</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resources</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          	<span class="c1">// è·å–èµ„æº</span>
            <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">validatedPath</span><span class="o">).</span><span class="na">getURL</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

</code></pre></div></div>

<p>â€‹	è½¬æˆ˜åˆ° <code class="language-plaintext highlighter-rouge">WebResourceRoot</code>é‡Œå»,<code class="language-plaintext highlighter-rouge">WebResourceRoot</code>æ˜¯ä¸ªæ¥å£,åœ¨æœ¬æ¡ˆä¾‹ä¸­çš„å”¯ä¸€å­ç±»æ˜¯<code class="language-plaintext highlighter-rouge">StandardRoot</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// StandardRoot</span>
<span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">WebResource</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getResource</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="nc">WebResource</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">validate</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">useClassLoaderResources</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">validate</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">validate</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="o">}</span>
				<span class="c1">// åˆ¤æ–­æ˜¯å¦å…è®¸ç¼“å­˜,è¿™ä¸ªé»˜è®¤å€¼æ˜¯true</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isCachingAllowed</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">useClassLoaderResources</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getResourceInternal</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">useClassLoaderResources</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µ,ä¸€ä¸ªæ˜¯ä»æ¢æˆé‡Œé¢è·å–,å¦å¤–åˆ™ä»éç¼“å­˜ä¸­è·å–,ç¼“å­˜é‡Œé¢çš„ä¸–ç•Œå¾ˆç²¾å½©çš„.</p>

<h2 id="71-ä»ç¼“å­˜é‡Œé¢è·å–">7.1 ä»ç¼“å­˜é‡Œé¢è·å–</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Cache</span>
<span class="kd">protected</span> <span class="nc">WebResource</span> <span class="nf">getResource</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">useClassLoaderResources</span><span class="o">)</span> <span class="o">{</span>

  	<span class="c1">// çœç•¥....</span>
		<span class="c1">// åˆ¤æ–­æ˜¯å¦è·å–åˆ°ç¼“å­˜</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cacheEntry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Local copy to ensure consistency</span>
        <span class="kt">int</span> <span class="n">objectMaxSizeBytes</span> <span class="o">=</span> <span class="n">getObjectMaxSizeBytes</span><span class="o">();</span>
      	<span class="c1">// åˆ›å»ºç¼“å­˜å¯¹è±¡</span>
        <span class="nc">CachedResource</span> <span class="n">newCacheEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CachedResource</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="n">path</span><span class="o">,</span> <span class="n">getTtl</span><span class="o">(),</span>
                <span class="n">objectMaxSizeBytes</span><span class="o">,</span> <span class="n">useClassLoaderResources</span><span class="o">);</span>

        <span class="c1">// Concurrent callers will end up with the same CachedResource</span>
        <span class="c1">// instance</span>
      	<span class="c1">// æ”¾å…¥ç¼“å­˜ä¸­</span>
        <span class="n">cacheEntry</span> <span class="o">=</span> <span class="n">resourceCache</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">newCacheEntry</span><span class="o">);</span>
				<span class="c1">// äºŒæ¬¡åˆ¤æ–­</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cacheEntry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// newCacheEntry was inserted into the cache - validate it</span>
            <span class="n">cacheEntry</span> <span class="o">=</span> <span class="n">newCacheEntry</span><span class="o">;</span>
          	<span class="c1">// éªŒè¯èµ„æºçš„åˆæ³•æ€§(è¿™é‡Œå°±çŸ³é”¤äº†)</span>
            <span class="n">cacheEntry</span><span class="o">.</span><span class="na">validateResource</span><span class="o">(</span><span class="n">useClassLoaderResources</span><span class="o">);</span>
		<span class="c1">// çœç•¥....</span>

    <span class="k">return</span> <span class="n">cacheEntry</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿˜å·®2æ­¥</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// CachedResource</span>
<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">validateResource</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">useClassLoaderResources</span><span class="o">)</span> <span class="o">{</span>
       <span class="c1">// çœç•¥..</span>
  			<span class="c1">// éç©ºæ£€æŸ¥</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">webResource</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          	<span class="c1">// åŠ é”</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
              	<span class="c1">// åŒé‡æ£€æŸ¥</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">webResource</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">webResource</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getResourceInternal</span><span class="o">(</span>
                            <span class="n">webAppPath</span><span class="o">,</span> <span class="n">useClassLoaderResources</span><span class="o">);</span>
                    <span class="n">getLastModified</span><span class="o">();</span>
                    <span class="n">getContentLength</span><span class="o">();</span>
                    <span class="n">nextCheck</span> <span class="o">=</span> <span class="n">ttl</span> <span class="o">+</span> <span class="n">now</span><span class="o">;</span>
                    <span class="c1">// exists() is a relatively expensive check for a file so</span>
                    <span class="c1">// use the fact that we know if it exists at this point</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">webResource</span> <span class="k">instanceof</span> <span class="nc">EmptyResource</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">cachedExists</span> <span class="o">=</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">cachedExists</span> <span class="o">=</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	ç¨‹åºåˆæ¬¡å…è®¸çš„æ—¶å€™,webResourceè‚¯å®šæ˜¯ä¸ºç©ºçš„,åˆ«è¯´ç¼“å­˜äº†.è¿™é‡Œçš„rootæ˜¯<code class="language-plaintext highlighter-rouge">StandardRoot</code>,åˆè°ƒç”¨å›å»äº†.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// StandardRoot</span>

 <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebResourceSet</span><span class="o">&gt;&gt;</span> <span class="n">allResources</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">{</span>
        <span class="n">allResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">preResources</span><span class="o">);</span>
        <span class="n">allResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mainResources</span><span class="o">);</span>
        <span class="n">allResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">classResources</span><span class="o">);</span>
        <span class="n">allResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">jarResources</span><span class="o">);</span>
        <span class="n">allResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">postResources</span><span class="o">);</span>
    <span class="o">}</span>

<span class="kd">protected</span> <span class="kd">final</span> <span class="nc">WebResource</span> <span class="nf">getResourceInternal</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">useClassLoaderResources</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">WebResource</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">WebResource</span> <span class="n">virtual</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">WebResource</span> <span class="n">mainEmpty</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebResourceSet</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">:</span> <span class="n">allResources</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">WebResourceSet</span> <span class="n">webResourceSet</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">useClassLoaderResources</span> <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">webResourceSet</span><span class="o">.</span><span class="na">getClassLoaderOnly</span><span class="o">()</span> <span class="o">||</span>
                        <span class="n">useClassLoaderResources</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">webResourceSet</span><span class="o">.</span><span class="na">getStaticOnly</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">webResourceSet</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">virtual</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isVirtual</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">virtual</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">main</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">webResourceSet</span><span class="o">))</span> <span class="o">{</span>
                            <span class="n">mainEmpty</span> <span class="o">=</span> <span class="n">result</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
				<span class="c1">// çœç•¥...</span>
        <span class="c1">// Default is empty resource in main resources</span>
        <span class="k">return</span> <span class="n">mainEmpty</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹	è¿™é‡Œéå†ä¸åŒèµ„æºç±»åˆ«,æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨,å¦‚æœå­˜åœ¨å°±è¿”å›,ç„¶åæ”¾å…¥ç¼“å­˜ä¸­.è‡³äºä»éç¼“å­˜ä¸­è·å–çš„é€»è¾‘å°±ä¸Šé¢<code class="language-plaintext highlighter-rouge">getResourceInternal</code>çš„é€»è¾‘,å°±ä¸ç½—å—¦äº†.</p>

<p>â€‹	å—¯,è¿™ä¸ªæœ‰å•¥ç”¨å‘¢?è¿˜æ˜¯æœªè§£å†³404çš„é—®é¢˜å‘€,åˆ«æ€¥å¿«äº†.</p>

<h1 id="å…«è¢«é—å¿˜çš„é™æ€èµ„æºç›‘å¬å™¨staticresourceconfigurer">å…«ã€è¢«é—å¿˜çš„é™æ€èµ„æºç›‘å¬å™¨(StaticResourceConfigurer)</h1>

<p>â€‹	å°‘ä¾ æ˜¯å¦è®°å¾—åœ¨åˆ›å»ºtomcatçš„æ—¶å€™åœ¨servletContextä¸­æ·»åŠ äº†ä¸ªè¿™ä¸ªç›‘å¬å™¨å‘¢?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareContext</span><span class="o">(</span><span class="nc">Host</span> <span class="n">host</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// çœç•¥...</span>
		<span class="n">context</span><span class="o">.</span><span class="na">addLifecycleListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">StaticResourceConfigurer</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
		<span class="c1">// çœç•¥...</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	å†æ¥çœ‹çœ‹è¿™ä¸ªç›‘å¬å™¨çš„é€»è¾‘å§.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// TomcatServletWebServerFactory$StaticResourceConfigurer</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StaticResourceConfigurer</span> <span class="kd">implements</span> <span class="nc">LifecycleListener</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>

		<span class="kd">private</span> <span class="nf">StaticResourceConfigurer</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">lifecycleEvent</span><span class="o">(</span><span class="nc">LifecycleEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">CONFIGURE_START_EVENT</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">addResourceJars</span><span class="o">(</span><span class="n">getUrlsOfJarsWithMetaInfResources</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addResourceJars</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">resourceJarUrls</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="no">URL</span> <span class="n">url</span> <span class="o">:</span> <span class="n">resourceJarUrls</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar"</span><span class="o">)</span> <span class="o">||</span> <span class="n">path</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar!/"</span><span class="o">))</span> <span class="o">{</span>
					<span class="nc">String</span> <span class="n">jar</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">jar</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"jar:"</span><span class="o">))</span> <span class="o">{</span>
						<span class="c1">// A jar file in the file system. Convert to Jar URL.</span>
						<span class="n">jar</span> <span class="o">=</span> <span class="s">"jar:"</span> <span class="o">+</span> <span class="n">jar</span> <span class="o">+</span> <span class="s">"!/"</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="n">addResourceSet</span><span class="o">(</span><span class="n">jar</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">addResourceSet</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addResourceSet</span><span class="o">(</span><span class="nc">String</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">isInsideNestedJar</span><span class="o">(</span><span class="n">resource</span><span class="o">))</span> <span class="o">{</span>
					<span class="c1">// It's a nested jar but we now don't want the suffix because Tomcat</span>
					<span class="c1">// is going to try and locate it as a root URL (not the resource</span>
					<span class="c1">// inside it)</span>
					<span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">resource</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">2</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
				<span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"/META-INF/resources"</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">createWebResourceSet</span><span class="o">(</span><span class="nc">ResourceSetType</span><span class="o">.</span><span class="na">RESOURCE_JAR</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Ignore (probably not a directory)</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isInsideNestedJar</span><span class="o">(</span><span class="nc">String</span> <span class="n">dir</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">dir</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"!/"</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">dir</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"!/"</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>

</code></pre></div></div>

<p>â€‹	æ— è®ºé€»è¾‘æ€ä¹ˆå˜åŒ–,æœ€åç›‘å¬å™¨çš„ä»£ç éƒ½ä¼šèµ°åˆ°<code class="language-plaintext highlighter-rouge">this.context.getResources().createWebResourceSet(ResourceSetType.RESOURCE_JAR, "/", url, path);</code>è¿™å¥è¯æ¥.</p>

<p>â€‹	çœ‹åˆ°<code class="language-plaintext highlighter-rouge">ResourceSetType.RESOURCE_JAR</code>è¿™ä¸ªå¸¸é‡æ˜¯å¦æœ‰ç‚¹æ„Ÿè§‰å‘¢?æ²¡æ„Ÿè§‰å°±è„±æ‰è¡£æœå†çœ‹çœ‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// StandardRoot </span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">createWebResourceSet</span><span class="o">(</span><span class="nc">ResourceSetType</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">webAppMount</span><span class="o">,</span>
            <span class="no">URL</span> <span class="n">url</span><span class="o">,</span> <span class="nc">String</span> <span class="n">internalPath</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BaseLocation</span> <span class="n">baseLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BaseLocation</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">createWebResourceSet</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">webAppMount</span><span class="o">,</span> <span class="n">baseLocation</span><span class="o">.</span><span class="na">getBasePath</span><span class="o">(),</span>
                <span class="n">baseLocation</span><span class="o">.</span><span class="na">getArchivePath</span><span class="o">(),</span> <span class="n">internalPath</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createWebResourceSet</span><span class="o">(</span><span class="nc">ResourceSetType</span> <span class="n">type</span><span class="o">,</span> <span class="nc">String</span> <span class="n">webAppMount</span><span class="o">,</span>
            <span class="nc">String</span> <span class="n">base</span><span class="o">,</span> <span class="nc">String</span> <span class="n">archivePath</span><span class="o">,</span> <span class="nc">String</span> <span class="n">internalPath</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebResourceSet</span><span class="o">&gt;</span> <span class="n">resourceList</span><span class="o">;</span>
        <span class="nc">WebResourceSet</span> <span class="n">resourceSet</span><span class="o">;</span>

        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nl">PRE:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">preResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">CLASSES_JAR:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">classResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">RESOURCE_JAR:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">jarResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">POST:</span>
                <span class="n">resourceList</span> <span class="o">=</span> <span class="n">postResources</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                        <span class="n">sm</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"standardRoot.createUnknownType"</span><span class="o">,</span> <span class="n">type</span><span class="o">));</span>
        <span class="o">}</span>
      	<span class="c1">// çœç•¥</span>
        <span class="n">resourceList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">resourceSet</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹	æ˜¯ä¸æ˜¯è¿™ä¸€åˆ‡éƒ½å›­å›å»äº†ï¼Ÿæ˜¯ä¸æ˜¯æ„Ÿè§‰ç–‘æƒ‘éƒ½æ²¡äº†?å¦‚æœè¿˜æ˜¯ä¸è§£åœ¨å»çœ‹çœ‹èµ„æºè§£æçš„é‚£å—å„¿.</p>

<h1 id="ä¹çœŸç›¸">ä¹ã€çœŸç›¸</h1>

<p>â€‹	ä¸ºç”šä¹ˆæ˜¯404å‘¢?é‚£æ˜¯å› ä¸ºåœ¨StandardRooté‡Œé¢çš„resourceListä¸­ä¸å­˜åœ¨æŒ‡å®šçš„æ ¹è·¯å¾„,æ‰€ä»¥æ˜¯404.åˆè¦æœ‰å°ä¼™ä¼´è¦æ äº†,è¯´MATE-INFOç›®å½•ä¸‹é¢çš„éƒ½æ²¡é—®é¢˜.</p>

<p>â€‹	æ˜¯,æ²¡é—®é¢˜.å› ä¸ºspringBootæŠŠè¿™ä¸ªè·¯å¾„åŠ è¿›å»äº†.ä¸ä¿¡ä½ çœ‹.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// StaticResourceConfigurer</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StaticResourceConfigurer</span> <span class="kd">implements</span> <span class="nc">LifecycleListener</span> <span class="o">{</span>

		<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>

		<span class="kd">private</span> <span class="nf">StaticResourceConfigurer</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">lifecycleEvent</span><span class="o">(</span><span class="nc">LifecycleEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">CONFIGURE_START_EVENT</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">addResourceJars</span><span class="o">(</span><span class="n">getUrlsOfJarsWithMetaInfResources</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addResourceJars</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">resourceJarUrls</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// çœç•¥</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">addResourceSet</span><span class="o">(</span><span class="nc">String</span> <span class="n">resource</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// çœç•¥</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isInsideNestedJar</span><span class="o">(</span><span class="nc">String</span> <span class="n">dir</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">dir</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"!/"</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">dir</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"!/"</span><span class="o">);</span>
		<span class="o">}</span>

	<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	åœ¨<code class="language-plaintext highlighter-rouge">getUrlsOfJarsWithMetaInfResources</code>æ–¹æ³•é‡Œé¢å°±æœ‰è¿™ä¸ªè·¯å¾„.é€»è¾‘ç®€å•å°±ä¸è´´å‡ºæ¥äº†.</p>

<h2 id="91-å¦‚ä½•è§£å†³404">9.1 å¦‚ä½•è§£å†³404</h2>

<p>â€‹	æ ¹æ®ä»¥ä¸Šçš„åˆ†æ,å¯ä»¥å’Œspringä¸€æ ·å¼„ä¸ªç›‘å¬å™¨,åœ¨resourceListæ·»åŠ æŒ‡å®šçš„è·¯å¾„.æœ€ç®€å•æš´åŠ›çš„æ–¹æ³•å¦‚ä¸‹:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test-static"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testStatic</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index-static"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test-public"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testPublic</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index-public"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test-resources"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testResources</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index-resources"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test-meta"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testMeta</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index-meta"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TomcatServletWebServerFactory</span> <span class="nf">getTomcatServletWebServerFactory</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AdvTomcatServletWebServerFactory</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<p>è‡ªå®šä¹‰å·¥å‚:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AdvTomcatServletWebServerFactory</span> <span class="kd">extends</span> <span class="nc">TomcatServletWebServerFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AdvTomcatServletWebServerFactory</span><span class="o">(){</span>
        <span class="n">getContextLifecycleListeners</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">AdvResourceListener</span><span class="o">());</span>
    <span class="o">}</span>
		<span class="c1">// è¿™ä¸ªæ–¹æ³•æ˜¯ springç•™ä¸‹çš„æ¨¡æ¿æ–¹æ³•</span>
  	<span class="c1">// å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•è¿›è¡Œæ‰©å±•</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">postProcessContext</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span>  <span class="kd">class</span> <span class="nc">AdvResourceListener</span> <span class="kd">implements</span> <span class="nc">LifecycleListener</span><span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lifecycleEvent</span><span class="o">(</span><span class="nc">LifecycleEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Lifecycle</span><span class="o">.</span><span class="na">CONFIGURE_START_EVENT</span><span class="o">))</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="no">URL</span> <span class="n">resource</span> <span class="o">=</span> <span class="nc">AdvTomcatServletWebServerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResource</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
                <span class="kd">final</span> <span class="nc">WebResourceRoot</span> <span class="n">resources</span> <span class="o">=</span> <span class="nc">AdvTomcatServletWebServerFactory</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
                <span class="n">resources</span><span class="o">.</span><span class="na">createWebResourceSet</span><span class="o">(</span><span class="nc">WebResourceRoot</span><span class="o">.</span><span class="na">ResourceSetType</span><span class="o">.</span><span class="na">RESOURCE_JAR</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">resource</span><span class="o">,</span> <span class="s">"/static"</span><span class="o">);</span>
                <span class="n">resources</span><span class="o">.</span><span class="na">createWebResourceSet</span><span class="o">(</span><span class="nc">WebResourceRoot</span><span class="o">.</span><span class="na">ResourceSetType</span><span class="o">.</span><span class="na">RESOURCE_JAR</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">resource</span><span class="o">,</span> <span class="s">"/public"</span><span class="o">);</span>
                <span class="n">resources</span><span class="o">.</span><span class="na">createWebResourceSet</span><span class="o">(</span><span class="nc">WebResourceRoot</span><span class="o">.</span><span class="na">ResourceSetType</span><span class="o">.</span><span class="na">RESOURCE_JAR</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="n">resource</span><span class="o">,</span> <span class="s">"/resources"</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>â€‹	é€šè¿‡è‡ªå·±çš„å·¥å‚æ›¿æ¢æ‰springçš„å·¥å‚,å®ç°æ³¨å†Œè‡ªå·±çš„ç›‘å¬å™¨,å½“ç„¶æ–¹æ³•è¿˜æœ‰å¾ˆå¤š,å¦‚æœä½ ç†Ÿæ‚‰tomcatçš„å¯åŠ¨æµç¨‹çš„è¯.</p>

<h1 id="åå°ç»“">åã€å°ç»“</h1>

<p>â€‹	åœ¨springBootçš„æ‡’äººå¥—é¤ä¸‹,å‡ºç°é—®é¢˜å¾€å¾€ä¼šè®©äººé˜²ä¸èƒœé˜²å‘€,æ¯”å¦‚è¿™ä¸ª404,æ ¹æœ¬æ²¡æœ‰ä»»ä½•ä¿¡æ¯è¯´å“ªé‡Œæœ‰é—®é¢˜(é™¤éæ˜¯å¼€äº†debugæ—¥å¿—).</p>

<p>â€‹	æœ¬æ¥å°±æƒ³è°¢è°¢è§£å†³æ–¹æ¡ˆçš„,ç»“æœå†™äº†è¿™ä¹ˆå¤š,åƒé¥­äº†.</p>
:ET