I"ş6<h1 id="ä¸€cdcæ¦‚å¿µ">ä¸€ã€CDCæ¦‚å¿µ</h1>

<p>â€‹	CDC(Changing Data Capture)æ„æ€æ˜¯æ•æ‰å˜åŒ–çš„æ•°æ®,ç”¨æµçš„æ–¹å¼æŒç»­æ•æ‰.è¿™ä¸ETCæœ‰ç€æœ¬è´¨ä¸Šçš„åŒºåˆ«,ETLåˆ™æ˜¯å®šæ—¶æ‹‰å–æ•°æ®.</p>

<p>â€‹	ETL æ¦‚å¿µä¸Šæ˜¯:æŠ½å–(E)ã€è½¬æ¢(T)ã€å¯¼å…¥(L),ETLç°åœ¨æ˜¯æ¯”è¾ƒæˆç†Ÿçš„,æ–¹æ¡ˆä¹Ÿæ¯”è¾ƒå¤š.ä½†å®šæ—¶æŠ½å–å°±ä¼šæ„å‘³ç€æœ‰æ—¶æ•ˆæ€§çš„é—®é¢˜,å¦‚æœæœ‰ä¸€ç§æ–¹æ¡ˆ,æ•°æ®åº“æ•°æ®å‡ºç°æ›´æ”¹å°±è‡ªåŠ¨åŒæ­¥åˆ°OLAPå¼•æ“é‡Œé¢,å²‚ä¸æ˜¯ç¾æ»‹æ»‹?é‚£ä¹ˆCDCå°±æ˜¯ä¸ºæ­¤è€Œç”Ÿçš„,æŒç»­ä¸æ–­çš„ç›‘å¬æ•°æ®åº“çš„å˜åŒ–æƒ…å†µ,ä¸€æ—¦å˜åŒ–å°±ç«‹é©¬å‘å‡ºæ¶ˆæ¯è¿›è¡ŒåŒæ­¥æ¶ˆæ¯,ä½†è¿™ç§æ–¹æ¡ˆä¹Ÿå¹¶éå®Œç¾,å¦‚é‡åˆ°å¤§äº‹åŠ¡çš„SQL,æ‰¹é‡æ›´æ–°çš„è¿™ç§,ä¹Ÿä¼šæœ‰å»¶è¿Ÿçš„é—®é¢˜,æƒè¡¡ä¸€ä¸‹ä¼°è®¡ä¸¤è€…å·®ä¸å¤š.</p>

<p>â€‹	å¸‚é¢ä¸Šå¸¸ç”¨çš„æ•°æ®åº“æœ‰Mysql,PostgreSqlç­‰,Mysqlçš„CDCæ–¹æ¡ˆæ¯”è¾ƒå¤š,é€šè¿‡ç›‘å¬binlogå®ç°.è€ŒPostgresqlçš„CDCæ–¹æ¡ˆåˆ™æ¯”è¾ƒå°‘,è‡³å°‘ä»ç™¾åº¦(ğŸ¶ï¸)ä¸Šæ‰¾çš„èµ„æ–™æ¥çœ‹.</p>

<h1 id="äºŒpostgresql-cdc-æ–¹æ¡ˆ">äºŒã€Postgresql CDC æ–¹æ¡ˆ</h1>

<p>â€‹	Postgresql å®ç°CDCæ˜¯é€šè¿‡é€»è¾‘å¤åˆ¶å®ç°çš„,ä¸Mysql çš„binlogæœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„.è¯¦æƒ…è¯·çœ‹å®˜æ–¹<a href="http://postgres.cn/docs/11/logical-replication.html">æ–‡æ¡£</a>.åªè¦åœ¨pgsqlçš„é…ç½®æ–‡ä»¶ä¸­<code class="language-plaintext highlighter-rouge">wal_level</code>å±æ€§è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">logical</code>å°±é…ç½®å¥½äº†,å†åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®¢é˜…,ä»¥åŠå¤åˆ¶æ§½,ä»¥ä¸Šæ“ä½œæ¯”è¾ƒç®€å•,ä¸å†è®°å½•,è¯¦æƒ…æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£.</p>

<p>â€‹	åœ¨pgsqlä¸­å¼€å¯äº†é€»è¾‘å¤åˆ¶,ä½†è¿˜å·®ä¸€ä¸ªé€»è¾‘è§£ç è¾“å‡ºæ’ä»¶.å¸‚é¢ä¸Šè§£ç æ’ä»¶æœ‰3æ¬¾,å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å†™<a href="http://postgres.cn/docs/11/logicaldecoding-output-plugin.html">è§£ç æ’ä»¶</a>.</p>

<ul>
  <li>
    <p>é€»è¾‘è§£ç æ’ä»¶åˆ—è¡¨</p>

    <ol>
      <li>
        <p>wal2json</p>

        <p>è¿™æ¬¾æ’ä»¶ä¼šæŠŠæ¶ˆæ¯è§£ç æˆjsonæ ¼å¼,æ–¹ä¾¿äºæ¶ˆè´¹ç«¯è¿›è¡Œæ¶ˆè´¹.ä¸€ä¸ªäº‹åŠ¡ä¸€æ¡æ¶ˆæ¯,github åœ°å€:https://github.com/eulerto/wal2json.</p>

        <p>ä¼˜ç‚¹:</p>

        <p>â€‹	æ¶ˆæ¯æ˜¯jsonæ ¼å¼æ–¹ä¾¿ä½¿ç”¨</p>

        <p>ç¼ºç‚¹:</p>

        <p>â€‹	å¯¹äºå¤§äº‹åŠ¡æ¶ˆæ¯,æ¯”å¦‚ä¸€æ¬¡æ€§ä¿®æ”¹å‡ åä¸‡æ¡æ•°æ®,ä¼šè€—å°½å†…å­˜.</p>

        <p>â€‹	æ²¡æœ‰ç°åœºçš„æ’ä»¶,éœ€è¦è‡ªè¡Œç¼–è¯‘.åœ¨centosä¸Šè¿›è¡Œç¼–è¯‘æœ‰ç‚¹ç‚¹éº»çƒ¦.</p>

        <p>javaç«¯çš„æ¶ˆè´¹è€…ä»£ç å¯ä»¥å‚è€ƒè¿ªå£«å°¼çš„é¡¹ç›®:https://github.com/disneystreaming/pg2k4j</p>
      </li>
      <li>
        <p>decoderbufs</p>

        <p>æ¶ˆæ¯æ ¼å¼ä¸ºprotobuf,æ¯”jsonçœå¸¦å®½.ä¸€ä¸ªäº‹åŠ¡å¤šæ¡æ¶ˆæ¯.githubåœ°å€:https://github.com/xstevens/decoderbufs,ç°åœ¨è¿™ä¸ªæ’ä»¶åŸä½œè€…å·²ç»ä¸ç»´æŠ¤äº†.å¯ä»¥ç”¨debeziumç»´æŠ¤çš„ç‰ˆæœ¬https://github.com/debezium/postgres-decoderbufs.</p>

        <p>ä¼˜ç‚¹:</p>

        <p>â€‹	å¤§äº‹åŠ¡ä¸ä¼šè€—å°½å†…å­˜,æ•ˆç‡æ¯”jsoné«˜</p>

        <p>ç¼ºç‚¹:</p>

        <p>â€‹	åœ¨centosä¸Šä¸å¥½ç¼–è¯‘,ç¼–è¯‘åŠé€€.æœåŠ¡å™¨ä¸å»ºè®®ä½¿ç”¨centos,å…å¾—å„ç§ç¼–è¯‘é—®é¢˜.(å…³é”®æ˜¯ç¼–è¯‘å¥½äº†,åœ¨javaç«¯ä¸€è¯»å–æ¶ˆæ¯å°±å´©,è‡³ä»Šæ²¡æ‰¾åˆ°åŸå› ,é€€äº†,é€€äº†.)</p>

        <p>javaç«¯çš„æ¶ˆè´¹è€…ä»£ç å¯ä»¥å‚è€ƒdebeziumé¡¹ç›®ä¸­çš„connector-postgresql:https://github.com/debezium/debezium</p>
      </li>
      <li>
        <p>pgoutput</p>

        <p>è¯¥æ’ä»¶æ˜¯å®˜æ–¹çš„,åªèƒ½é€‚ç”¨äº10+çš„ç‰ˆæœ¬,å¦‚æœæ˜¯10ä»¥ä¸‹çš„ç‰ˆæœ¬è¿˜æ˜¯åŠé€€å§.è¯¥æ’ä»¶ç”¨èµ·æ¥ç›®å‰æ„Ÿè§‰æ¯”ä»¥ä¸Šä¸¤æ¬¾éƒ½è¦çˆ½,ä¸ç”¨ç¼–è¯‘,å®˜æ–¹è‡ªå¸¦,æ²¡æœ‰å†…å­˜è€—å°½çš„é—®é¢˜.</p>

        <p>javaç«¯çš„æ¶ˆè´¹è€…ä»£ç å¯ä»¥å‚è€ƒdebeziumé¡¹ç›®ä¸­çš„connector-postgresql:https://github.com/debezium/debezium</p>
      </li>
    </ol>

    <p>ä»¥ä¸Š3æ¬¾æ’ä»¶,ç¬”è€…éƒ½è¯•è¿‡,æœ€ç»ˆé€‰æ‹©äº†å®˜æ–¹çš„æ–¹æ¡ˆ,ç”¨èµ·æ¥è¿˜æ˜¯æŒºçˆ½çš„.åªä¸è¿‡è¯¥æ¶ˆæ¯æœ‰å•ç‹¬çš„æ ¼å¼,è¦è‡ªå·±å»è§£æ.å…·ä½“æ ¼å¼å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£,http://postgres.cn/docs/11/protocol-logicalrep-message-formats.html.</p>
  </li>
</ul>

<h1 id="ä¸‰java-ç¤ºä¾‹">ä¸‰ã€JAVA ç¤ºä¾‹</h1>

<p>è¦ä½¿ç”¨å®˜æ–¹çš„æ’ä»¶åˆ†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:</p>

<ol>
  <li>
    <p>åˆ›å»ºè®¢é˜…</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">PUBLICATION</span> <span class="n">test</span> <span class="k">FOR</span> <span class="k">TABLE</span> <span class="k">ONLY</span> <span class="nv">"user_info"</span> 
 <span class="k">WITH</span> <span class="p">(</span><span class="n">publish</span> <span class="o">=</span> <span class="s1">'insert,update,delete'</span><span class="p">);</span>
 <span class="c1">-- ä¸ºè¡¨user_infoåˆ›å»ºåç§°ä¸ºtestçš„è®¢é˜…,å‘å¸ƒinsert,update,deleteæ¶ˆæ¯</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åˆ›å»ºå¤åˆ¶æ§½</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CREATE_REPLICATION_SLOT</span> <span class="n">test</span> <span class="k">TEMPORARY</span> <span class="n">LOGICAL</span> <span class="n">pgoutput</span><span class="p">;</span>
<span class="c1">-- åˆ›å»ºåç§°ä¸ºtestçš„å¤åˆ¶æ§½</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Java demo</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 		<span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:postgresql://localhost:5432/test"</span><span class="o">;</span>
    <span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
    <span class="nc">PGProperty</span><span class="o">.</span><span class="na">USER</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">);</span>
    <span class="nc">PGProperty</span><span class="o">.</span><span class="na">PASSWORD</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">"postgres"</span><span class="o">);</span>
    <span class="nc">PGProperty</span><span class="o">.</span><span class="na">ASSUME_MIN_SERVER_VERSION</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">"9.4"</span><span class="o">);</span>
    <span class="nc">PGProperty</span><span class="o">.</span><span class="na">REPLICATION</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">"database"</span><span class="o">);</span>
    <span class="nc">PGProperty</span><span class="o">.</span><span class="na">PREFER_QUERY_MODE</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="s">"simple"</span><span class="o">);</span>
   
    <span class="nc">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>
    <span class="nc">PGConnection</span> <span class="n">replConnection</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">unwrap</span><span class="o">(</span><span class="nc">PGConnection</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   
    <span class="c1">//some changes after create replication slot to demonstrate receive it</span>
    <span class="n">sqlConnection</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="nc">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">sqlConnection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
    <span class="n">st</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"insert into test_logic_table(name) values('first tx changes')"</span><span class="o">);</span>
    <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
   
    <span class="n">st</span> <span class="o">=</span> <span class="n">sqlConnection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
    <span class="n">st</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"update test_logic_table set name = 'second tx change' where pk = 1"</span><span class="o">);</span>
    <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
   
    <span class="n">st</span> <span class="o">=</span> <span class="n">sqlConnection</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
    <span class="n">st</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"delete from test_logic_table where pk = 1"</span><span class="o">);</span>
    <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
   
    <span class="nc">PGReplicationStream</span> <span class="n">stream</span> <span class="o">=</span>
        <span class="n">pgConnection</span><span class="o">.</span><span class="na">getReplicationAPI</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">replicationStream</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">logical</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">withSlotName</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">withSlotOption</span><span class="o">(</span><span class="s">"proto_version"</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">withSlotOption</span><span class="o">(</span><span class="s">"publication_names"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">withStartPosition</span><span class="o">(</span><span class="n">lastLsn</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">withStatusInterval</span><span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">toIntExact</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">10</span><span class="o">).</span><span class="na">toMillis</span><span class="o">()),</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">start</span><span class="o">();</span>
   
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//non blocking receive message</span>
      <span class="nc">ByteBuffer</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="na">readPending</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10L</span><span class="o">);</span>
        <span class="k">continue</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">arrayOffset</span><span class="o">();</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">source</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">array</span><span class="o">();</span>
      <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">offset</span><span class="o">;</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">length</span><span class="o">));</span>
   
      <span class="c1">//feedback</span>
      <span class="n">stream</span><span class="o">.</span><span class="na">setAppliedLSN</span><span class="o">(</span><span class="n">stream</span><span class="o">.</span><span class="na">getLastReceiveLSN</span><span class="o">());</span>
      <span class="n">stream</span><span class="o">.</span><span class="na">setFlushedLSN</span><span class="o">(</span><span class="n">stream</span><span class="o">.</span><span class="na">getLastReceiveLSN</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>å…³äºjavaç¤ºä¾‹ä¸­çš„ç”¨æ³•,å¯ä»¥æŸ¥çœ‹jdbcçš„æ–‡æ¡£:https://jdbc.postgresql.org/documentation/head/replication.html</p>
:ET